<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<script type="text/javascript">var BOOTSTRAP_VERSION ="lumen";
	var BOOTSTRAP_JS_HEAD =1;
	var BOOTSTRAP_CDN_ENABLE =0; var BOOTSTRAP_NAVBAR_TYPE =0; var BOOTSTRAP_LOGO_OPTION =0; var BOOTSTRAP_NAVBAR =1; var BootstrapInputFix =true;var BootstrapNavbarLineHeightFix =true;var BOOTSTRAP_EDT= 0; </script>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>Virus Bulletin :: Case study: the Ibank trojan</title>
<meta name="description" content="Alisa Shevchenko sheds some light on the technology of online banking fraud with an indepth analysis of the Ibank trojan which targets a wide variety of Russian online banking technologies." />
<meta name="generator" content="concrete5 - 5.6.3.5" />
<script type="text/javascript">
var CCM_DISPATCHER_FILENAME = '/index.php';var CCM_CID = 2231;var CCM_EDIT_MODE = false;var CCM_ARRANGE_MODE = false;var CCM_IMAGE_PATH = "/concrete/images";
var CCM_TOOLS_PATH = "/index.php/tools/required";
var CCM_BASE_URL = "https://www.virusbulletin.com";
var CCM_REL = "";

</script>
<link rel="shortcut icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
<link rel="icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
<link rel="stylesheet" type="text/css" href="/concrete/css/ccm.base.css" />
<script type="text/javascript" src="/concrete/js/jquery.js"></script>
<script type="text/javascript" src="/concrete/js/ccm.base.js"></script>
<script type="text/javascript">
var COOKIES_ALLOWED=false;
</script>
<link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure.css" />
<!--[if lte IE 8]><link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure_ie.css" /><![endif]-->
<script type="text/javascript">
var COOKIES_DISCLOSURE_HIDE_INTERVAL=10;
</script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_hide.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap-overwrites.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/members.css" />
<script type="text/javascript" src="/packages/bootstrap/js/common/prettify.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/jquery.easing.1.3.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="/libraries/css/jquery.fancybox.css" />
<script type="text/javascript" src="/libraries/js/jquery.fancybox.pack.js"></script>
<link rel="stylesheet" media="screen" type="text/css" href="/files/cache/css/bootstrap/typography.css" />
<script type="text/javascript" src="/index.php/tools/packages/free_cookies_disclosure/disclosure_i18n_js"></script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_ajax_form.js"></script>
<link rel="stylesheet" type="text/css" href="/concrete/blocks/page_list/view.css" />
<link rel="stylesheet" type="text/css" href="/packages/remo_expand/blocks/remo_expand/templates/vbexpand/view.css" />
<script type="text/javascript" src="/packages/remo_expand/js/jquery.color.js"></script>
<script type="text/javascript" src="/packages/remo_expand/js/jquery.ba-hashchange.js"></script>
<script type="text/javascript" src="/packages/remo_expand/js/remo.expand.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/blocks/search/templates/VB_global_search/view.css" />
<link rel="stylesheet" type="text/css" href="/packages/travisn_spacer/css/ccm.tnspacer.css" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.js" integrity="sha256-1SFdTXlsw0RkQ+iO0E91LDshGiIbPiTYqJto0px4wds=" crossorigin="anonymous"></script>
<!--[if gte IE 9]>
<script src="/packages/bootstrap/js/common/modernizr.js"></script>
<![endif]-->

<!--[if lt IE 9]>	
	
	<script src="/packages/bootstrap/js/common/html5shiv.js"></script>
	<script src="/packages/bootstrap/js/common/respond.min.js"></script>
	
<![endif]-->
</head>
<body data-spy="scroll" data-target=".bs-sidebar">

<div class="navbar  navbar-fixed-top navbar-default  bs-docs-nav">
<div class="navbar-inner">
<div class="container"><div class="row"><div class="col-sm-4 col-md-4 logo-position-1 col-logo">
<div class="navbar-header">
<button type="button" class="navbar-toggle btn_navbar_custom">
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button><div class="mobile-clearfix"></div><div class="navbar-brand navbar-brand-area"><a href="/"><img border="0" class="ccm-image-block" alt="" src="/files/4614/4535/7515/logo-big.png" width="339" height="92" /></a></div> </div>
</div><div class="col-sm-8 col-md-8 logo-position-1 col-nav"> <div class="nav-collapse collapse nav_collapse_custom navbar-collapse"> <div style="clear:both"></div>
<div class="vb-global-search-div">
<form action="/index.php/global-search-results/" method="get">
<fieldset>
<input name="search_paths[]" type="hidden" value="" />
<input name="query" type="text" class="vb-global-search" placeholder="Search site..." />
<input name="submit" type="submit" value="Search!" style="display:none" />
</fieldset>
</form>
</div>
<div class="tnSpacer" style="height:48px"></div>
<ul class="nav nav-pills"><li class=" nav-first nav-item-6299"><a href="/newsletter/" target="_self" class=" nav-first nav-item-6299 ">Newsletter</a></li><li class=" nav-item-260"><a href="/conference/" target="_self" class=" nav-item-260 ">VB Conference</a></li><li class=" nav-item-166"><a href="/testing/" target="_self" class=" nav-item-166 ">VB Testing</a></li><li class=" nav-path-selected active nav-item-160"><a href="/virusbulletin/" target="_self" class=" nav-path-selected active nav-item-160 ">Bulletin</a></li><li class=" nav-last nav-item-130"><a href="/blog/" target="_self" class=" nav-last nav-item-130 ">Blog</a></li></ul> </div>
</div>
</div><div class="clearfix"></div>
</div>
</div>
</div>
<div class="navbar-top-fixed-space "><div class="clearfix"></div></div>

<div class="container m-top-20">
<div class="row">
<div class="col-md-9 col-sm-9 col-lg-9">
<div class="titlepage" xmlns=""><div><div><h1 class="title" xmlns="http://www.w3.org/1999/xhtml"><a id="vb201012-Ibank-trojan"></a>Case study: the Ibank trojan</h1></div><div><p class="pubdate" xmlns="http://www.w3.org/1999/xhtml">2010-12-01</p></div><div><div class="authorgroup" xmlns="http://www.w3.org/1999/xhtml"><div class="author titlepage"><h3 class="author"><span class="firstname">Alisa</span> <span class="surname">Shevchenko</span></h3><span class="orgname">eSage Lab</span>, <span class="orgdiv">Russia</span></div><b class="editedby">Editor: </b><span class="editor"><span class="firstname">Helen</span> <span class="surname">Martin</span></span></div></div><div><div class="abstract" xmlns="http://www.w3.org/1999/xhtml"><p class="title"><b>Abstract</b></p><p>Alisa Shevchenko sheds some light on the technology of online banking fraud with an indepth analysis of the Ibank trojan which targets a wide variety of Russian online banking technologies.</p></div></div><div><p class="copyright" xmlns="http://www.w3.org/1999/xhtml"><i>Copyright &copy; 2010 Virus Bulletin</i></p></div></div><hr /></div>
<div class="ccm-remo-expand">
<div id="ccm-remo-expand-title-3915" class="ccm-remo-expand-title ccm-remo-expand-closed" data-expander-speed="200">Table of contents</div><div id="ccm-remo-expand-content-3915" class="ccm-remo-expand-content"><div class="toc"><dl><dt><span class="sect1"><a href="#id3859686"></a></span></dt><dt><span class="sect1"><a href="#id4014708">Typical online banking fraud schemes</a></span></dt><dd><dl><dt><span class="sect2"><a href="#id3332291">1. Stealing user credentials</a></span></dt><dt><span class="sect2"><a href="#id2647741">2. Attack from inside the victim</a></span></dt><dt><span class="sect2"><a href="#id2928314">3. Automated online banking manipulations</a></span></dt></dl></dd><dt><span class="sect1"><a href="#id3527455">Ibank: the analysis</a></span></dt><dd><dl><dt><span class="sect2"><a href="#id2296377">General information</a></span></dt><dt><span class="sect2"><a href="#id2954712">Installation and general functionality</a></span></dt><dt><span class="sect2"><a href="#id3358978">Spying functionality</a></span></dt><dt><span class="sect2"><a href="#id4309402">Data harvesting mechanism</a></span></dt><dt><span class="sect2"><a href="#id4540258">Target systems</a></span></dt><dt><span class="sect2"><a href="#id4129971">Blocking of anti-virus solutions</a></span></dt><dt><span class="sect2"><a href="#id3106890">Network connectivity</a></span></dt><dt><span class="sect2"><a href="#id4514470">Remote control</a></span></dt><dt><span class="sect2"><a href="#id4035395">Automated online banking manipulations</a></span></dt></dl></dd><dt><span class="sect1"><a href="#id4339652">Conclusions</a></span></dt></dl></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3859686"></a></h2></div></div></div><p>Online banking fraud is one of the most important cyber threats to date. This article aims to shed some light on the technology of online banking fraud by providing a thorough analysis of a prevalent trojan which targets a wide variety of Russian online banking technologies. To the author&rsquo;s knowledge, all the techniques incorporated in this trojan are up to date, and hazardous to all kinds of online banking solutions both in Russia and elsewhere.</p><p>It should be noted that the trojan discussed here is only one part of the puzzle. Namely, the Ibank trojan is only the instrument for harvesting banking credentials and performing automated money transfers on the majority of systems with regular protection. However, to attack systems with stronger protection, an extra set of instruments is used: a custom VNC technology, allowing manual operations to be performed in a stealthy manner, and tools to bypass enhanced security measures such as tokens and one-time passwords. Both of the latter may be plugged into the well-known Zeus trojan &ndash; the attacker&rsquo;s &lsquo;Swiss army knife&rsquo; of choice.</p><p>Before proceeding to the Ibank analysis, let&rsquo;s briefly outline the general approaches to online banking fraud, as we discovered during our investigations.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4014708"></a>Typical online banking fraud schemes</h2></div></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3332291"></a>1. Stealing user credentials</h3></div></div></div><p>The classical scheme for online banking fraud consists of stealing the full pack of user credentials which allows the attacker to control the user&rsquo;s bank account remotely. Depending on the online banking architecture, the credentials may include username and password, or username, password and a key file or a certificate file. If the victim&rsquo;s bank performs client IP address verification, the attacker will establish a proxy on the victim&rsquo;s computer and connect through it to fool the verification system on the server.</p><p>While this scheme works only on the most weakly protected systems, it should by no means be considered outdated.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id2647741"></a>2. Attack from inside the victim</h3></div></div></div><p>This scheme represents a generic approach to attacking online banking systems with enhanced protection (such as irretrievable keys, token-based encryption and so on). Also, this scheme is used to attack lesser-known systems, since it does not require the attacker to have any knowledge of the target system&rsquo;s internals.</p><p>The attack consists of connecting to the victim&rsquo;s computer via a custom VNC protocol, which allows the attacker to establish a visual connection with an alternate desktop, invisible to the user. All the user&rsquo;s data and cookies are shared in the invisible desktop, thus allowing the attacker to piggyback on the existing web session by manually performing all of the necessary operations. If the victim&rsquo;s computer is hidden behind the NAT or otherwise unreachable from the Internet, the supporting trojan can establish a back-connection to the attacker.</p><p>The Zeus trojan is often used as a platform for this attack scheme, using the appropriate connection plug-in which is available for extra payment. One of the reasons Zeus is popular with fraudsters is that it supports a rich choice of advanced plug-ins, allowing tokens and one-time passwords to be bypassed, and advanced automated transactions to be performed.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id2928314"></a>3. Automated online banking manipulations</h3></div></div></div><p>Automated online banking manipulations, the so-called &lsquo;avtozaliv&rsquo; in Russian cybercriminal slang, allow online banking transactions to be automated by means of modification of the web traffic. In general, this works with any web-based banking solution, as well as with Win32-based solutions implemented in a thin client.</p><p>The attack consists of manipulating the online banking application at the website level. The rules for such a manipulation may be hard-coded in the trojan or set in the trojan&rsquo;s configuration file. Once the set of rules for a particular banking application has been established, the attacker does not need to control the infected victims, but only to collect the automated money transfers from them.</p><p>There are two types of &lsquo;avtozaliv&rsquo; technologies: passive and active. The passive technology consists of the replacement of certain HTML form values or GET/POST requests, such as the destination account number, or the amount of money to be transferred. As such, the passive technology allows attackers to substitute a legitimate transaction initiated by the user with a malicious one. The active technology is more self-contained, enabling all the manipulations that are necessary to perform the transfer, including filling in forms or clicking buttons. In such cases, a malicious transaction can be generated from scratch inside the user&rsquo;s computer.</p><p>It should be noted that implementing such automated technology is not really complex, but rather tedious. Such a technology must be custom-tailored for each separate online banking application, and requires deep study of the application&rsquo;s HTML structure.</p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3527455"></a>Ibank: the analysis</h2></div></div></div><p>Ibank is a widespread trojan, targeted at a number of Russian online banking systems. The targeted systems include:</p><div class="itemizedlist"><ul type="disc"><li><p>Universal e-commerce platforms, widely deployed by Russian banks to provide online banking functionality;</p></li><li><p>The custom online banking solutions of specific banks (web-based as well as standalone applications);</p></li><li><p>The <span class="emphasis"><em>WebMoney</em></span> system (the Russian equivalent of <span class="emphasis"><em>PayPal</em></span>);</p></li><li><p>A number of government-licensed cryptography solutions, which provide generic encryption and key management support to e-commerce platforms.</p></li></ul></div><p>Ibank is worthy of a detailed analysis for the following reasons:</p><div class="itemizedlist"><ul type="disc"><li><p>It is the number one banking trojan, based on the number of target systems;</p></li><li><p>It is the first trojan targeted at Russian banks, and the only all-purpose one;</p></li><li><p>Ibank is widespread, and is actively being propagated. According to the <span class="emphasis"><em>Kaspersky Virus Watch</em></span> service, the lab adds from five to 20 signatures daily for this trojan.</p></li></ul></div><p>What is even more important about the Ibank trojan is that it has been seen widely employed in targeted financial attacks along with the Zeus trojan. Specifically, the Ibank trojan is used to dump access credentials for the target systems discovered on an infected victim, while the Zeus trojan represents a volatile all-purpose tool to provide general data harvesting and remote control functionality on the victim.</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id2296377"></a>General information</h3></div></div></div><p>The Ibank trojan was discovered in 2006. Initially, it was seen implemented as a simple instrument to deliver mass attacks on users of online banking systems. However, the trojan quickly evolved to support organized crime, and it started to be seen in targeted attacks a couple of years later. The massive propagation of the Ibank trojan was first noted in 2010 by <span class="emphasis"><em>Dr. Web</em></span>.</p><p>Anti-virus vendors assign the following names to this trojan: Trojan.PWS.Ibank, Backdoor.Win32.Shiz, Trojan-Spy.Win32.Shiz, Backdoor.Rohimafo and others. Interestingly, no anti-virus vendor has provided comprehensive Ibank coverage focusing on its online banking fraud functionality &ndash; which is a clear sign that vendors currently underestimate the importance of protection for online banking fraud.</p><p>The trojan consists of two pieces: a small loader, and a main working module, which is retrieved by the loader. The loader is propagated via a classic affiliate marketing scheme. Namely, the initial HTTP request sent to the malicious server upon successful trojan installation contains the seller ID:</p><pre class="programlisting">http://servername/knock.php?n=botID&amp;s=seller-N</pre><p>The trojan dropper is a ~100KB encrypted file (MD5: 53aec556c00f34182a72ba8edfb8fca9), written in C. Ibank runs completely in user mode, and is rather simple from a technical point of view. However, some of its features betray the author&rsquo;s deep knowledge of online banking systems.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id2954712"></a>Installation and general functionality</h3></div></div></div><p>During installation, the trojan executable is dropped into the system directory (c:\windows\system32) under a random name. At the same point, a number of IP addresses are blocked by the trojan by calling the route command to configure an illegal gateway for each listed IP address. The list of blocked IP addresses is initially hard-coded in the trojan&rsquo;s code, and refers to a seemingly random list of targets.</p><p>The trojan&rsquo;s startup at boot time is enabled by modification of the following registry key: HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit.</p><p>When executed, instead of running its own process the trojan parasitizes a system service, such as svchost.exe, services.exe or others (the service depends on the trojan&rsquo;s version). Apart from providing general stealthiness, this approach allows the trojan to bypass firewall protection due to the default whitelisting of its donor process. However, the trojan does not try to hide other evidence of its presence in the system, such as the files and the opened port.</p><p>Apart from its core spying functionality, Ibank has the following features:</p><div class="itemizedlist"><ul type="disc"><li><p>A simple backdoor is available, allowing the infected computer to be controlled through a short list of commands.</p></li><li><p>A powerful mechanism is available to filter or modify web traffic. This can be used to automate financial transactions via the web, as well as to mask the modified bank account summary.</p></li><li><p>The victim&rsquo;s routing table can be reconfigured at the attacker&rsquo;s command. This may be used to channel traffic for specific websites through malicious gates.</p></li><li><p>The trojan runs a SOCKS proxy on a random port, which may be used to bypass client IP address checks during authentication with stolen credentials.</p></li><li><p>A number of anti-virus programs are blocked: <span class="emphasis"><em>Kaspersky</em></span>, <span class="emphasis"><em>Avira</em></span>, <span class="emphasis"><em>AVG</em></span> and <span class="emphasis"><em>CA HIPS</em></span>.</p></li></ul></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3358978"></a>Spying functionality</h3></div></div></div><p>Immediately following installation, the trojan hooks a number of APIs in order to trap the target application&rsquo;s data. As soon as a target application signature passes through the hook, the grabber procedure is initiated to collect all the available data related to that application, such as specific key files, certificates, logins and passwords, or simply all of the keyboard input. The data is immediately archived and sent out to the malicious server whose address is hard-coded in the trojan&rsquo;s code.</p><p>In general, Ibank performs the following types of grabbing activities:</p><div class="itemizedlist"><ul type="disc"><li><p>Intercepting keystrokes in the context of browsers, specific processes, specific windows and edit boxes;</p></li><li><p>Intercepting web traffic from browsers to grab HTTPS plaintext;</p></li><li><p>Copying key files and certificates;</p></li><li><p>Exporting certificates from browsers, optionally using storage password brute-forcing;</p></li><li><p>Matching HTTP requests by a pattern to extract important data, such as login, password and session ID;</p></li><li><p>Harvesting the browsing history;</p></li><li><p>Retrieving deleted and restored files (.chk).</p></li></ul></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id4309402"></a>Data harvesting mechanism</h3></div></div></div><p>In order to locate and grab the user&rsquo;s online banking data, the trojan installs a number of API hooks, as shown in <a href="#table.1">Table 1</a>.</p><div class="table"><a id="table.1"></a><table border="1" summary="In order to locate and grab the user&rsquo;s online banking data, the
        trojan installs a number of API hooks."><colgroup><col align="center" /><col /></colgroup><tbody><tr><td align="center"><span class="bold"><strong>Hooked API</strong></span></td><td align="center"><span class="bold"><strong>Purpose</strong></span></td></tr><tr><td align="center">CryptEncrypt</td><td>Grabbing plaintext prior to standard encryption.</td></tr><tr><td align="center">send, WSASend</td><td>Grabbing login/password data from HTTP requests.</td></tr><tr><td align="center">CreateFile</td><td>Trapping user activity related to the following files: self.cer, secrets.key and others.</td></tr><tr><td align="center">GetFileAttributes</td><td>Looking for the file signature &lsquo;iBKS&rsquo; (which is the signature of a specific online banking software key file).</td></tr><tr><td align="center">vb_pfx_import(sks2xyz.dll)</td><td>Grabbing the files prv_key.pfx and sign.cer.</td></tr><tr><td align="center">RCN_R50Buffer(FilialRCon.dll)</td><td>Grabbing plaintext prior to custom encryption (product-specific).</td></tr><tr><td align="center">GetWindowText</td><td>Getting the edit box value in the window named &lsquo;User registration&rsquo;.</td></tr><tr><td align="center">TranslateMessage</td><td>Intercepting of keyboard keys in the context of the following modules: cbsmain.dll, intpro.exe, isclient.exe, java.exe and others.</td></tr><tr><td align="center">PR_Write(nspr4.dll)</td><td>Intercepting HTTPS traffic in the Mozilla browser.</td></tr><tr><td align="center">&lt;API exported by the ordinal&gt; (opera.dll)</td><td>Intercepting HTTPS traffic in the Opera browser.</td></tr><tr><td align="center">Send, WSASend</td><td>Saving the POST request data: name, pass, login, password.</td></tr><tr><td align="center">HttpSendRequest*</td><td>Saving the HTTP request data matched by the following pattern: action=auth&amp;np=&amp;PHPSESSID=,IW_FormName=fmLogin&amp;IW_FormClass=TfmLog,CryptoPluginId=AGAVA&amp;Sign=.</td></tr></tbody></table><p class="title"><b>Table&nbsp;1.&nbsp;In order to locate and grab the user&rsquo;s online banking data, the trojan installs a number of API hooks.</b></p></div><p>The hooking procedures for the listed hooks provide filtering and harvesting of data, which is sent to the malicious server.</p><p>Note that some of the hooked functions represent custom software APIs (undocumented) rather than <em class="productname">Windows</em> APIs:</p><div class="itemizedlist"><ul type="disc"><li><p>Vb_pfx_import is exported from the sks2xyz.dll module, which is part of the <span class="emphasis"><em>Factura</em></span> e-commerce solution deployed widely at various Russian banks including <span class="emphasis"><em>Sberbank</em></span>;</p></li><li><p>The RCN_R50Buffer function is exported from the FilialRCon.dll, which is the part of the custom online banking solution deployed at <span class="emphasis"><em>Raiffeisen Bank</em></span>.</p></li></ul></div><p>Similarly, the undocumented browser functions are hooked to intercept SSL plaintext: namely, the PR_Write function of <span class="emphasis"><em>Mozilla</em></span> and the unnamed function of <em class="productname">Opera</em>.</p><p>Another point to mention is the trojan&rsquo;s ability to intercept data from Java applications via the TranslateMessage hook.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id4540258"></a>Target systems</h3></div></div></div><p>A standalone directory is created for each target system located on the victim. All the stolen data is dumped into this directory (<a href="#table.2">Table 2</a>).</p><div class="table"><a id="table.2"></a><table border="1" summary="A standalone directory is created for each target system
        located on the victim."><colgroup><col align="center" /><col /></colgroup><tbody><tr><td align="center"><span class="bold"><strong>Data directory</strong></span></td><td align="center"><span class="bold"><strong>Target applications</strong></span></td></tr><tr><td align="center">C:\Program Files\Common Files\bssrepp</td><td><span class="emphasis"><em>BS-Client</em></span>, an e-commerce platform from www.bssys.com</td></tr><tr><td align="center">C:\Program Files\Common Files\ibank</td><td><span class="emphasis"><em>iBank</em></span>, an e-commerce platform from www.bifit.com</td></tr><tr><td align="center">C:\Program Files\Common Files\faktura</td><td><span class="emphasis"><em>Faktura</em></span>, an e-commerce platform from www.faktura.ru</td></tr><tr><td align="center">C:\Program Files\Common Files\inist</td><td><span class="emphasis"><em>Inist</em></span>, an e-commerce platform from www.inist.ru</td></tr><tr><td align="center">C:\Program Files\Common Files\wm</td><td><span class="emphasis"><em>WebMoney</em></span>, a web-based payment system</td></tr><tr><td align="center">C:\Program Files\Common Files\handy</td><td><span class="emphasis"><em>HandyBank</em></span>, a custom web-based online banking application from www.handybank.ru</td></tr><tr><td align="center">C:\Program Files\Common Files\rfk</td><td><span class="emphasis"><em>RFK</em></span>, an e-commerce platform from www.rfc.ru</td></tr><tr><td align="center">C:\Program Files\Common Files\sbl</td><td>Undefined, a custom web-based online banking application</td></tr><tr><td align="center">C:\Program Files\Common Files\agv</td><td><span class="emphasis"><em>Agava</em></span>, a cryptography framework, and InterBank, an e-commerce platform from www.alpha.ru</td></tr><tr><td align="center">C:\Program Files\Common Files\inter</td><td><span class="emphasis"><em>Inter-PRO</em></span>, an e-commerce platform from www.signal-com.ru</td></tr><tr><td align="center">C:\Program Files\Common Files\kbp</td><td>Unknown custom online banking application</td></tr><tr><td align="center">C:\Program Files\Common Files\raif</td><td><span class="emphasis"><em>Raiffeisen Bank</em></span> custom e-banking application, www.raiffeisen.ru</td></tr></tbody></table><p class="title"><b>Table&nbsp;2.&nbsp;A standalone directory is created for each target system located on the victim.</b></p></div><p>All the major e-commerce systems on the Russian market are listed in <a href="#table.2">Table 2</a>. These are deployed by the majority of banks. Thus, it is clear that the Ibank trojan can be used to steal user credentials from almost any Russian bank.</p><p>In some cases the credentials are extracted from the underlying cryptographic provider, such as <span class="emphasis"><em>Agava</em></span> software, rather than from the online banking solution.</p><p>The harvested data is saved into the appropriate files and archives before being sent to the malicious server: pass.log, keylog.txt, ctunnel.zip, keys.zip, links.log.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id4129971"></a>Blocking of anti-virus solutions</h3></div></div></div><p><em class="productname">Kaspersky Anti-Virus</em> is blocked by sending a legitimate control message to the application window:</p><pre class="programlisting">FindWindow (&ldquo;____AVP.Root&rdquo;);
PostMessage (^, 466h);</pre><p>The blocking of <em class="productname">Avira</em> is provided by calling its own legitimate function, which is exported from one of the product DLLs:</p><pre class="programlisting">RegQueryValue (&ldquo;SOFTWARE\\Avira\\AntiVir PersonalEdition Classic&rdquo;, &ldquo;Path&rdquo;);
LoadLibrary (&ldquo;avipc.dll&rdquo;);
GetProcAddress (&ldquo;AvIpcCall&rdquo;);
GetProcAddress (&ldquo;AvIpcConnect&rdquo;);
AvIpcConnect (&ldquo;avguard01&rdquo;, 1388h); 
AvIpcCall (...); // turn off Avira</pre><p><em class="productname">AVG</em> is killed by the simple closing of the application process and dumping trash to the product&rsquo;s driver file:</p><pre class="programlisting">CreateFile (&ldquo;%systemroot%\\system32\\drivers\\avgtdix.sys&rdquo;);
WriteFile (^, VirtualAlloc (GetFileSize (^)));
OpenProcess (&ldquo;avgtray.exe&rdquo;);
TerminateProcess (^);</pre><p>Finally, <em class="productname">CA HIPS</em> is turned off by sending a legitimate control code to the product&rsquo;s driver:</p><pre class="programlisting">CreateFile (&ldquo;\\.\KmxAgent&rdquo;);
DeviceIOControl (86000054h);</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3106890"></a>Network connectivity</h3></div></div></div><p>The trojan performs the following network-related activities:</p><div class="itemizedlist"><ul type="disc"><li><p>Immediately following installation, a SOCKS server is started on a random port.</p></li><li><p>Next, the trojan informs the malicious server of the victim&rsquo;s summary: username, computer name, SOCKS port number.</p></li><li><p>The configuration file is then received from the server.</p></li><li><p>After the data is harvested, it is sent to the gate.php script at the malicious server via a POST request.</p></li><li><p>Upon receiving the command, the trojan may download and run a custom executable.</p></li></ul></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id4514470"></a>Remote control</h3></div></div></div><p>The infected computer is controlled by commands contained in the configuration file. <a href="#table.3">Table 3</a> shows the commands that are available.</p><div class="table"><a id="table.3"></a><table border="1" summary="The available commands in the configuration file."><colgroup><col align="center" /><col /></colgroup><tbody><tr><td align="center"><span class="bold"><strong>Command</strong></span></td><td align="center"><span class="bold"><strong>Objective</strong></span></td></tr><tr><td align="center">!load</td><td>Load and run an executable from the given URL</td></tr><tr><td align="center">!route</td><td>Configure the routing table</td></tr><tr><td align="center">!inject</td><td>Traffic injections configuration</td></tr><tr><td align="center">!kill_os</td><td>Killing of the infected system by writing trash to the disk&rsquo;s first sectors and deleting of important system files</td></tr></tbody></table><p class="title"><b>Table&nbsp;3.&nbsp;The available commands in the configuration file.</b></p></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id4035395"></a>Automated online banking manipulations</h3></div></div></div><p>In Ibank&rsquo;s case, the &lsquo;avtozaliv&rsquo; technology consists of manipulating the HTML code of the banks&rsquo; websites according to a set of rules defined in the configuration file. The configuration file contains a set of variables which define the location and the replacement data for the piece of HTML code to be modified.</p><div class="table"><a id="table.4"></a><table border="1" summary="The name and purpose of each variable."><colgroup><col align="center" /><col /></colgroup><tbody><tr><td align="center"><span class="bold"><strong>Variable</strong></span></td><td align="center"><span class="bold"><strong>Purpose</strong></span></td></tr><tr><td align="center">set_url</td><td>Target URL to apply the HTML modification</td></tr><tr><td align="center">data_before</td><td>HTML mark (pattern) of the beginning of the code segment to be modified</td></tr><tr><td align="center">data_after</td><td>HTML mark (pattern) of the tail of the code segment to be modified</td></tr><tr><td align="center">data_inject</td><td>The replacement code</td></tr></tbody></table><p class="title"><b>Table&nbsp;4.&nbsp;The name and purpose of each variable.</b></p></div><p>In addition, the following options are supported:</p><div class="itemizedlist"><ul type="disc"><li><p>G or P &ndash; to modify the behaviour of the set_url variable to process GET or POST requests, respectively;</p></li><li><p>L &ndash; to dump the matched HTML code to a log file instead of performing the replacement;</p></li><li><p>D &ndash; to set replacement periodicity.</p></li></ul></div><p>After receiving and parsing the configuration data, the trojan saves it in the HKEY_LOCAL_MACHINE\Software\Microsoft\option_9 registry key.</p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4339652"></a>Conclusions</h2></div></div></div><p>Malware-based online banking fraud techniques are currently well developed, and the tools are readily available on the black market. Existing technologies allow automated or semi-automated fraud to be performed on an infected client, which allows massive attacks to be performed.</p><p>A deep understanding of online banking system internals is not required to perform targeted attacks, and many of the current security measures can successfully be bypassed by attackers&rsquo; tools.</p><p>Any online banking solution is vulnerable to current attack technologies, as long as it runs on an insecure operating system.</p></div> </div>
<div class="col-md-3 col-sm-3 col-lg-3">
<div id="NDPHPBlock13359" class="NDPHPBlock">
<div style="width: 100%;"><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Tweet this!' href="https://twitter.com/share?text=Case study: the Ibank trojan&url=https://www.virusbulletin.com/virusbulletin/2010/12/case-study-ibank-trojan"><img src='/uploads/images/buttons/twitter.png' alt='twitter.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on Facebook' href='https://www.facebook.com/sharer.php?u=https://www.virusbulletin.com/virusbulletin/2010/12/case-study-ibank-trojan'><img src='/uploads/images/buttons/fb.png' alt='fb.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on LinkedIn' href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.virusbulletin.com/virusbulletin/2010/12/case-study-ibank-trojan&title=Case study: the Ibank trojan"><img src='/uploads/images/buttons/linkedin.png' alt='linkedin.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on Hacker News' href="https://news.ycombinator.com/submitlink?u=https://www.virusbulletin.com/virusbulletin/2010/12/case-study-ibank-trojan&t=Case study: the Ibank trojan"><img src='/uploads/images/buttons/hackernews.png' alt='hackernews.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='reddit this!' href="https://www.reddit.com/submit?url=https://www.virusbulletin.com/virusbulletin/2010/12/case-study-ibank-trojan"><img src='/uploads/images/buttons/reddit.png' alt='reddit.png' width='45' height='45' class='responsive' /></a></center></div></div></div><p> </p>
<h2>Latest articles:</h2>
<div class="ccm-page-list">
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2022/04/cryptojacking-fly-teamtnt-using-nvidia-drivers-mine-cryptocurrency/" target="_self">Cryptojacking on the fly: TeamTNT using NVIDIA drivers to mine cryptocurrency</a>
</h3>
<div class="ccm-page-list-description">
TeamTNT is known for attacking insecure and vulnerable Kubernetes deployments in order to infiltrate organizations&rsquo; dedicated environments and transform them into attack launchpads. In this article Aditya Sood presents a new module introduced by&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/12/collector-stealer-russian-origin-credential-and-information-extractor/" target="_self">Collector-stealer: a Russian origin credential and information extractor</a>
</h3>
<div class="ccm-page-list-description">
Collector-stealer, a piece of malware of Russian origin, is heavily used on the Internet to exfiltrate sensitive data from end-user systems and store it in its C&amp;C panels. In this article, researchers Aditya K Sood and Rohit Chaturvedi present a 360&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/06/fighting-fire-fire/" target="_self">Fighting Fire with Fire</a>
</h3>
<div class="ccm-page-list-description">
In 1989, Joe Wells encountered his first virus: Jerusalem. He disassembled the virus, and from that moment onward, was intrigued by the properties of these small pieces of self-replicating code. Joe Wells was an expert on computer viruses, was partly&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/04/run-your-malicious-vba-macros-anywhere/" target="_self">Run your malicious VBA macros anywhere!</a>
</h3>
<div class="ccm-page-list-description">
Kurt Natvig wanted to understand whether it&rsquo;s possible to recompile VBA macros to another language, which could then easily be &lsquo;run&rsquo; on any gateway, thus revealing a sample&rsquo;s true nature in a safe manner. In this article he explains how he recompiled&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/04/dissecting-design-and-vulnerabilities-azorultccpanels/" target="_self">Dissecting the design and vulnerabilities in AZORult&nbsp;C&amp;C&nbsp;panels</a>
</h3>
<div class="ccm-page-list-description">
Aditya K Sood looks at the command-and-control (C&amp;C) design of the AZORult malware, discussing his team's findings related to the C&amp;C design and some security issues they identified during the research. </div>
</div>
<p><br /><a class="btn btn-block btn-warning" href="/virusbulletin/archive">Bulletin Archive</a></p> </div>
</div>
</div>

<footer class="bs-footer" role="contentinfo">
<div class="container">
<div class="bs-social">
<div class="row ">
<div class="col-md-3">
<p><a title="About Us" href="/about-vb/about-us/">About us</a></p>
<p><a title="Contact Us" href="/about-vb/contact-us/">Contact us</a></p>
<p><a title="Advisory Board" href="/about-vb/advisory-board/">Advisory board</a></p>
<p><a title="Press" href="/about-vb/press/">Press information</a></p>
<p><a title="Security Events Calendar" href="/resources/calendar/">Security events calendar</a></p>
<p><a title="Newsletter" href="/newsletter/">Virus Bulletin newsletter</a></p> </div>
<div class="col-md-3">
<p><a title="VB Testing" href="/testing/">Testing</a></p>
<p><a title="VB100" href="/testing/vb1001/">VB100</a></p>
<p><a title="VBSpam" href="/testing/vbspam/">VBSpam</a></p>
<p><a title="VBWeb" href="/testing/vbweb/">VBWeb</a></p>
<p><a title="Consultancy Services" href="/testing/consultancy-services/">Consultancy services</a></p>
<p><a title="The Spammers' Compendium" href="/resources/spammerscompendium/">Spammers' Compendium</a></p> </div>
<div class="col-md-3">
<p><a title="VB2021 localhost" href="/conference/vb2021/">VB2021 localhost</a></p>
<p><a title="VB2020 localhost" href="/conference/vb2020/">VB2020 localhost</a></p>
<p><a title="VB2019" href="/conference/vb2019/">VB2019 (London)</a></p>
<p><a title="VB2018" href="/conference/vb2018">VB2018 (Montreal)</a></p>
<p><a title="VB2017" href="/conference/vb2017">VB2017 (Madrid)</a></p>
<p><a title="Conference Archive" href="/conference/vb-conference-archive/">Older conferences</a></p> </div>
<div class="col-md-3">
<div class="row">
<table style="float: right;" border="0">
<tbody>
<tr>
<td align="center"><a href="/rss" target="_blank"><img title="Get our blog updates" src="/uploads/images/buttons/rss-square-gray.png" alt="rss.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://twitter.com/virusbtn" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on Twitter" src="/uploads/images/buttons/twitter-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.linkedin.com/company/virus-bulletin" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on LinkedIn" src="/uploads/images/buttons/linkedin-square-gray.png" alt="linkedin.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.facebook.com/virusbulletin" target="_blank"><img title="Visit us on Facebook" src="/uploads/images/buttons/fb-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.youtube.com/user/virusbtn" target="_blank"><img title="Visit us on Youtube" src="/uploads/images/buttons/youtube-square-gray.png" alt="youtube.png" width="35" height="35" /></a></td>
</tr>
</tbody>
</table>
</div> </div>
</div>
<div class="row ">
<div class="col-md-12">
</div>
</div>
</div>
</div>
</footer>

<footer class="bs-footer2" role="contentinfo">
<div class="container">
<div class="bs-social2">
<div class="row ">
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
</div>
<div class="row ">
<div class="col-md-12">
<p style="text-align: left;">©1989-2022 Virus Bulletin.        <a title="Privacy Policy" href="/about-vb/privacy-policy/">Privacy policy</a>        <a title="Cookies" href="/about-vb/privacy-policy/cookies/">Cookies</a>        <a title="Terms and Conditions" href="/about-vb/terms-and-conditions/">Terms and Conditions</a></p> </div>
</div>
</div>
</div>
</footer>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-21876594-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-21876594-2', { 'anonymize_ip': true });
</script><script type="text/javascript" src="/libraries/js/fancybox.load.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/app.js"></script>
<div id="ccm-cookiesDisclosure" class="disclosure-bottom">
<div class="disclosure-container">
<div class="disclosure-content">
<p> We have placed cookies on your device in order to improve the functionality of this site, as outlined in our <a href="/about-vb/privacy-policy/cookies" target="_blank">cookies policy</a>. However, you may delete and block all cookies from this site and your use of the site will be unaffected. By continuing to browse this site, you are agreeing to Virus Bulletin's use of data as outlined in our <a href="/about-vb/privacy-policy/" target="_blank">privacy policy</a>.</p>
</div>
<div class="disclosure-form">
<form action="/index.php/cookies_disclosure/" method="POST">
<input type="hidden" name="allowCookies" value="1" />
<div class="button">
<input class="btn btn-info btn-sm" type="submit" name="submit" value="I understand. Don't show this message again!" />
</div>
</form>
</div>
<div class="ccm-spacer">&nbsp;</div>
</div>
</div>
</body>
</html>