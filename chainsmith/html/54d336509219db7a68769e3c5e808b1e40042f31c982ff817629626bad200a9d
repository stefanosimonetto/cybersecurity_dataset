<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<script type="text/javascript">var BOOTSTRAP_VERSION ="lumen";
	var BOOTSTRAP_JS_HEAD =1;
	var BOOTSTRAP_CDN_ENABLE =0; var BOOTSTRAP_NAVBAR_TYPE =0; var BOOTSTRAP_LOGO_OPTION =0; var BOOTSTRAP_NAVBAR =1; var BootstrapInputFix =true;var BootstrapNavbarLineHeightFix =true;var BOOTSTRAP_EDT= 0; </script>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>Virus Bulletin :: Inside the iOS/AdThief malware</title>
<meta name="description" content="The discovery of new iOS malware is generally pretty hot news for an anti-virus analyst. In March 2014, Claud Xiao discovered iOS/AdThief, a piece of malware which hijacks advertisement revenues and redirects them to the attacker. Axelle Apvrille describes the malware in detail, as well as disclosing a few new findings." />
<meta name="generator" content="concrete5 - 5.6.3.5" />
<script type="text/javascript">
var CCM_DISPATCHER_FILENAME = '/index.php';var CCM_CID = 1725;var CCM_EDIT_MODE = false;var CCM_ARRANGE_MODE = false;var CCM_IMAGE_PATH = "/concrete/images";
var CCM_TOOLS_PATH = "/index.php/tools/required";
var CCM_BASE_URL = "https://www.virusbulletin.com";
var CCM_REL = "";

</script>
<link rel="shortcut icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
<link rel="icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
<link rel="stylesheet" type="text/css" href="/concrete/css/ccm.base.css" />
<script type="text/javascript" src="/concrete/js/jquery.js"></script>
<script type="text/javascript" src="/concrete/js/ccm.base.js"></script>
<script type="text/javascript">
var COOKIES_ALLOWED=false;
</script>
<link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure.css" />
<!--[if lte IE 8]><link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure_ie.css" /><![endif]-->
<script type="text/javascript">
var COOKIES_DISCLOSURE_HIDE_INTERVAL=10;
</script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_hide.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap-overwrites.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/members.css" />
<script type="text/javascript" src="/packages/bootstrap/js/common/prettify.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/jquery.easing.1.3.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="/libraries/css/jquery.fancybox.css" />
<script type="text/javascript" src="/libraries/js/jquery.fancybox.pack.js"></script>
<link rel="stylesheet" media="screen" type="text/css" href="/files/cache/css/bootstrap/typography.css" />
<script type="text/javascript" src="/index.php/tools/packages/free_cookies_disclosure/disclosure_i18n_js"></script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_ajax_form.js"></script>
<link rel="stylesheet" type="text/css" href="/concrete/blocks/page_list/view.css" />
<link rel="stylesheet" type="text/css" href="/packages/remo_expand/blocks/remo_expand/templates/vbexpand/view.css" />
<script type="text/javascript" src="/packages/remo_expand/js/jquery.color.js"></script>
<script type="text/javascript" src="/packages/remo_expand/js/jquery.ba-hashchange.js"></script>
<script type="text/javascript" src="/packages/remo_expand/js/remo.expand.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/blocks/search/templates/VB_global_search/view.css" />
<link rel="stylesheet" type="text/css" href="/packages/travisn_spacer/css/ccm.tnspacer.css" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.js" integrity="sha256-1SFdTXlsw0RkQ+iO0E91LDshGiIbPiTYqJto0px4wds=" crossorigin="anonymous"></script>
<!--[if gte IE 9]>
<script src="/packages/bootstrap/js/common/modernizr.js"></script>
<![endif]-->

<!--[if lt IE 9]>	
	
	<script src="/packages/bootstrap/js/common/html5shiv.js"></script>
	<script src="/packages/bootstrap/js/common/respond.min.js"></script>
	
<![endif]-->
</head>
<body data-spy="scroll" data-target=".bs-sidebar">

<div class="navbar  navbar-fixed-top navbar-default  bs-docs-nav">
<div class="navbar-inner">
<div class="container"><div class="row"><div class="col-sm-4 col-md-4 logo-position-1 col-logo">
<div class="navbar-header">
<button type="button" class="navbar-toggle btn_navbar_custom">
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button><div class="mobile-clearfix"></div><div class="navbar-brand navbar-brand-area"><a href="/"><img border="0" class="ccm-image-block" alt="" src="/files/4614/4535/7515/logo-big.png" width="339" height="92" /></a></div> </div>
</div><div class="col-sm-8 col-md-8 logo-position-1 col-nav"> <div class="nav-collapse collapse nav_collapse_custom navbar-collapse"> <div style="clear:both"></div>
<div class="vb-global-search-div">
<form action="/index.php/global-search-results/" method="get">
<fieldset>
<input name="search_paths[]" type="hidden" value="" />
<input name="query" type="text" class="vb-global-search" placeholder="Search site..." />
<input name="submit" type="submit" value="Search!" style="display:none" />
</fieldset>
</form>
</div>
<div class="tnSpacer" style="height:48px"></div>
<ul class="nav nav-pills"><li class=" nav-first nav-item-6299"><a href="/newsletter/" target="_self" class=" nav-first nav-item-6299 ">Newsletter</a></li><li class=" nav-item-260"><a href="/conference/" target="_self" class=" nav-item-260 ">VB Conference</a></li><li class=" nav-item-166"><a href="/testing/" target="_self" class=" nav-item-166 ">VB Testing</a></li><li class=" nav-path-selected active nav-item-160"><a href="/virusbulletin/" target="_self" class=" nav-path-selected active nav-item-160 ">Bulletin</a></li><li class=" nav-last nav-item-130"><a href="/blog/" target="_self" class=" nav-last nav-item-130 ">Blog</a></li></ul> </div>
</div>
</div><div class="clearfix"></div>
</div>
</div>
</div>
<div class="navbar-top-fixed-space "><div class="clearfix"></div></div>

<div class="container m-top-20">
<div class="row">
<div class="col-md-9 col-sm-9 col-lg-9">
<div class="titlepage" xmlns=""><div><div><h1 class="title" xmlns="http://www.w3.org/1999/xhtml"><a id="vb201407-AdThief"></a>Inside the iOS/AdThief malware</h1></div><div><p class="pubdate" xmlns="http://www.w3.org/1999/xhtml">2014-07-02</p></div><div><div class="authorgroup" xmlns="http://www.w3.org/1999/xhtml"><div class="author titlepage"><h3 class="author"><span class="firstname">Axelle</span> <span class="surname">Apvrille</span></h3><span class="orgname">Fortinet</span>, <span class="orgdiv">France</span></div><b class="editedby">Editor: </b><span class="editor"><span class="firstname">Martijn</span> <span class="surname">Grooten</span></span></div></div><div><div class="abstract" xmlns="http://www.w3.org/1999/xhtml"><p class="title"><b>Abstract</b></p><p>The discovery of new iOS malware is generally pretty hot news for an anti-virus analyst. In March 2014, Claud Xiao discovered iOS/AdThief, a piece of malware which hijacks advertisement revenues and redirects them to the attacker. Axelle Apvrille describes the malware in detail, as well as disclosing a few new findings.</p></div></div><div><p class="copyright" xmlns="http://www.w3.org/1999/xhtml"><i>Copyright &copy; 2014 Virus Bulletin</i></p></div></div><hr /></div>
<div class="ccm-remo-expand">
<div id="ccm-remo-expand-title-2633" class="ccm-remo-expand-title ccm-remo-expand-closed" data-expander-speed="200">Table of contents</div><div id="ccm-remo-expand-content-2633" class="ccm-remo-expand-content"><div class="toc"><dl><dt><span class="sect1"><a href="#id3894690"></a></span></dt><dt><span class="sect1"><a href="#id4883953">The malware&#39;s goal</a></span></dt><dt><span class="sect1"><a href="#id3193318">Targeted adkits</a></span></dt><dt><span class="sect1"><a href="#id4540256">Malware intelligence</a></span></dt><dt><span class="sect1"><a href="#id3128213">Implementation</a></span></dt><dd><dl><dt><span class="sect2"><a href="#id2870329">Overview</a></span></dt><dt><span class="sect2"><a href="#id2615985">Registering a hook</a></span></dt><dt><span class="sect2"><a href="#id4461532">Implementing a hook</a></span></dt><dt><span class="sect2"><a href="#id4693710">Consolidated data</a></span></dt></dl></dd><dt><span class="sect1"><a href="#id4514469">Conclusion</a></span></dt><dt><span class="sect1"><a href="#id3299111">Acknowledgements</a></span></dt></dl></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3894690"></a></h2></div></div></div><p>Surprisingly (or maybe not), <span class="emphasis"><em>iOS</em></span> malware isn&rsquo;t very common. At the end of 2013, there were only four different families (Ikee, FindCall, Toires and Trapsms) as well as a dozen families of adware or spyware [<span class="citation"><a href="#citation.1">1</a></span>]. Ikee and Trapsms require jailbroken devices, whereas FindCall and Toires work on any device.</p><p>Thus, the discovery of new <span class="emphasis"><em>iOS</em></span> malware is generally pretty hot news for an anti-virus analyst. In March 2014, Claud Xiao discovered iOS/AdThief, a.k.a. Spad, a piece of malware which hijacks advertisement revenues and redirects them to the attacker.</p><p>However, very little information was published at the time, and the little that was published [<span class="citation"><a href="#citation.2">2</a></span>], [<span class="citation"><a href="#citation.3">3</a></span>] was difficult to understand (even for technical readers). This paper attempts to provide a clear description of the virus. In doing so, it also provides some tips for reversing iOS malware, and a few new findings are also disclosed.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4883953"></a>The malware&#39;s goal</h2></div></div></div><p>iOS/AdThief.A!tr works on jailbroken <span class="emphasis"><em>iOS</em></span> devices. It implements a<span class="emphasis"><em> Cydia Substrate</em></span> [<span class="citation"><a href="#citation.4">4</a></span>] extension to hijack the revenues from advertisements on the infected device. In other words, each time you view or click an ad on an infected device, the corresponding revenue goes to the attacker, and not to the developer or the legitimate affiliate.</p><p><span class="emphasis"><em>Cydia Substrate</em></span>, which only works on jailbroken devices, is a platform for modifying existing processes. It provides an API to hook the legitimate functions, and you can add your own tweaks. This is exactly what the malware does: it hooks various advertisement functions and modifies the developer ID (a.k.a. promotion ID) to match that of the attacker (see<a href="#figure.1">Figure 1</a> ).</p><div class="figure"><a id="figure.1"></a><div class="mediaobject"><img alt="iOS/AdThief!tr hijacks advertisement revenues and redirects them to accounts owned by the attackers." src="/uploads/images/figures/2014/08/AdThief-1.jpg" /></div><p class="title"><b>Figure&nbsp;1.&nbsp;iOS/AdThief!tr hijacks advertisement revenues and redirects them to accounts owned by the attackers.</b></p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3193318"></a>Targeted adkits</h2></div></div></div><p>A list of mobile adkits targeted by the malware is provided in [<span class="citation"><a href="#citation.2">2</a></span>]: <span class="emphasis"><em>YouMi</em></span>, <span class="emphasis"><em>Vpon</em></span>, <span class="emphasis"><em>MobClick</em></span>, <span class="emphasis"><em>Umeng</em></span>, <span class="emphasis"><em>AdSage</em></span>/<span class="emphasis"><em>MobiSage</em></span>, <span class="emphasis"><em>MdotM</em></span>, <span class="emphasis"><em>InMobi</em></span>, <span class="emphasis"><em>Domob</em></span>, <span class="emphasis"><em>AdWhirl</em></span>, <span class="emphasis"><em>AdsMogo</em></span>, <span class="emphasis"><em>Google Mobile Ads SDK</em></span>, <span class="emphasis"><em>AderMob</em></span>, <span class="emphasis"><em>Weibo</em></span>, <span class="emphasis"><em>MIX SDK</em></span> and <span class="emphasis"><em>Poly SDK</em></span>. The majority of these are Chinese, four are based in the US, and two in India.</p><p>In [<span class="citation"><a href="#citation.2">2</a></span>], Xiao remarks that <span class="emphasis"><em>Weibo</em></span> is a popular social network in China, but is unable to attribute <span class="emphasis"><em>MIX SDK</em></span> and <span class="emphasis"><em>Poly SDK</em></span> more precisely. In fact, <span class="emphasis"><em>Sina Weibo</em></span>, introduced in 2013, is an advertisement SDK [<span class="citation"><a href="#citation.5">5</a></span>], so that solves one mystery.</p><p><span class="emphasis"><em>MIX SDK</em></span> can be attributed to <span class="emphasis"><em>GuoHeAD</em></span>. It probably refers to the <span class="emphasis"><em>GuoHe MIX </em></span>platform for cross-promotion of mobile games [<span class="citation"><a href="#citation.6">6</a></span>]. This is also backed up by the name of a source file found in the malware: /Volumes/MacOsStore/Project/IOS/SpAd/SpAd/AD_GuoHe.xm.</p><p>Finally, <span class="emphasis"><em>Poly SDK</em></span> is not a new adkit: it corresponds to <span class="emphasis"><em>AderMob</em></span>. This is confirmed when downloading the <span class="emphasis"><em>AderMob iOS</em></span> SDK [<span class="citation"><a href="#citation.7">7</a></span>].</p><p>Closer inspection of the malware shows that, as well as the adkits included on the list in [<span class="citation"><a href="#citation.2">2</a></span>], it also supports <span class="emphasis"><em>Komli Mobile</em></span>. This hadn&rsquo;t been identified earlier because the hook names were quite generic (&lsquo;APIManager&rsquo;). However, when searching for strings in the malware, we noticed that the name of the source file of each adkit hook is shown close to the functions it hooks. For example, the source filename &lsquo;AD MobiSage.xm&rsquo; appears next to hooks to <span class="emphasis"><em>MobiSageAdBanner</em></span> and <span class="emphasis"><em>MobiSageAdPoster</em></span>. Since &lsquo;AD KomliMobile.xm&rsquo; appears next to &lsquo;APIManager&rsquo; hooks, and that name has not yet been attributed to another adkit, we assume that &lsquo;APIManager&rsquo; corresponds to a class name of the <span class="emphasis"><em>Komli Mobile </em></span>SDK.</p><pre class="programlisting">/Volumes/MacOsStore/Project/IOS/SpAd/SpAd/AD_MobiSage.xm
__ZL69_logos_method$_ungrouped$MobiSageAdBanner$initWit..
__ZL57_logos_method$_ungrouped$MobiSageAdPoster$initWit..
__ZL69_logos_method$_ungrouped$MobiSageAdPoster$initWit..
...
__ZL178_logos_method$_ungrouped$APIManager$for..
/Volumes/MacOsStore/Project/IOS/SpAd/SpAd/AD_KomliMobile.xm
__ZL200_logos_method$_ungrouped$APIManager$for...
</pre><p>In total, therefore, the malware hijacks advertisements from 15 different adkits (see <a href="#table.1">Table 1</a>).</p><div class="table"><a id="table.1"></a><table border="1" summary="Hijacked advertisements in iOS/AdThief."><colgroup><col /><col /><col /></colgroup><thead><tr><th align="left">Adkit</th><th align="left">URL</th><th>Country</th></tr></thead><tbody><tr><td>AderMob</td><td>http://adermob.renren.com/</td><td>China</td></tr><tr><td>AdMob and Google Mobile Ads</td><td>http://www.admob.com/</td><td>USA</td></tr><tr><td>AdsMogo</td><td>http://www.adsmogo.com/ en</td><td>China</td></tr><tr><td>AdSage/MobiSage</td><td>http://www.adsage.com/mobiSage</td><td>China</td></tr><tr><td>AdWhirl</td><td>http://www.adwhirl.com</td><td>USA</td></tr><tr><td>Domob</td><td>http://domob.cn</td><td>China</td></tr><tr><td>GuoHeAD</td><td>http://www.guohead.com</td><td>China</td></tr><tr><td>InMobi</td><td>http://www.inmobi.com</td><td>India</td></tr><tr><td>Komli Mobile</td><td>http://www.komlimobile.com/index</td><td>India</td></tr><tr><td>MdotM</td><td>http://www.mdotm.com</td><td>USA</td></tr><tr><td>MobClick</td><td>http://www.mobclix.com</td><td>USA</td></tr><tr><td>UMeng</td><td>http://www.umeng.com</td><td>China</td></tr><tr><td>Vpon</td><td>http://vpon.com</td><td>China</td></tr><tr><td>Weibo </td><td>http://us.weibo.com</td><td>China</td></tr><tr><td>YouMi</td><td>http://www.youmi.net</td><td>China</td></tr></tbody></table><p class="title"><b>Table&nbsp;1.&nbsp;Hijacked advertisements in iOS/AdThief.</b></p></div><div class="table"><a id="table.2"></a><table border="1" summary="Implementation details of adkit hooks found in
      iOS/AdThief.A!tr."><colgroup><col /><col /><col /></colgroup><thead><tr><th align="center">Adkit source</th><th align="center">Filename</th><th align="center">Typical class names</th></tr></thead><tbody><tr><td>AderMob</td><td>AD Ader.xm</td><td>AderSDK*</td></tr><tr><td>AdMob and Google Mobile Ads SDK</td><td>AD AdMob.xm</td><td>GAD*</td></tr><tr><td>AdsMogo</td><td>AD AdsMongo.xm</td><td>AdMoGo*</td></tr><tr><td>AdSage</td><td>?</td><td>MobiSageAd*</td></tr><tr><td>AdWhirl</td><td>AD Adwhirl.xm</td><td>AdWhirl*</td></tr><tr><td>Domob</td><td>AD DoMob.xm</td><td>DM*</td></tr><tr><td>GuoHeAD</td><td>AD GuoHe.xm</td><td>MIXView*</td></tr><tr><td>InMobi</td><td>AD InMobi.xm</td><td>IMAd*</td></tr><tr><td>Komli Mobile</td><td>AD KomliMobile.xm</td><td>APIManager*</td></tr><tr><td>MdotM</td><td>AD MDotM.xm</td><td>MdotM*</td></tr><tr><td>MobClick</td><td>?</td><td>MobClick*</td></tr><tr><td>UMeng</td><td>AD UMeng.xm</td><td>UMUFP*</td></tr><tr><td>Vpon</td><td>AD Vpon.xm</td><td>VponAdOn*</td></tr><tr><td>Weibo</td><td>AD Weibo.xml</td><td>DXAdHWB*_</td></tr><tr><td>YouMi</td><td>AD Youmi.xm</td><td>YouMi* &ndash; delegated to Google Ads</td></tr></tbody></table><p class="title"><b>Table&nbsp;2.&nbsp;Implementation details of adkit hooks found in iOS/AdThief.A!tr.</b></p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4540256"></a>Malware intelligence</h2></div></div></div><p>The malware author forgot to strip out some debugging information &ndash; which is helpful (for us) for identifying the adkits it targets via their source filenames. It is also helpful for identifying the malware author.</p><p>Indeed, the strings inside the malware show the following path: /Users/Rover12421/Library/Developer/Xcode/DerivedData/SpAd-gfwvssdhvecvkrggjdyjwgdpkbqd/Build/Intermediates/SpAd.build/Release-iphoneos/SpAd.build/Objects-normal/armv7/SpAd.o.</p><p>We can assume that &lsquo;Rover12421&rsquo; is the malware author. He maintains a blog (http://www.rover12421.com/) and works on <span class="emphasis"><em>Android</em></span> hacks (some of which are hosted at https://github.com/rover12421). He also has a <span class="emphasis"><em>Twitter</em></span> account (@rover12421), although that is fairly inactive. On <span class="emphasis"><em>pediy.com</em></span> forums, he is known as &lsquo;zerofile&rsquo;. He actually admits to having written at least some parts of the code found in the malware. He says he worked on &lsquo;spad&rsquo; a long time ago, that it was his only <span class="emphasis"><em>iOS</em></span> project, and that it is now &lsquo;closed&rsquo; (see <a href="#figure.2">Figure 2</a>). His answers aren&rsquo;t very clear, but it seems he only wrote a basic ad ID replacement plug-in, and that someone else improved the code (see <a href="#figure.3">Figure 3</a>). He denies having participated in the propagation of the malware.</p><div class="figure"><a id="figure.2"></a><div class="mediaobject"><img alt="On a pediy.com forum, Rover12421, a.k.a. zerofile, admits to being the creator of the malware (trans-lated from Chinese)." src="/uploads/images/figures/2014/08/AdThief-2.jpg" /></div><p class="title"><b>Figure&nbsp;2.&nbsp;On a pediy.com forum, Rover12421, a.k.a. zerofile, admits to being the creator of the malware (trans-lated from Chinese).</b></p></div><p>(Click <a href="/virusbulletin/articles/2014/07/figures/AdThief-2-large.jpg" target="_top">here</a> to view a larger version of Figure 2.)</p><div class="figure"><a id="figure.3"></a><div class="mediaobject"><img alt="Private email conversation with Rover12421." src="/uploads/images/figures/2014/08/AdThief-3.jpg" /></div><p class="title"><b>Figure&nbsp;3.&nbsp;Private email conversation with Rover12421.</b></p></div><p>According to [<span class="citation"><a href="#citation.3">3</a></span>], the malware is estimated to have infected 75,000 devices, stealing revenue from around 22 million ads.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3128213"></a>Implementation</h2></div></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id2870329"></a>Overview</h3></div></div></div><p>The main parts of iOS/AdThief&rsquo;s implementation are detailed in [<span class="citation"><a href="#citation.2">2</a></span>]. However, Xiao&rsquo;s post requires some familiarity with <span class="emphasis"><em>iOS</em></span>, <span class="emphasis"><em>Substrate</em></span> and Objective C. Here, we attempt to provide a clearer description of the implementation.</p><p>Each time an end-user views or clicks on a given advertisement, the corresponding application developer (or partner, or affiliate) receives a small payment.</p><p>This is what advertisement companies refer to as &lsquo;cost per thousand impressions&rsquo; (CPM) or &lsquo;click-through rate&rsquo; (CTR). To credit the right developer when ads are viewed or clicked, adkits identify developers (or partners etc.) with a developer ID.</p><p>iOS/AdThief modifies this developer ID, replacing it with an identifier owned by the attacker. Revenues are consequently hijacked, with all of the revenue generated when an ad is viewed or clicked being assigned to the attacker&rsquo;s identifier.</p><p>To modify the developer ID, the malware author implements a hook for each of the adkits he wants to hijack, where he replaces the developer ID as he wishes. To do so, he takes advantage of an existing process-hooking platform, <span class="emphasis"><em>Substrate</em></span>, which is available on jailbroken devices. To implement a <span class="emphasis"><em>Substrate</em></span> hook, one uses a function named &lsquo;MSHookMessageEx&rsquo; with four arguments:</p><div class="orderedlist"><ol type="1"><li><p>The class to hook.</p></li><li><p>A &lsquo;selector&rsquo;, i.e. the name of the function to hook.</p></li><li><p>The address of the replacement function, i.e. the hook.</p></li><li><p>A stub to call the old replaced function in case it is needed. (It may be left as NULL if not needed.)</p></li></ol></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id2615985"></a>Registering a hook</h3></div></div></div><p>For example, in the code shown in <a href="#figure.4">Figure 4</a>, the author creates a YouMiView class object (line 1). Then he calls objc_msgSend on that object (line 6).</p><div class="figure"><a id="figure.4"></a><div class="mediaobject"><img alt="Decompiled function setting a hook for the YouMi adkit." src="/uploads/images/figures/2014/08/AdThief-4.jpg" /></div><p class="title"><b>Figure&nbsp;4.&nbsp;Decompiled function setting a hook for the YouMi adkit.</b></p></div><p>In Objective C, one does not &lsquo;call&rsquo; a function, but instead &lsquo;send a message to a function&rsquo; [<span class="citation"><a href="#citation.8">8</a></span>]. Consequently, each function call consists of a call to objc_msgSend (which is why objc_msgSend appears so frequently).</p><p>So, the author sends a message to &lsquo;instancesRespondToSelector:&rsquo; with the argument &lsquo;adViewWithContentSizeIdentifier:delegate:&rsquo;. For those more familiar with C or Java, this translates to:</p><pre class="programlisting">obj-&gt;instancesRespondToSelector(&ldquo;adViewWithContentSizeIdentifier:delegate:&rdquo;)</pre><p>InstancesRespondToSelector [<span class="citation"><a href="#citation.9">9</a></span>] is a standard <span class="emphasis"><em>iOS</em></span> function that tests &lsquo;whether instances of the receiver are capable of responding to a given selector&rsquo;, i.e. whether the instance implements a function named &lsquo;adViewWithContentSizeIdentifier:delegate:&rsquo;.</p><p>If such a function exists, the malware author decides to hook it (lines 6&ndash;7). He calls MSHookMessageEx (line 8), says he wants to hook adViewWithContentSizeIdentifier:delegate:, and that his implementation of the hook will be in _logos_meta_method_ungrouped_YouMiView_adViewWithContentSizeIdentifier_delegate_ (lines 11&ndash;12).</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id4461532"></a>Implementing a hook</h3></div></div></div><p>Continuing the previous example, the implementation of the <span class="emphasis"><em>YouMi</em></span> hook is in a function named logos_meta_method_ungrouped_YouMiView_adViewWithContent_SizeIdentifier_delegate_. Its code is shown in <a href="#figure.5">Figure 5</a>.</p><div class="figure"><a id="figure.5"></a><div class="mediaobject"><img alt="Decompiled YouMi hook function." src="/uploads/images/figures/2014/08/AdThief-5.jpg" /></div><p class="title"><b>Figure&nbsp;5.&nbsp;Decompiled YouMi hook function.</b></p></div><p>At line 11, the malware author instantiates a &lsquo;GADBannerView YouMi&rsquo; object. GAD stands for <span class="emphasis"><em>Google Ads</em></span>, and indeed if we inspect the code of this function, we see that it corresponds to the <span class="emphasis"><em>AdMob</em></span> kit, not <span class="emphasis"><em>YouMi</em></span>. Furthermore, online documentation for GADBannerView exists in the <span class="emphasis"><em>AdMob</em></span> SDK [<span class="citation"><a href="#citation.10">10</a></span>]. Next, the author initializes the banner view by sending the object a message &lsquo;initWithAdSize:origin:&rsquo;.</p><div class="figure"><a id="figure.6"></a><div class="mediaobject"><img alt="Decompiled code of function getClass GADBannerView YouMi()." src="/uploads/images/figures/2014/08/AdThief-6.jpg" /></div><p class="title"><b>Figure&nbsp;6.&nbsp;Decompiled code of function getClass GADBannerView YouMi().</b></p></div><p>The important part lies in line 14. Onto this <span class="emphasis"><em>Google Ads</em></span> banner, the author sets the &lsquo;unit identifier&rsquo; (<span class="emphasis"><em>AdMob</em></span> Publisher ID) to his preferred ID (a1521215ab55cd2 in this particular case). Then, he sets the root window (provided as the fourth argument &ndash; a4) and that same window as a delegate (line 16). Delegation is a mechanism by which a given object can act on behalf of another one, and coordinate with it. This explains the relationship between <span class="emphasis"><em>Google Ads</em></span> and <span class="emphasis"><em>YouMi</em></span>: in this particular case, the author does not directly hook <span class="emphasis"><em>YouMi</em></span> ads, but <span class="emphasis"><em>Google</em></span> ads, which act under the delegation of <span class="emphasis"><em>YouMi</em></span>.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id4693710"></a>Consolidated data</h3></div></div></div><p>We have described the details of <span class="emphasis"><em>YouMi</em></span> revenue hijacking. The hijacking of other adkits is achieved using the same strategy:</p><div class="itemizedlist"><ul type="disc"><li><p>registering one or multiple hooks for the adkit</p></li><li><p>implementing each hook.</p></li></ul></div><p>Like <span class="emphasis"><em>YouMi</em></span>, three other adkit hooks work when <span class="emphasis"><em>Google Ads</em></span> acts under delegation: <span class="emphasis"><em>DoMob</em></span>, <span class="emphasis"><em>Umeng</em></span> and <span class="emphasis"><em>Weibo</em></span>. The other adkits work on their own &ndash; without delegation.</p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4514469"></a>Conclusion</h2></div></div></div><p>iOS/AdThief is a technical and malicious piece of code which hijacks revenue from 15 different adkits. It is built on top of the <span class="emphasis"><em>Cydia Substrate</em></span> platform, available for jailbroken devices, which provides it with an easy way to modify advertisement SDKs. With <span class="emphasis"><em>Substrate</em></span>, the malware needs only to focus on the call and implementation of each hook.</p><p>At first, the identification of every adkit the malware targets was difficult because the code mentions only class names used by each adkit SDK. However, the fact that the malware author did not strip out debugging information helped us to identify all 15 adkits. In particular, this is how support for <span class="emphasis"><em>Komli Mobile</em></span> and <span class="emphasis"><em>GuoHeAD</em></span> was detected.</p><p>The debugging information also helped us to track down the malware&rsquo;s creator, a Chinese hacker specializing in mobile platforms. The hacker claims to have written parts of the code some time ago, but that a third party then improved it. He denies having participated in the spreading of the malware. With 75,000 infected devices, iOS/AdThief is not extremely prevalent. However, there are an estimated 22 million hijacked ads, so the malware has probably had a fair amount of impact and generated significant revenue for the owner(s).</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3299111"></a>Acknowledgements</h2></div></div></div><p>I would like to thank Claud Xiao, Tim Strazzere, &lsquo;baronpan7&rsquo; and Dong Xie for their help with this research.</p><div class="bibliography"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3599284"></a>Bibliography</h3></div></div></div><div class="bibliomixed"><a id="citation.1"></a><p class="bibliomixed">[1] FortiGuard Labs. Mobile threats. <span class="bibliosource"><a href="http://www.fortiguard.com/antivirus/mobile_threats.html" target="_blank">http://www.fortiguard.com/antivirus/mobile_threats.html</a></span>.</p></div><div class="bibliomixed"><a id="citation.2"></a><p class="bibliomixed">[2] Xiao, C. New iOS malware use Cydia Substrate to steal advertisement promotion fee, March 2014. <span class="bibliosource"><a href="http://www.claudxiao.net/2014/03/ios_malware_spad/" target="_blank">http://www.claudxiao.net/2014/03/ios_malware_spad/</a>.</span></p></div><div class="bibliomixed"><a id="citation.3"></a><p class="bibliomixed">[3] [original] ios app simple analysis of malicious, March 2014. <span class="bibliosource"><a href="http://bbs.pediy.com/showthread.php?%20p=1270415" target="_blank">http://bbs.pediy.com/showthread.php? p=1270415</a></span>.</p></div><div class="bibliomixed"><a id="citation.4"></a><p class="bibliomixed">[4] Cydia Substrate. <span class="bibliosource"><a href="http://www.cydiasubstrate.com/" target="_blank">http://www.cydiasubstrate.com/</a></span>.</p></div><div class="bibliomixed"><a id="citation.5"></a><p class="bibliomixed">[5] Ong, J. Sina Weibo introduces Twitter-like in-stream advertising in quest to monetize its 400m user base. <span class="bibliosource"><a href="http://thenextweb.com/asia/2013/01/18/sina-weibo-activates-in-stream-advertising-in-quest-to-monetize-microblog/" target="_blank">http://thenextweb.com/asia/2013/01/18/sina-weibo-activates-in-stream-advertising-in-quest-to-monetize-microblog/</a></span>.</p></div><div class="bibliomixed"><a id="citation.6"></a><p class="bibliomixed">[6] Lu, G. GuoheAD Introduces Guohe MIX, Cross-Promotion Platform for Mobile Games. <span class="bibliosource"><a href="http://technode.com/2012/08/11/guohead-introduces-guohe-mix-cross-promotion-platform-for-mobile-games/" target="_blank">http://technode.com/2012/08/11/guohead-introduces-guohe-mix-cross-promotion-platform-for-mobile-games/</a></span>.</p></div><div class="bibliomixed"><a id="citation.7"></a><p class="bibliomixed">[7] Ader. <span class="bibliosource"><a href="http://adermob.renren.com/s/download.html" target="_blank">http://adermob.renren.com/s/download.html</a></span>.</p></div><div class="bibliomixed"><a id="citation.8"></a><p class="bibliomixed">[8] Shub-Nigurrath. Primer on Reversing Jailbroken iPhone Native Applications v1.0, May 2008. <span class="bibliosource"><a href="http://tutorials.accessroot.com/arteam/site/download.php?view.222" target="_blank">http://tutorials.accessroot.com/arteam/site/download.php?view.222</a></span>.</p></div><div class="bibliomixed"><a id="citation.9"></a><p class="bibliomixed">[9] Apple. Nsobject class reference. <span class="bibliosource"><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSObject" target="_blank">https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSObject</a></span>.</p></div><div class="bibliomixed"><a id="citation.10"></a><p class="bibliomixed">[10] GADBannerView Class Reference. <span class="bibliosource"><a href="http://cocoadocs.org/docsets/AdMob/6.5.0/Classes/GADBannerView.html" target="_blank">http://cocoadocs.org/docsets/AdMob/6.5.0/Classes/GADBannerView.html</a></span>.</p></div></div></div> </div>
<div class="col-md-3 col-sm-3 col-lg-3">
<p><a href="/uploads/pdf/magazine/2014/vb201408-AdThief.pdf" target="_blank"><img class="ccm-image-block responsive" alt="" src="/uploads/images/buttons/pdf-download-button.jpg" onmouseover="this.src = '/uploads/images/buttons/pdf-download-button-hover.jpg'" onmouseout="this.src = '/uploads/images/buttons/pdf-download-button.jpg'" border="0" height="45" width="262"></a></p>
<div id="NDPHPBlock13359" class="NDPHPBlock">
<div style="width: 100%;"><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Tweet this!' href="https://twitter.com/share?text=Inside the iOS/AdThief malware&url=https://www.virusbulletin.com/virusbulletin/2014/08/inside-ios-adthief-malware"><img src='/uploads/images/buttons/twitter.png' alt='twitter.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on Facebook' href='https://www.facebook.com/sharer.php?u=https://www.virusbulletin.com/virusbulletin/2014/08/inside-ios-adthief-malware'><img src='/uploads/images/buttons/fb.png' alt='fb.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on LinkedIn' href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.virusbulletin.com/virusbulletin/2014/08/inside-ios-adthief-malware&title=Inside the iOS/AdThief malware"><img src='/uploads/images/buttons/linkedin.png' alt='linkedin.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on Hacker News' href="https://news.ycombinator.com/submitlink?u=https://www.virusbulletin.com/virusbulletin/2014/08/inside-ios-adthief-malware&t=Inside the iOS/AdThief malware"><img src='/uploads/images/buttons/hackernews.png' alt='hackernews.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='reddit this!' href="https://www.reddit.com/submit?url=https://www.virusbulletin.com/virusbulletin/2014/08/inside-ios-adthief-malware"><img src='/uploads/images/buttons/reddit.png' alt='reddit.png' width='45' height='45' class='responsive' /></a></center></div></div></div><p> </p>
<h2>Latest articles:</h2>
<div class="ccm-page-list">
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2022/04/cryptojacking-fly-teamtnt-using-nvidia-drivers-mine-cryptocurrency/" target="_self">Cryptojacking on the fly: TeamTNT using NVIDIA drivers to mine cryptocurrency</a>
</h3>
<div class="ccm-page-list-description">
TeamTNT is known for attacking insecure and vulnerable Kubernetes deployments in order to infiltrate organizations&rsquo; dedicated environments and transform them into attack launchpads. In this article Aditya Sood presents a new module introduced by&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/12/collector-stealer-russian-origin-credential-and-information-extractor/" target="_self">Collector-stealer: a Russian origin credential and information extractor</a>
</h3>
<div class="ccm-page-list-description">
Collector-stealer, a piece of malware of Russian origin, is heavily used on the Internet to exfiltrate sensitive data from end-user systems and store it in its C&amp;C panels. In this article, researchers Aditya K Sood and Rohit Chaturvedi present a 360&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/06/fighting-fire-fire/" target="_self">Fighting Fire with Fire</a>
</h3>
<div class="ccm-page-list-description">
In 1989, Joe Wells encountered his first virus: Jerusalem. He disassembled the virus, and from that moment onward, was intrigued by the properties of these small pieces of self-replicating code. Joe Wells was an expert on computer viruses, was partly&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/04/run-your-malicious-vba-macros-anywhere/" target="_self">Run your malicious VBA macros anywhere!</a>
</h3>
<div class="ccm-page-list-description">
Kurt Natvig wanted to understand whether it&rsquo;s possible to recompile VBA macros to another language, which could then easily be &lsquo;run&rsquo; on any gateway, thus revealing a sample&rsquo;s true nature in a safe manner. In this article he explains how he recompiled&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/04/dissecting-design-and-vulnerabilities-azorultccpanels/" target="_self">Dissecting the design and vulnerabilities in AZORult&nbsp;C&amp;C&nbsp;panels</a>
</h3>
<div class="ccm-page-list-description">
Aditya K Sood looks at the command-and-control (C&amp;C) design of the AZORult malware, discussing his team's findings related to the C&amp;C design and some security issues they identified during the research. </div>
</div>
<p><br /><a class="btn btn-block btn-warning" href="/virusbulletin/archive">Bulletin Archive</a></p> </div>
</div>
</div>

<footer class="bs-footer" role="contentinfo">
<div class="container">
<div class="bs-social">
<div class="row ">
<div class="col-md-3">
<p><a title="About Us" href="/about-vb/about-us/">About us</a></p>
<p><a title="Contact Us" href="/about-vb/contact-us/">Contact us</a></p>
<p><a title="Advisory Board" href="/about-vb/advisory-board/">Advisory board</a></p>
<p><a title="Press" href="/about-vb/press/">Press information</a></p>
<p><a title="Security Events Calendar" href="/resources/calendar/">Security events calendar</a></p>
<p><a title="Newsletter" href="/newsletter/">Virus Bulletin newsletter</a></p> </div>
<div class="col-md-3">
<p><a title="VB Testing" href="/testing/">Testing</a></p>
<p><a title="VB100" href="/testing/vb1001/">VB100</a></p>
<p><a title="VBSpam" href="/testing/vbspam/">VBSpam</a></p>
<p><a title="VBWeb" href="/testing/vbweb/">VBWeb</a></p>
<p><a title="Consultancy Services" href="/testing/consultancy-services/">Consultancy services</a></p>
<p><a title="The Spammers' Compendium" href="/resources/spammerscompendium/">Spammers' Compendium</a></p> </div>
<div class="col-md-3">
<p><a title="VB2021 localhost" href="/conference/vb2021/">VB2021 localhost</a></p>
<p><a title="VB2020 localhost" href="/conference/vb2020/">VB2020 localhost</a></p>
<p><a title="VB2019" href="/conference/vb2019/">VB2019 (London)</a></p>
<p><a title="VB2018" href="/conference/vb2018">VB2018 (Montreal)</a></p>
<p><a title="VB2017" href="/conference/vb2017">VB2017 (Madrid)</a></p>
<p><a title="Conference Archive" href="/conference/vb-conference-archive/">Older conferences</a></p> </div>
<div class="col-md-3">
<div class="row">
<table style="float: right;" border="0">
<tbody>
<tr>
<td align="center"><a href="/rss" target="_blank"><img title="Get our blog updates" src="/uploads/images/buttons/rss-square-gray.png" alt="rss.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://twitter.com/virusbtn" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on Twitter" src="/uploads/images/buttons/twitter-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.linkedin.com/company/virus-bulletin" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on LinkedIn" src="/uploads/images/buttons/linkedin-square-gray.png" alt="linkedin.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.facebook.com/virusbulletin" target="_blank"><img title="Visit us on Facebook" src="/uploads/images/buttons/fb-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.youtube.com/user/virusbtn" target="_blank"><img title="Visit us on Youtube" src="/uploads/images/buttons/youtube-square-gray.png" alt="youtube.png" width="35" height="35" /></a></td>
</tr>
</tbody>
</table>
</div> </div>
</div>
<div class="row ">
<div class="col-md-12">
</div>
</div>
</div>
</div>
</footer>

<footer class="bs-footer2" role="contentinfo">
<div class="container">
<div class="bs-social2">
<div class="row ">
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
</div>
<div class="row ">
<div class="col-md-12">
<p style="text-align: left;">©1989-2022 Virus Bulletin.        <a title="Privacy Policy" href="/about-vb/privacy-policy/">Privacy policy</a>        <a title="Cookies" href="/about-vb/privacy-policy/cookies/">Cookies</a>        <a title="Terms and Conditions" href="/about-vb/terms-and-conditions/">Terms and Conditions</a></p> </div>
</div>
</div>
</div>
</footer>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-21876594-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-21876594-2', { 'anonymize_ip': true });
</script><script type="text/javascript" src="/libraries/js/fancybox.load.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/app.js"></script>
<div id="ccm-cookiesDisclosure" class="disclosure-bottom">
<div class="disclosure-container">
<div class="disclosure-content">
<p> We have placed cookies on your device in order to improve the functionality of this site, as outlined in our <a href="/about-vb/privacy-policy/cookies" target="_blank">cookies policy</a>. However, you may delete and block all cookies from this site and your use of the site will be unaffected. By continuing to browse this site, you are agreeing to Virus Bulletin's use of data as outlined in our <a href="/about-vb/privacy-policy/" target="_blank">privacy policy</a>.</p>
</div>
<div class="disclosure-form">
<form action="/index.php/cookies_disclosure/" method="POST">
<input type="hidden" name="allowCookies" value="1" />
<div class="button">
<input class="btn btn-info btn-sm" type="submit" name="submit" value="I understand. Don't show this message again!" />
</div>
</form>
</div>
<div class="ccm-spacer">&nbsp;</div>
</div>
</div>
</body>
</html>