Using Root Certificates with OpenSSL on FreeBSD

Get link

Facebook

Twitter

Pinterest

Email

Other Apps

September 05, 2006

I'm reading a great book on Apache security.  One of the examples involves using the openssl client program to analyze a chain of certificates.In the following example I use openssl to connect to www.thawte.com, but I do not provide a location to find root certificates.orr:/home/richard$ openssl s_client -host www.thawte.com -port 443CONNECTED(00000003) depth=1 /C=ZA/O=Thawte Consulting (Pty) Ltd./CN=Thawte SGC CAverify error:num=20:unable to get local issuer certificateverify return:0---Certificate chain 0 s:/C=ZA/ST=Western Cape/L=Cape Town/O=Thawte Consulting (Pty)       Ltd/OU=Security/CN=www.thawte.com   i:/C=ZA/O=Thawte Consulting (Pty) Ltd./CN=Thawte SGC CA 1 s:/C=ZA/O=Thawte Consulting (Pty) Ltd./CN=Thawte SGC CA   i:/C=US/O=VeriSign, Inc./OU=Class 3 Public Primary Certification Authority---Server certificate-----BEGIN CERTIFICATE-----MIIDRDCCAq2gAwIBAgIQaS8vV/TrQ/S1Mg+/74dipDANBgkqhkiG9w0BAQQFADBMMQswCQYDVQQGEwJaQTElMCMGA1UEChMcVGhhd3RlIENvbnN1bHRpbmcgKFB0eSkgTHRkLjEWMBQGA1UEAxMNVGhhd3RlIFNHQyBDQTAeFw0wNjA3MDQxMTM5MTdaFw0wNzA3MTYwOTMzMDlaMIGKMQswCQYDVQQGEwJaQTEVMBMGA1UECBMMV2VzdGVybiBDYXBlMRIwEAYDVQQHEwlDYXBlIFRvd24xJDAiBgNVBAoTG1RoYXd0ZSBDb25zdWx0aW5nIChQdHkpIEx0ZDERMA8GA1UECxMIU2VjdXJpdHkxFzAVBgNVBAMTDnd3dy50aGF3dGUuY29tMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC/h9nzmXfQkZsJCjznxdLV8/Ebms8qzEjO8KnHyT4+94cI0WjjlyqJH1ZgLM2/dccKS4vj6X7nl/vY6o1ZT3pn+o6C3vl3EdMiLzKcQLpq+da03Y2xrtgIe070zCbQb4r7um4A/QFDrHARfgC4PllHGnmPFDXsiA4OKGIQ65vcGwIDAQABo4HnMIHkMCgGA1UdJQQhMB8GCCsGAQUFBwMBBggrBgEFBQcDAgYJYIZIAYb4QgQBMDYGA1UdHwQvMC0wK6ApoCeGJWh0dHA6Ly9jcmwudGhhd3RlLmNvbS9UaGF3dGVTR0NDQS5jcmwwcgYIKwYBBQUHAQEEZjBkMCIGCCsGAQUFBzABhhZodHRwOi8vb2NzcC50aGF3dGUuY29tMD4GCCsGAQUFBzAChjJodHRwOi8vd3d3LnRoYXd0ZS5jb20vcmVwb3NpdG9yeS9UaGF3dGVfU0dDX0NBLmNydDAMBgNVHRMBAf8EAjAAMA0GCSqGSIb3DQEBBAUAA4GBAINguft3Ek1xX6aiP9/QCrwHJErYrwEtRkURG+ghVVTCEhtZrqD5LdUHionIkmfgu5FSvrSN3VH/JdOv3qngubpcTfhOHLxNuML5WB6Rwul5gfONsUFEoEPOMGxF4x22b7iG6QA5j42Ueop6NkYq4HtuOqKNcy9zuyDpzVA/EZus-----END CERTIFICATE-----subject=/C=ZA/ST=Western Cape/L=Cape Town/O=Thawte Consulting (Pty)  Ltd/OU=Security/CN=www.thawte.comissuer=/C=ZA/O=Thawte Consulting (Pty) Ltd./CN=Thawte SGC CA---No client certificate CA names sent---SSL handshake has read 2214 bytes and written 340 bytes---New, TLSv1/SSLv3, Cipher is DHE-RSA-AES256-SHAServer public key is 1024 bitSSL-Session:    Protocol  : TLSv1    Cipher    : DHE-RSA-AES256-SHA    Session-ID: BF365536023EF272C68C3A9420364D68BF6363FB59461B1BF9BB9C36A6BA8FA9    Session-ID-ctx:     Master-Key: 9B6224C8083E007C2D4797B9D92317B213AD53FC6C5EF693FC17D                8D3B3B9B918D7E03317C67BCE5699CF102ED707B5C6    Key-Arg   : None    Start Time: 1157455445    Timeout   : 300 (sec)    Verify return code: 20 (unable to get local issuer certificate)---HEAD / HTTP/1.0HTTP/1.1 200 OKDate: Tue, 05 Sep 2006 11:25:22 GMTServer: ApacheAccept-Ranges: bytesContent-Length: 25062Connection: closeContent-Type: text/htmlclosedThe return code    Verify return code: 20 (unable to get local issuer certificate)is the important item here.FreeBSD's base installation does not include the ca-root.crt file expected with other Unix-like systems.  That file is available as the security/ca-roots port, however.orr:/root# setenv PACKAGESITE  ftp://ftp2.freebsd.org/pub/FreeBSD/ports/i386/packages-6-stable/Latest/orr:/root# pkg_add -vr ca-rootslooking up ftp2.freebsd.orgconnecting to ftp2.freebsd.org:21setting passive modeopening data connectioninitiating transferFetching ftp://ftp2.freebsd.org/pub/FreeBSD/ports/i386/packages-6-stable/Latest/ ca-roots.tbz...x +CONTENTSx +COMMENTx +DESCx +MTREE_DIRSx share/certs/ca-root.crttar command returns 0 status Done.extract: Package name is ca-roots-1.2extract: CWD to /usr/localextract: execute 'mkdir -p /usr/local/share/certs'extract: /usr/local/share/certs/ca-root.crtextract: execute 'ln -s /usr/local/share/certs/ca-root.crt /etc/ssl/cert.pem'extract: CWD to .Running mtree for ca-roots-1.2..mtree -U -f +MTREE_DIRS -d -e -p /usr/local >/dev/nullAttempting to record package into /var/db/pkg/ca-roots-1.2..Package ca-roots-1.2 registered in /var/db/pkg/ca-roots-1.2With these SSL Certificate Authority root certificates installed, I use openssl in this manner.orr:/home/richard$ openssl s_client -host www.thawte.com -port 443 -CAfile /etc/ssl/cert.pemCONNECTED(00000003)depth=2 /C=US/O=VeriSign, Inc./OU=Class 3 Public Primary Certification Authorityverify return:1depth=1 /C=ZA/O=Thawte Consulting (Pty) Ltd./CN=Thawte SGC CAverify return:1depth=0 /C=ZA/ST=Western Cape/L=Cape Town/O=Thawte Consulting (Pty) Ltd/OU=Security/CN=www.thawte.comverify return:1---Certificate chain 0 s:/C=ZA/ST=Western Cape/L=Cape Town/O=Thawte Consulting (Pty)    Ltd/OU=Security/CN=www.thawte.com   i:/C=ZA/O=Thawte Consulting (Pty) Ltd./CN=Thawte SGC CA 1 s:/C=ZA/O=Thawte Consulting (Pty) Ltd./CN=Thawte SGC CA   i:/C=US/O=VeriSign, Inc./OU=Class 3 Public Primary Certification Authority---Server certificate-----BEGIN CERTIFICATE-----MIIDRDCCAq2gAwIBAgIQaS8vV/TrQ/S1Mg+/74dipDANBgkqhkiG9w0BAQQFADBMMQswCQYDVQQGEwJaQTElMCMGA1UEChMcVGhhd3RlIENvbnN1bHRpbmcgKFB0eSkgTHRkLjEWMBQGA1UEAxMNVGhhd3RlIFNHQyBDQTAeFw0wNjA3MDQxMTM5MTdaFw0wNzA3MTYwOTMzMDlaMIGKMQswCQYDVQQGEwJaQTEVMBMGA1UECBMMV2VzdGVybiBDYXBlMRIwEAYDVQQHEwlDYXBlIFRvd24xJDAiBgNVBAoTG1RoYXd0ZSBDb25zdWx0aW5nIChQdHkpIEx0ZDERMA8GA1UECxMIU2VjdXJpdHkxFzAVBgNVBAMTDnd3dy50aGF3dGUuY29tMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC/h9nzmXfQkZsJCjznxdLV8/Ebms8qzEjO8KnHyT4+94cI0WjjlyqJH1ZgLM2/dccKS4vj6X7nl/vY6o1ZT3pn+o6C3vl3EdMiLzKcQLpq+da03Y2xrtgIe070zCbQb4r7um4A/QFDrHARfgC4PllHGnmPFDXsiA4OKGIQ65vcGwIDAQABo4HnMIHkMCgGA1UdJQQhMB8GCCsGAQUFBwMBBggrBgEFBQcDAgYJYIZIAYb4QgQBMDYGA1UdHwQvMC0wK6ApoCeGJWh0dHA6Ly9jcmwudGhhd3RlLmNvbS9UaGF3dGVTR0NDQS5jcmwwcgYIKwYBBQUHAQEEZjBkMCIGCCsGAQUFBzABhhZodHRwOi8vb2NzcC50aGF3dGUuY29tMD4GCCsGAQUFBzAChjJodHRwOi8vd3d3LnRoYXd0ZS5jb20vcmVwb3NpdG9yeS9UaGF3dGVfU0dDX0NBLmNydDAMBgNVHRMBAf8EAjAAMA0GCSqGSIb3DQEBBAUAA4GBAINguft3Ek1xX6aiP9/QCrwHJErYrwEtRkURG+ghVVTCEhtZrqD5LdUHionIkmfgu5FSvrSN3VH/JdOv3qngubpcTfhOHLxNuML5WB6Rwul5gfONsUFEoEPOMGxF4x22b7iG6QA5j42Ueop6NkYq4HtuOqKNcy9zuyDpzVA/EZus-----END CERTIFICATE-----subject=/C=ZA/ST=Western Cape/L=Cape Town/O=Thawte Consulting (Pty)  Ltd/OU=Security/CN=www.thawte.comissuer=/C=ZA/O=Thawte Consulting (Pty) Ltd./CN=Thawte SGC CA---No client certificate CA names sent---SSL handshake has read 2214 bytes and written 340 bytes---New, TLSv1/SSLv3, Cipher is DHE-RSA-AES256-SHAServer public key is 1024 bitSSL-Session:    Protocol  : TLSv1    Cipher    : DHE-RSA-AES256-SHA    Session-ID: 3121A8A4A5DFE70DABA68C5354C2DE89996F622CE7A323F97EB3E87390594F6B    Session-ID-ctx:     Master-Key: E4C5A3B6B5DFF98BFAF2C9CCF8E86083B2D03EE06984707EF238                F431531F00D9CEA3579E6386E9DB13C57EB84B3E2BAF    Key-Arg   : None    Start Time: 1157455485    Timeout   : 300 (sec)    Verify return code: 0 (ok)---HEAD / HTTP/1.0HTTP/1.1 200 OKDate: Tue, 05 Sep 2006 11:26:02 GMTServer: ApacheAccept-Ranges: bytesContent-Length: 25062Connection: closeContent-Type: text/htmlclosedNow we see    Verify return code: 0 (ok)which means the certificate presented by the Web server is legitimate.
