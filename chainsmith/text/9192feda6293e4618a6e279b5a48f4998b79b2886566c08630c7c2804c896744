Getting Your FreeBSD Box to Speak 802.1q Trunks with a Cisco Switch

Get link

Facebook

Twitter

Pinterest

Email

Other Apps

December 16, 2003

I have the following setup on my home LAN:cable modem - cisco router - freebsd fw/gw - cisco switch -  clients<
The client boxes are in two separate VLANs with different address spaces.  I needed a way for them to be able to talk to the FreeBSD 4.9 REL firewall/gateway without wasting two interfaces on the fw/gw.  Here's how I set this up.  I'm no Cisco guru so excuse my lack of shortcuts.  I got some help from this how-to, this thread, and this Cisco guide. First, on the switch, I created my VLANs:gruden#conf termEnter configuration commands, one per line.  End with CNTL/Z.gruden(config)#vlan 20gruden(config-vlan)#name greengruden(config-vlan)#endgruden#conf termEnter configuration commands, one per line.  End with CNTL/Z.gruden(config)#vlan 10gruden(config-vlan)#name yellowgruden(config-vlan)#endNext I created my trunk port to speak to the FreeBSD box:gruden#conf termEnter configuration commands, one per line.  End with CNTL/Z.gruden(config)#int fa0/24gruden(config-if)#switchport mode trunkgruden(config-if)#endgruden#sh int fa0/24 switchportName: Fa0/24Switchport: EnabledAdministrative Mode: trunkOperational Mode: trunkAdministrative Trunking Encapsulation: dot1qOperational Trunking Encapsulation: dot1qNegotiation of Trunking: OnAccess Mode VLAN: 1 (default)Trunking Native Mode VLAN: 1 (default)Voice VLAN: noneAdministrative private-vlan host-association: noneAdministrative private-vlan mapping: noneOperational private-vlan: noneTrunking VLANs Enabled: ALLPruning VLANs Enabled: 2-1001Capture Mode DisabledCapture VLANs Allowed: ALLProtected: falseVoice VLAN: none (Inactive)Appliance trust: noneThen I added each switch port to the appropriate VLAN.  This is what adding a single port looks like:gruden#conf termEnter configuration commands, one per line.  End with CNTL/Z.gruden(config)#int fa0/1gruden(config-if)#switchport mode accessgruden(config-if)#switchport access vlan 10gruden(config-if)#endgruden#sh int fa0/1 switchportName: Fa0/1Switchport: EnabledAdministrative Mode: static accessOperational Mode: downAdministrative Trunking Encapsulation: dot1qNegotiation of Trunking: OffAccess Mode VLAN: 10 (yellow)Trunking Native Mode VLAN: 1 (default)Voice VLAN: noneAdministrative private-vlan host-association: noneAdministrative private-vlan mapping: noneOperational private-vlan: noneTrunking VLANs Enabled: ALLPruning VLANs Enabled: 2-1001Capture Mode DisabledCapture VLANs Allowed: ALLProtected: falseVoice VLAN: none (Inactive)Appliance trust: none
On to the FreeBSD box!  I used the following commands to set it up.  Note that fxp2 is the single physical interface connected to interface 0/24 on the Cisco switch:ifconfig vlan0 createifconfig vlan1 createifconfig vlan0 vlan 10 vlandev fxp2ifconfig vlan1 vlan 20 vlandev fxp2ifconfig vlan0 inet 10.100.100.1 netmask 255.255.255.0ifconfig vlan1 inet 172.207.200.1 netmask 255.255.255.0ifconfig fxp2 upWhen done, the interfaces on the FreeBSD box look like this:moog# ifconfig vlan0vlan0: flags=8843 mtu 1500        inet 10.100.100.1 netmask 0xffffff00 broadcast 10.100.100.255        inet6 fe80::2d0:b7ff:fe61:3234%vlan0 prefixlen 64 scopeid 0xa        ether 00:02:b3:0a:cd:5b        media: Ethernet autoselect (100baseTX )        status: active        vlan: 10 parent interface: fxp2moog# ifconfig vlan1vlan1: flags=8843 mtu 1500        inet 172.207.200.1 netmask 0xffffff00 broadcast 172.207.200.255        inet6 fe80::2d0:b7ff:fe61:3234%vlan1 prefixlen 64 scopeid 0xb        ether 00:02:b3:0a:cd:5b        media: Ethernet autoselect (100baseTX )        status: active        vlan: 20 parent interface: fxp2fxp2: flags=8843 mtu 1500        inet6 fe80::202:b3ff:fe0a:cd5b%fxp2 prefixlen 64 scopeid 0x3        ether 00:02:b3:0a:cd:5b        media: Ethernet autoselect (100baseTX )        status: activeTo make this automatic, add these entries to /etc/rc.conf:cloned_interfaces="vlan0 vlan1"ifconfig_vlan0="inet 10.100.100.1 netmask 255.255.255.0 vlan 10 vlandev fxp2"ifconfig_vlan1="inet 172.207.200.1 netmask 255.255.255.0 vlan 20 vlandev fxp2"ifconfig_fxp2="up"When done, the 10.100.100.0/24 and 172.207.200.0/24 networks will be able to talk to each other through the FreeBSD box.
