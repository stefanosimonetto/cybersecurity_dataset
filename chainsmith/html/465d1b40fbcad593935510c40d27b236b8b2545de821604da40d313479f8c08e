<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<script type="text/javascript">var BOOTSTRAP_VERSION ="lumen";
	var BOOTSTRAP_JS_HEAD =1;
	var BOOTSTRAP_CDN_ENABLE =0; var BOOTSTRAP_NAVBAR_TYPE =0; var BOOTSTRAP_LOGO_OPTION =0; var BOOTSTRAP_NAVBAR =1; var BootstrapInputFix =true;var BootstrapNavbarLineHeightFix =true;var BOOTSTRAP_EDT= 0; </script>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>Virus Bulletin :: Andromeda botnet</title>
<meta name="description" content="The Andromeda botnet recruits its bots thanks to four key elements - compromised websites, an exploit kit, a downloader and a mailing engine - linked by four sequential phases. Neo Tan takes a closer look." />
<meta name="generator" content="concrete5 - 5.6.3.5" />
<script type="text/javascript">
var CCM_DISPATCHER_FILENAME = '/index.php';var CCM_CID = 1935;var CCM_EDIT_MODE = false;var CCM_ARRANGE_MODE = false;var CCM_IMAGE_PATH = "/concrete/images";
var CCM_TOOLS_PATH = "/index.php/tools/required";
var CCM_BASE_URL = "https://www.virusbulletin.com";
var CCM_REL = "";

</script>
<link rel="shortcut icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
<link rel="icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
<link rel="stylesheet" type="text/css" href="/concrete/css/ccm.base.css" />
<script type="text/javascript" src="/concrete/js/jquery.js"></script>
<script type="text/javascript" src="/concrete/js/ccm.base.js"></script>
<script type="text/javascript">
var COOKIES_ALLOWED=false;
</script>
<link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure.css" />
<!--[if lte IE 8]><link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure_ie.css" /><![endif]-->
<script type="text/javascript">
var COOKIES_DISCLOSURE_HIDE_INTERVAL=10;
</script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_hide.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap-overwrites.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/members.css" />
<script type="text/javascript" src="/packages/bootstrap/js/common/prettify.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/jquery.easing.1.3.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="/libraries/css/jquery.fancybox.css" />
<script type="text/javascript" src="/libraries/js/jquery.fancybox.pack.js"></script>
<link rel="stylesheet" media="screen" type="text/css" href="/files/cache/css/bootstrap/typography.css" />
<script type="text/javascript" src="/index.php/tools/packages/free_cookies_disclosure/disclosure_i18n_js"></script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_ajax_form.js"></script>
<link rel="stylesheet" type="text/css" href="/concrete/blocks/page_list/view.css" />
<link rel="stylesheet" type="text/css" href="/packages/remo_expand/blocks/remo_expand/templates/vbexpand/view.css" />
<script type="text/javascript" src="/packages/remo_expand/js/jquery.color.js"></script>
<script type="text/javascript" src="/packages/remo_expand/js/jquery.ba-hashchange.js"></script>
<script type="text/javascript" src="/packages/remo_expand/js/remo.expand.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/blocks/search/templates/VB_global_search/view.css" />
<link rel="stylesheet" type="text/css" href="/packages/travisn_spacer/css/ccm.tnspacer.css" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.js" integrity="sha256-1SFdTXlsw0RkQ+iO0E91LDshGiIbPiTYqJto0px4wds=" crossorigin="anonymous"></script>
<!--[if gte IE 9]>
<script src="/packages/bootstrap/js/common/modernizr.js"></script>
<![endif]-->

<!--[if lt IE 9]>	
	
	<script src="/packages/bootstrap/js/common/html5shiv.js"></script>
	<script src="/packages/bootstrap/js/common/respond.min.js"></script>
	
<![endif]-->
</head>
<body data-spy="scroll" data-target=".bs-sidebar">

<div class="navbar  navbar-fixed-top navbar-default  bs-docs-nav">
<div class="navbar-inner">
<div class="container"><div class="row"><div class="col-sm-4 col-md-4 logo-position-1 col-logo">
<div class="navbar-header">
<button type="button" class="navbar-toggle btn_navbar_custom">
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button><div class="mobile-clearfix"></div><div class="navbar-brand navbar-brand-area"><a href="/"><img border="0" class="ccm-image-block" alt="" src="/files/4614/4535/7515/logo-big.png" width="339" height="92" /></a></div> </div>
</div><div class="col-sm-8 col-md-8 logo-position-1 col-nav"> <div class="nav-collapse collapse nav_collapse_custom navbar-collapse"> <div style="clear:both"></div>
<div class="vb-global-search-div">
<form action="/index.php/global-search-results/" method="get">
<fieldset>
<input name="search_paths[]" type="hidden" value="" />
<input name="query" type="text" class="vb-global-search" placeholder="Search site..." />
<input name="submit" type="submit" value="Search!" style="display:none" />
</fieldset>
</form>
</div>
<div class="tnSpacer" style="height:48px"></div>
<ul class="nav nav-pills"><li class=" nav-first nav-item-6299"><a href="/newsletter/" target="_self" class=" nav-first nav-item-6299 ">Newsletter</a></li><li class=" nav-item-260"><a href="/conference/" target="_self" class=" nav-item-260 ">VB Conference</a></li><li class=" nav-item-166"><a href="/testing/" target="_self" class=" nav-item-166 ">VB Testing</a></li><li class=" nav-path-selected active nav-item-160"><a href="/virusbulletin/" target="_self" class=" nav-path-selected active nav-item-160 ">Bulletin</a></li><li class=" nav-last nav-item-130"><a href="/blog/" target="_self" class=" nav-last nav-item-130 ">Blog</a></li></ul> </div>
</div>
</div><div class="clearfix"></div>
</div>
</div>
</div>
<div class="navbar-top-fixed-space "><div class="clearfix"></div></div>

<div class="container m-top-20">
<div class="row">
<div class="col-md-9 col-sm-9 col-lg-9">
<div class="titlepage" xmlns=""><div><div><h1 class="title" xmlns="http://www.w3.org/1999/xhtml"><a id="vb201206-Andromeda"></a>Andromeda botnet</h1></div><div><p class="pubdate" xmlns="http://www.w3.org/1999/xhtml">2012-06-01</p></div><div><div class="authorgroup" xmlns="http://www.w3.org/1999/xhtml"><div class="author titlepage"><h3 class="author"><span class="surname">Neo Tan</span></h3><span class="orgname">Fortinet</span>, <span class="orgdiv">Canada</span></div><b class="editedby">Editor: </b><span class="editor"><span class="firstname">Helen</span> <span class="surname">Martin</span></span></div></div><div><div class="abstract" xmlns="http://www.w3.org/1999/xhtml"><p class="title"><b>Abstract</b></p><p>The Andromeda botnet recruits its bots thanks to four key elements - compromised websites, an exploit kit, a downloader and a mailing engine - linked by four sequential phases. Neo Tan takes a closer look.</p></div></div><div><p class="copyright" xmlns="http://www.w3.org/1999/xhtml"><i>Copyright &copy; 2012 Virus Bulletin</i></p></div></div><hr /></div>
<div class="ccm-remo-expand">
<div id="ccm-remo-expand-title-3179" class="ccm-remo-expand-title ccm-remo-expand-closed" data-expander-speed="200">Table of contents</div><div id="ccm-remo-expand-content-3179" class="ccm-remo-expand-content"><div class="toc"><dl><dt><span class="sect1"><a href="#id4112953"></a></span></dt><dt><span class="sect1"><a href="#id4828375">Phase 1: Compromised websites lead to exploit kit</a></span></dt><dt><span class="sect1"><a href="#id4342624">Phase 2: Exploit kit performs drive-by install</a></span></dt><dt><span class="sect1"><a href="#id2759125">Phase 3: Downloader retrieves spam engine</a></span></dt><dt><span class="sect1"><a href="#id2763666">Phase 4: Spam engine</a></span></dt><dt><span class="sect1"><a href="#id4787701">Conclusion</a></span></dt></dl></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4112953"></a></h2></div></div></div><p>Andromeda&rsquo;s bots are served by exploit kits hosted on compromised websites; social engineering (spam, social networks etc.) is used to direct victims to such sites. The bot&rsquo;s code is obfuscated by an outsourced custom packer, and the botnet uses fast-flux C&amp;C servers and an encrypted communication protocol.</p><p>Unlike many botnets, Andromeda uses its bots actively to spread. There are four key elements in its propagation strategy (<a href="#figure.1">Figure 1</a>), which are leveraged sequentially. During this sequence, the bot also delivers its payload &ndash; this may include downloading additional arbitrary malware, stealing various account details, and spamming. In this article, we will discuss the four key elements of Andromeda&rsquo;s propagation strategy, and describe how they are linked by the four-stage sequence.</p><div class="figure"><a id="figure.1"></a><div class="mediaobject"><img alt="Propagation flow chart." src="/uploads/images/figures/2012/06/Tan-1.jpg" /></div><p class="title"><b>Figure&nbsp;1.&nbsp;Propagation flow chart.</b></p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4828375"></a>Phase 1: Compromised websites lead to exploit kit</h2></div></div></div><p>The compromised websites that host the exploit kits involved in Andromeda&rsquo;s propagation may seem perfectly innocuous to targeted users. For example, in December 2011, we found a compromised site containing e-cards from a commonly used online greetings card site: http://www.123g****ing.com. At that time of year, it would not be regarded as suspicious for a user to receive a Christmas e-card from such a site (whether sent by a friend intentionally, or because their computer was infected, as we will see in Phase 4 below).</p><p>The redirection technique used here is rather common: a hidden iframe is inserted dynamically into the compromised website by an obfuscated JavaScript. <a href="#figure.2">Figure 2</a> is a snippet of the HTML code of the compromised page, showing one variant of the obfuscated and encrypted JavaScript.</p><div class="figure"><a id="figure.2"></a><div class="mediaobject"><img alt="Obfuscated and encrypted JavaScript." src="/uploads/images/figures/2012/06/Tan-2.jpg" /></div><p class="title"><b>Figure&nbsp;2.&nbsp;Obfuscated and encrypted JavaScript.</b></p></div><p>The obfuscation and encryption vary from time to time. In the example above, the &lsquo;eval()&rsquo; function is re-written into a new function called &lsquo;e()&rsquo; in order to evade detection. After decryption, the encrypted data &lsquo;n&rsquo; becomes a JavaScript function, which adds an iframe to the document body. The src field of the iframe points to an exploit kit server, or a redirect link that eventually lands at the exploit kit server.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4342624"></a>Phase 2: Exploit kit performs drive-by install</h2></div></div></div><p>The exploit kit used here is the infamous Blackhole kit [<span class="citation"><a href="#citation.1">1</a></span>]. The version used at the time of writing this article is in JavaScript and is obfuscated and encrypted dynamically (server-side polymorphism is a common technique among today&rsquo;s exploit kits). The various exploits served by the kit are constantly updated by its authors. The kit is sold on the underground market with quite a flexible licensing scheme and also has a rental service, allowing users to rent the exploit kit servers for a period of time. Altogether, these features make Blackhole one of the most popular exploit kits at present.</p><p>Figure 3 is a screenshot of the HTTP GET stream from the victim PC to the exploit kit server.</p><div class="figure"><a id="figure.3"></a><div class="mediaobject"><img alt="HTTP GETstream." src="/uploads/images/figures/2012/06/Tan-3.jpg" /></div><p class="title"><b>Figure&nbsp;3.&nbsp;HTTP GETstream.</b></p></div><p>The hex value after &lsquo;page=&rsquo; is probably an affiliate ID, suggesting that the gang behind Andromeda has established an affiliate programme, whereby partners redirecting innocent users to the exploit kits are paid based on how much &lsquo;fresh meat&rsquo; they bring.</p><p>The server replies with an obfuscated JavaScript implementing the exploits.</p><p>In the version we analysed, the kit contained four exploits targeting the following vulnerabilities:</p><div class="orderedlist"><ol type="1"><li><p>Java Runtime Environment vulnerability: CVE-2011-3544</p></li><li><p>Help Center URL Validation vulnerability: CVE-2010-1885</p></li><li><p>Adobe Flash Player vulnerability: CVE-2011-0611</p></li><li><p>Adobe Reader vulnerability: CVE-2010-0188.</p></li></ol></div><p>Following the success of any of the above exploits, a downloader is dropped on the victim&rsquo;s machine and run either directly, or via an intermediary shellcode. <a href="#figure.4">Figure 4</a> shows an example of such a shellcode.</p><div class="figure"><a id="figure.4"></a><div class="mediaobject"><img alt="The shellcode." src="/uploads/images/figures/2012/06/Tan-4.jpg" /></div><p class="title"><b>Figure&nbsp;4.&nbsp;The shellcode.</b></p></div><p>The shellcode contains a download routine, which is encrypted using simple XOR. After decryption, it resolves and calls ntdll.URLDownloadToFileA in order to download its payload, save it to a temp file, and run it.</p><p>For more information on the Blackhole exploit kit, please refer to [<span class="citation"><a href="#citation.1">1</a></span>].</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id2759125"></a>Phase 3: Downloader retrieves spam engine</h2></div></div></div><p>The purpose of the downloader installed in Phase 2 is threefold:</p><div class="itemizedlist"><ul type="disc"><li><p>To inject a <span class="emphasis"><em>Windows</em></span> system executable</p></li><li><p>To send logs to the C&amp;C server</p></li><li><p>To download the spam engine (this will be detailed in Phase 4).</p></li></ul></div><p>The downloader in this version has four layers of packing in the following order: UPX, simple XOR, another UPX and then a custom packer. (We have also seen variants of this custom packer being used by other downloaders.) Its first decryption routine is described by the following pseudo code:</p><pre class="programlisting">for(i = length_of_code-1; i&gt;=0; i--;)
{
     code[i] += a_hard_coded_number;
     a_hard_coded_number += modifier;
}
</pre><p>Then it goes into the dynamically allocated memory to start the second decryption routine. The meaningful opcodes are buried amongst many jumps and junk calls.</p><p>Once fully decrypted, the downloader uses the SendMessageCallbackW API to set a callback function, which is the injection routine. IsWow64Process is called to determine which process is to be injected: wuauclt.exe or svchost.exe. In this example [<span class="citation"><a href="#citation.2">2</a></span>], because our test environment is a <span class="emphasis"><em>Windows XP</em></span> 32-bit machine, the target is %System32%\wuauclt.exe [<span class="citation"><a href="#citation.3">3</a></span>].</p><p>The goal of this injection is to map the piece of code shown in <a href="#figure.5">Figure 5</a> into the target process in memory and call it from the entry point of the process.</p><div class="figure"><a id="figure.5"></a><div class="mediaobject"><img alt="Code to be injected is prepared in memory." src="/uploads/images/figures/2012/06/Tan-5.jpg" /></div><p class="title"><b>Figure&nbsp;5.&nbsp;Code to be injected is prepared in memory.</b></p></div><p>The opcode is the stub which will decrypt and execute the encrypted code. During the injection, it sets the environment variable &lsquo;src&rsquo; to be the path of the original downloader file. Later on, it will be used for dropping files and self-deletion.</p><p>The injection method used here is relatively uncommon. It does not employ any memory-writing calls such as WriteProcessMemory or ZwWriteVirtualMemory. Basically, it makes use of multiple ZwMapViewOfSection and ZwUnmapViewOfSection calls to copy the viral code into the memory space of the target process, then it modifies the entry opcode to point to it. The steps in detail are as follows:</p><div class="orderedlist"><ol type="1"><li><p>The addresses of ZwCreateSection, ZwMapViewOfSection and ZwUnmapViewOfSection are resolved from hash codes, each address is decreased by one, then they are stored for future use. Since the byte immediately before the start of these API functions is 0x90 (nop), calling address-1 is the same as calling the API function&rsquo;s address. However, tracers won&rsquo;t notice these APIs being called. So, for example, in <a href="#figure.6">Figure 6</a>, VA:0x7C92D500 [<span class="citation"><a href="#citation.4">4</a></span>] is the address of the ZwMapViewOfSection API, but the address 0x7C92D4FF is stored and called.</p><div class="figure"><a id="figure.6"></a><div class="mediaobject"><img alt="VA:0x7C92D500 is the beginning address of the ZwMapViewOfSection API." src="/uploads/images/figures/2012/06/Tan-6.jpg" /></div><p class="title"><b>Figure&nbsp;6.&nbsp;VA:0x7C92D500 is the beginning address of the ZwMapViewOfSection API.</b></p></div></li><li><p>CreateFileA wuauclt.exe is called with parameter GENERIC_READ, then ReadFile is called but only 0x1000 bytes of the file are read, because initially, the downloader only wants to know the image size. It gets the image size from the PE header. Then it calls VirtualAlloc to allocate a dynamic memory with that size, reads the wuauclt.exe file again, and copies the whole image into the newly allocated memory.</p></li><li><p>The ZwCreateSection API is called, with the MaximumSize parameter set to the total size of the opcode and the encrypted code. Then it calls the ZwMapViewOfSection API with the ProcessHandle parameter set to the current process. This call also gets the base address of this mapped view in memory. To make it simple to remember, let&rsquo;s say it is stored in the baseAddressInject variable. Both the opcode and the encrypted code are copied to the memory space pointed to by baseAddressInject to form the trunk of memory shown in <a href="#figure.5">Figure 5</a>. Then ZwUnmapViewOfSection is called, with the ProcessHandle parameter set to the current process and the BaseAddress set to baseAddressInject. This action will not wipe out the injecting code that was just prepared in memory. The code stays within the memory space of the current process, although no one can view it. This unmapping is a crucial step, because without it, any following ZwMapViewOfSection calls will result in the STATUS_CONFLICTING_ADDRESSES error.</p></li><li><p>As in a common injection routine, a suspended process of wuauclt.exe is created by a CreateProcess call.</p></li><li><p>ZwMapViewOfSection is called, with the SectionHandle parameter set to the section created in step 3, and the ProcessHandle parameter set to process wuauclt.exe. The BaseAddress of this view is stored in a variable. Let&rsquo;s call the variable baseAddressWuauclt. Now the malicious code prepared in step 3 is mapped into the wuauclt.exe process and baseAddressWuauclt points to the beginning of the code in the memory space. <a href="#figure.7">Figure 7</a> shows that the injecting code is now mapped into the memory space of the wuauclt.exe process. Notice that e8 15 00 00 is the operation call to the decryption routine.</p><div class="figure"><a id="figure.7"></a><div class="mediaobject"><img alt="Memory fromBaseAddress 0xA0000 in process wuauclt.exe" src="/uploads/images/figures/2012/06/Tan-7.jpg" /></div><p class="title"><b>Figure&nbsp;7.&nbsp;Memory fromBaseAddress 0xA0000 in process wuauclt.exe</b></p></div></li><li><p>The rest is just about redirecting the wuauclt.exe process to baseAddressWuauclt from the entry point. Another section is created using ZwCreateSection, and ZwMapViewOfSection is called again with the ProcessHandle parameter set to the current process, and the BaseAddress of this view is stored to a variable. Let&rsquo;s name this variable baseAddressInject2. Then GetThreadContext is called to get the thread context of the suspended wuauclt.exe process. The EAX register value (+0xB in CONTEXT structure) is obtained from the context structure, which is the VA of the entry point. Then the ImageBase address of the wuauclt.exe process can be calculated by using this VA minus the entry point raw offset, which can be obtained easily from the PE header.</p></li><li><p>The entire wuauclt.exe image is copied to address baseAddressInject2, which is in the memory space of the current process. Then the downloader goes to baseAddressInject2+offsetToEntryPoint to patch the entry point code to be 68 |baseAddressWuauclt| C3. In assembly code, this is:</p><pre class="programlisting">push  baseAddressWuauclt
retn</pre></li><li><p>ZwUnmapViewOfSection is called with the ProcessHandle parameter set to wuauclt.exe and BaseAddress set to ImageBase, which was obtained in step 6. This action unmaps the original wuauclt.exe image from the wuauclt.exe process.</p></li><li><p>ZwUnmapViewOfSection is called with the ProcessHandle parameter set to the current process and BaseAddress set to baseAddressInject2. This action unmaps the entry-point-modified wuauclt.exe image from the current process.</p></li><li><p>Finally, ZwMapViewOfSection is called with the SectionHandle parameter set to the section created in step 6, ProcessHandle set to wuauclt.exe and BaseAddress set to <span class="emphasis"><em>baseAddressInject2</em></span>. This action swaps the modified wuauclt.exe image to the suspended wuauclt.exe process. A ResumeThread call will run the injected process from the patched entry point.</p></li></ol></div><p>All of the effort described above is just for injecting a little DLL into a system process. Let&rsquo;s have a look at what this downloader&rsquo;s payload is.</p><p>As usual, it begins with collecting information about the infected PC. It gets VolumeSerialNumber and uses it as MutexName. Using the &lsquo;src&rsquo; environment variable, it drops itself to a %Temp%\ directory with a random name generated using GetTickCount&rsquo;s return value as seeds. It then deletes the original and creates an auto run entry in the registry.</p><p>Next, it prepares a message which will be sent to the C&amp;C server in the following format:</p><p>id:%lu|bid:%lu|bv:%lu|sv:%lu|la:%lu</p><div class="itemizedlist"><ul type="disc"><li><p>&lsquo;id&rsquo; is the VolumeSerialNumber, which is also used as an encryption key in communications.</p></li><li><p>&lsquo;bid&rsquo; is some counter for the communication, starting from one.</p></li><li><p>&lsquo;bv&rsquo; is probably the build version of this downloader, hard coded.</p></li><li><p>&lsquo;sv&rsquo; is the current OS version, calculated from GetVersionEx call ouputs with the format: MajorVersion&lt;&lt;8 + MinorVersion.</p></li><li><p>&lsquo;la&rsquo; is the SocketName, byte swapped.</p></li></ul></div><p>The message will be encrypted before sending. <a href="#figure.8">Figure 8</a> shows the hard-coded pre-key used by the first encryption layer. It is probably a hash code of a string. In some older versions, the pre-key was &lsquo;blablablaandromeda&rsquo;, which is where the botnet&rsquo;s name came from. Moreover, the C&amp;C servers use fast-flux techniques to switch their IP from time to time.</p><div class="figure"><a id="figure.8"></a><div class="mediaobject"><img alt="Pre-key highlighted." src="/uploads/images/figures/2012/06/Tan-8.jpg" /></div><p class="title"><b>Figure&nbsp;8.&nbsp;Pre-key highlighted.</b></p></div><p>The first encryption layer is RC4 with the key-scheduling algorithm obfuscated. <a href="#figure.9">Figure 9</a> shows the early stage of the key-scheduling algorithm (KSA). As you can see in the first loop, it initializes the array &lsquo;S&rsquo; backwards.</p><div class="figure"><a id="figure.9"></a><div class="mediaobject"><img alt="A piece of KSA in RC4." src="/uploads/images/figures/2012/06/Tan-9.jpg" /></div><p class="title"><b>Figure&nbsp;9.&nbsp;A piece of KSA in RC4.</b></p></div><p>The second encryption layer uses the CryptBinaryToString function to encode the hex value to a base64 string, so that it can be transferred as part of the HTTP Get message body. It tries to send the encrypted message to three different URLs. These URLs are hard-coded in the DLL body, as shown in <a href="#figure.10">Figure 10</a>.</p><div class="figure"><a id="figure.10"></a><div class="mediaobject"><img alt="Hard-coded URLs." src="/uploads/images/figures/2012/06/Tan-10.jpg" /></div><p class="title"><b>Figure&nbsp;10.&nbsp;Hard-coded URLs.</b></p></div><p>It waits until any of the above servers replies. The first four bytes of the response message are the checksum of the decrypted message. The decryption uses RC4 again with the VolumeSerialNumber as pre-key. Then there is a function to calculate the checksum of the decrypted message and compare it with the one sent by the server.</p><p>After decryption, one kind of response is shown in <a href="#figure.11">Figure 11</a>.</p><div class="figure"><a id="figure.11"></a><div class="mediaobject"><img alt="C&amp;C server command, decrypted." src="/uploads/images/figures/2012/06/Tan-11.jpg" /></div><p class="title"><b>Figure&nbsp;11.&nbsp;C&amp;C server command, decrypted.</b></p></div><p>The first dword (0x0000 0009) is used as a multiplier to a hard-coded number to get the new time interval for this communication thread. The following byte (0x01) decides which task the downloader is going to perform. The tasks are:</p><div class="itemizedlist"><ul type="disc"><li><p>(1) download and execute</p></li><li><p>(2) redirect to another C&amp;C server</p></li><li><p>(3) download, execute and modify registry</p></li><li><p>(4) modify registry.</p></li></ul></div><p>It will send a log report to the C&amp;C server after whichever job is done. Task (1) is the main purpose of this downloader, to download and run the spam engine.</p><p>Once a task is completed, a string is created with the format: &lsquo;id:%lu|tid:%lu|result:%lu&rsquo;. The string is encrypted with RC4 using the pre-key shown in <a href="#figure.8">Figure 8</a>. The &lsquo;id&rsquo; is the VolumeSerialNumber; the &lsquo;tid&rsquo; is the last dword (0x0000 0009) before the URL in <a href="#figure.11">Figure 11</a>, which is probably the version of the downloaded file; and the &lsquo;result&rsquo; is the Thread Handle number of the downloaded and executed file, if there is one.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id2763666"></a>Phase 4: Spam engine</h2></div></div></div><p>Besides sending spam, the spam engine also has the ability to search the victim&rsquo;s computer and harvest various files containing profile information. The applications it targets in this example [<span class="citation"><a href="#citation.5">5</a></span>] include:</p><div class="itemizedlist"><ul type="disc"><li><p><span class="emphasis"><em>The Bat! </em></span>email client</p></li><li><p><span class="emphasis"><em>ICQ</em></span></p></li><li><p><span class="emphasis"><em>Miranda</em></span></p></li><li><p><span class="emphasis"><em>RQ</em></span></p></li><li><p><span class="emphasis"><em>Trillian</em></span></p></li><li><p><span class="emphasis"><em>Ghisler Total Commander</em></span></p></li><li><p><span class="emphasis"><em>RimArts</em></span> email client</p></li><li><p><span class="emphasis"><em>MS Outlook</em></span></p></li><li><p><span class="emphasis"><em>CuteFTP</em></span></p></li><li><p><span class="emphasis"><em>Edailer</em></span></p></li><li><p><span class="emphasis"><em>Far Manager</em></span></p></li><li><p><span class="emphasis"><em>WS_FTP</em></span></p></li><li><p><span class="emphasis"><em>Opera</em></span></p></li><li><p><span class="emphasis"><em>Mozilla</em></span> applications</p></li></ul></div><p>Most of these applications are either FTP or email clients. The more FTP accounts stolen, the more websites can be compromised. And the more email contacts and accounts are stolen, the more sophisticated the spam email can be made. Therefore, the information it harvests in this phase is intended to facilitate the botnet&rsquo;s propagation (see Phase 1).</p><p>Another payload in this phase concerns spamming. At first, the spam engine drops itself to %Application Data%\firewall\system.exe and a configuration file to %System%\dbs.dat. The configuration file mainly stores the encrypted C&amp;C server addresses.</p><p>Initially, after installing itself on the victim&rsquo;s PC, the spam engine will try to contact the C&amp;C server. <a href="#figure.12">Figure 12</a> shows an example of the communication. The host and the Get requests are hard-coded in the engine&rsquo;s body. The message received is encrypted with two layers.</p><div class="figure"><a id="figure.12"></a><div class="mediaobject"><img alt="Initial communication." src="/uploads/images/figures/2012/06/Tan-12.jpg" /></div><p class="title"><b>Figure&nbsp;12.&nbsp;Initial communication.</b></p></div><p>The first encryption layer is a custom RC4 without the KSA. The key is already pre-scheduled and stored in the engine&rsquo;s body. The intention behind this may be to conceal the encryption algorithm and perhaps to gain a little improvement in performance. The second encryption layer is a side-by-side byte-XOR, starting from the bottom of the code, and then the first code XOR with 0xFF.</p><p>After decryption, we can see that the message is a table containing URLs of the backup C&amp;C servers and spam template servers. The dword value circled in red specifies the server type (0xE0 means the C&amp;C server and 0xE2 means the spam template server), followed by one byte specifying the URL length and the URL itself. These pieces of information will be encrypted and stored in the configuration file dbs.dat for future use.</p><div class="figure"><a id="figure.13"></a><div class="mediaobject"><img alt="C&amp;C response decrypted." src="/uploads/images/figures/2012/06/Tan-13.jpg" /></div><p class="title"><b>Figure&nbsp;13.&nbsp;C&amp;C response decrypted.</b></p></div><p>The next task is to send the stolen information to the C&amp;C servers. The stolen information is encrypted using the same method as above, and the malware tries to send it to the servers from the list received in the previous communication.</p><p>Then it sends a request to the spam template servers to obtain the latest spam template. The message received is also encrypted by the same method. <a href="#figure.14">Figure 14</a> shows part of the decrypted email template.</p><div class="figure"><a id="figure.14"></a><div class="mediaobject"><img alt="Part of the email template." src="/uploads/images/figures/2012/06/Tan-14.jpg" /></div><p class="title"><b>Figure&nbsp;14.&nbsp;Part of the email template.</b></p></div><p>The template file size is about 70KB, and it contains two email templates. One uses <span class="emphasis"><em>The Bat!</em></span> (the full format is: &lsquo;The Bat! (v4.%RND_DIGIT.%RND_DIGIT[2]) UNREG&rsquo;, with the percentage sign and capitals together being random variables) as the X-Mailer string, and the other uses <span class="emphasis"><em>Microsoft Outlook Express 6.00.2800.1106</em></span>. The email template can be used to compose both the SMTP header and the message body. There is also a large database of words, domains, people&rsquo;s names, mail servers, compromised website URLs and email addresses for the spammer to choose randomly to fill in the variables in the templates.</p><p>The email addresses are probably contacts harvested by the spammers. The chances that they are active email addresses are very high, therefore they can be used as either the senders or the receivers. The templates from the samples we looked at could compose deceptive emails about e-greeting cards or free porn videos, or advertisement emails for dating site registrations (for advertisement purposes, the dating site itself was legitimate and harmless). Thanks to this flexibility, the content of the spam messages can be crafted to be very up to date. For example, in mid-December 2011, it would be very tempting for many users to open an email that appeared to contain a link to a secret video of Muammar Gaddafi&rsquo;s death.</p><p>After creating each email with both the SMTP header and the message body, the spamming engine tries to send it by using the standard SMTP protocol.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4787701"></a>Conclusion</h2></div></div></div><p>The Andromeda botnet recruits its bots thanks to four key elements: compromised websites, an exploit kit, a downloader and a mailing engine. These are linked by four phases, occurring sequentially. The final phase not only ties back to the first, but also facilitates it by stealing user information such as email contacts, messenger accounts and FTP accounts.</p><p>At the time of writing this paper, the mailing engine was only spamming emails advertising a legitimate dating website &ndash; suggesting that the botnet had suspended the active recruitment of more bots. The downloaders were only downloading the mailing engines. However, it still has the capacity to download and run arbitrary files &ndash; which may be even more harmful and harder to detect.</p><p>Because the four phases occur sequentially, breaking any phase can break the circle. The weakest link may be the first phase. Being careful to avoid opening suspicious emails and using up-to-date web browsers should keep most users safely out of the reach of Andromeda&rsquo;s chains.</p><div class="bibliography"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3782994"></a>Bibliography</h3></div></div></div><div class="bibliomixed"><a id="citation.1"></a><p class="bibliomixed">[1] Howard, F. Exploring the Blackhole Exploit Kit. Sophos Naked Security blog. <span class="bibliosource"><a href="https://nakedsecurity.sophos.com/exploring-the-blackhole-exploit-kit/" target="_blank">http://nakedsecurity.sophos.com/exploring-the-blackhole-exploit-kit/</a></span>.</p></div><div class="bibliomixed"><a id="citation.2"></a><p class="bibliomixed">[2] Unless otherwise specified, our analysis of the downloader is based on a sample with md5: ce7b86a201f32b115577551c61a28508.</p></div><div class="bibliomixed"><a id="citation.3"></a><p class="bibliomixed">[3] In Windows XP, the default full path of the file is C:\Windows\System32\wuauclt.exe.</p></div><div class="bibliomixed"><a id="citation.4"></a><p class="bibliomixed">[4] VA: virtual address.</p></div><div class="bibliomixed"><a id="citation.5"></a><p class="bibliomixed">[5] Sample md5: 1a4f7f5205c2fa133131f6f57df6f40b.</p></div></div></div> </div>
<div class="col-md-3 col-sm-3 col-lg-3">
<div id="NDPHPBlock13359" class="NDPHPBlock">
<div style="width: 100%;"><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Tweet this!' href="https://twitter.com/share?text=Andromeda botnet&url=https://www.virusbulletin.com/virusbulletin/2012/06/andromeda-botnet"><img src='/uploads/images/buttons/twitter.png' alt='twitter.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on Facebook' href='https://www.facebook.com/sharer.php?u=https://www.virusbulletin.com/virusbulletin/2012/06/andromeda-botnet'><img src='/uploads/images/buttons/fb.png' alt='fb.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on LinkedIn' href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.virusbulletin.com/virusbulletin/2012/06/andromeda-botnet&title=Andromeda botnet"><img src='/uploads/images/buttons/linkedin.png' alt='linkedin.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on Hacker News' href="https://news.ycombinator.com/submitlink?u=https://www.virusbulletin.com/virusbulletin/2012/06/andromeda-botnet&t=Andromeda botnet"><img src='/uploads/images/buttons/hackernews.png' alt='hackernews.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='reddit this!' href="https://www.reddit.com/submit?url=https://www.virusbulletin.com/virusbulletin/2012/06/andromeda-botnet"><img src='/uploads/images/buttons/reddit.png' alt='reddit.png' width='45' height='45' class='responsive' /></a></center></div></div></div><p> </p>
<h2>Latest articles:</h2>
<div class="ccm-page-list">
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2022/04/cryptojacking-fly-teamtnt-using-nvidia-drivers-mine-cryptocurrency/" target="_self">Cryptojacking on the fly: TeamTNT using NVIDIA drivers to mine cryptocurrency</a>
</h3>
<div class="ccm-page-list-description">
TeamTNT is known for attacking insecure and vulnerable Kubernetes deployments in order to infiltrate organizations&rsquo; dedicated environments and transform them into attack launchpads. In this article Aditya Sood presents a new module introduced by&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/12/collector-stealer-russian-origin-credential-and-information-extractor/" target="_self">Collector-stealer: a Russian origin credential and information extractor</a>
</h3>
<div class="ccm-page-list-description">
Collector-stealer, a piece of malware of Russian origin, is heavily used on the Internet to exfiltrate sensitive data from end-user systems and store it in its C&amp;C panels. In this article, researchers Aditya K Sood and Rohit Chaturvedi present a 360&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/06/fighting-fire-fire/" target="_self">Fighting Fire with Fire</a>
</h3>
<div class="ccm-page-list-description">
In 1989, Joe Wells encountered his first virus: Jerusalem. He disassembled the virus, and from that moment onward, was intrigued by the properties of these small pieces of self-replicating code. Joe Wells was an expert on computer viruses, was partly&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/04/run-your-malicious-vba-macros-anywhere/" target="_self">Run your malicious VBA macros anywhere!</a>
</h3>
<div class="ccm-page-list-description">
Kurt Natvig wanted to understand whether it&rsquo;s possible to recompile VBA macros to another language, which could then easily be &lsquo;run&rsquo; on any gateway, thus revealing a sample&rsquo;s true nature in a safe manner. In this article he explains how he recompiled&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/04/dissecting-design-and-vulnerabilities-azorultccpanels/" target="_self">Dissecting the design and vulnerabilities in AZORult&nbsp;C&amp;C&nbsp;panels</a>
</h3>
<div class="ccm-page-list-description">
Aditya K Sood looks at the command-and-control (C&amp;C) design of the AZORult malware, discussing his team's findings related to the C&amp;C design and some security issues they identified during the research. </div>
</div>
<p><br /><a class="btn btn-block btn-warning" href="/virusbulletin/archive">Bulletin Archive</a></p> </div>
</div>
</div>

<footer class="bs-footer" role="contentinfo">
<div class="container">
<div class="bs-social">
<div class="row ">
<div class="col-md-3">
<p><a title="About Us" href="/about-vb/about-us/">About us</a></p>
<p><a title="Contact Us" href="/about-vb/contact-us/">Contact us</a></p>
<p><a title="Advisory Board" href="/about-vb/advisory-board/">Advisory board</a></p>
<p><a title="Press" href="/about-vb/press/">Press information</a></p>
<p><a title="Security Events Calendar" href="/resources/calendar/">Security events calendar</a></p>
<p><a title="Newsletter" href="/newsletter/">Virus Bulletin newsletter</a></p> </div>
<div class="col-md-3">
<p><a title="VB Testing" href="/testing/">Testing</a></p>
<p><a title="VB100" href="/testing/vb1001/">VB100</a></p>
<p><a title="VBSpam" href="/testing/vbspam/">VBSpam</a></p>
<p><a title="VBWeb" href="/testing/vbweb/">VBWeb</a></p>
<p><a title="Consultancy Services" href="/testing/consultancy-services/">Consultancy services</a></p>
<p><a title="The Spammers' Compendium" href="/resources/spammerscompendium/">Spammers' Compendium</a></p> </div>
<div class="col-md-3">
<p><a title="VB2021 localhost" href="/conference/vb2021/">VB2021 localhost</a></p>
<p><a title="VB2020 localhost" href="/conference/vb2020/">VB2020 localhost</a></p>
<p><a title="VB2019" href="/conference/vb2019/">VB2019 (London)</a></p>
<p><a title="VB2018" href="/conference/vb2018">VB2018 (Montreal)</a></p>
<p><a title="VB2017" href="/conference/vb2017">VB2017 (Madrid)</a></p>
<p><a title="Conference Archive" href="/conference/vb-conference-archive/">Older conferences</a></p> </div>
<div class="col-md-3">
<div class="row">
<table style="float: right;" border="0">
<tbody>
<tr>
<td align="center"><a href="/rss" target="_blank"><img title="Get our blog updates" src="/uploads/images/buttons/rss-square-gray.png" alt="rss.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://twitter.com/virusbtn" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on Twitter" src="/uploads/images/buttons/twitter-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.linkedin.com/company/virus-bulletin" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on LinkedIn" src="/uploads/images/buttons/linkedin-square-gray.png" alt="linkedin.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.facebook.com/virusbulletin" target="_blank"><img title="Visit us on Facebook" src="/uploads/images/buttons/fb-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.youtube.com/user/virusbtn" target="_blank"><img title="Visit us on Youtube" src="/uploads/images/buttons/youtube-square-gray.png" alt="youtube.png" width="35" height="35" /></a></td>
</tr>
</tbody>
</table>
</div> </div>
</div>
<div class="row ">
<div class="col-md-12">
</div>
</div>
</div>
</div>
</footer>

<footer class="bs-footer2" role="contentinfo">
<div class="container">
<div class="bs-social2">
<div class="row ">
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
</div>
<div class="row ">
<div class="col-md-12">
<p style="text-align: left;">©1989-2022 Virus Bulletin.        <a title="Privacy Policy" href="/about-vb/privacy-policy/">Privacy policy</a>        <a title="Cookies" href="/about-vb/privacy-policy/cookies/">Cookies</a>        <a title="Terms and Conditions" href="/about-vb/terms-and-conditions/">Terms and Conditions</a></p> </div>
</div>
</div>
</div>
</footer>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-21876594-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-21876594-2', { 'anonymize_ip': true });
</script><script type="text/javascript" src="/libraries/js/fancybox.load.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/app.js"></script>
<div id="ccm-cookiesDisclosure" class="disclosure-bottom">
<div class="disclosure-container">
<div class="disclosure-content">
<p> We have placed cookies on your device in order to improve the functionality of this site, as outlined in our <a href="/about-vb/privacy-policy/cookies" target="_blank">cookies policy</a>. However, you may delete and block all cookies from this site and your use of the site will be unaffected. By continuing to browse this site, you are agreeing to Virus Bulletin's use of data as outlined in our <a href="/about-vb/privacy-policy/" target="_blank">privacy policy</a>.</p>
</div>
<div class="disclosure-form">
<form action="/index.php/cookies_disclosure/" method="POST">
<input type="hidden" name="allowCookies" value="1" />
<div class="button">
<input class="btn btn-info btn-sm" type="submit" name="submit" value="I understand. Don't show this message again!" />
</div>
</form>
</div>
<div class="ccm-spacer">&nbsp;</div>
</div>
</div>
</body>
</html>