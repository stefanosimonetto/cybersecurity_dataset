<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<script type="text/javascript">var BOOTSTRAP_VERSION ="lumen";
	var BOOTSTRAP_JS_HEAD =1;
	var BOOTSTRAP_CDN_ENABLE =0; var BOOTSTRAP_NAVBAR_TYPE =0; var BOOTSTRAP_LOGO_OPTION =0; var BOOTSTRAP_NAVBAR =1; var BootstrapInputFix =true;var BootstrapNavbarLineHeightFix =true;var BOOTSTRAP_EDT= 0; </script>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>Virus Bulletin :: VB2014 paper: Using DMARC to improve your email reputation</title>
<meta name="description" content="In 2012, the world of email filtering created a new tool to combat spam and phishing: DMARC - a technology that is designed to prevent spammers from forging the sender. DMARC has its upsides, but it also has some drawbacks. In his VB2014 paper, Terry Zink discusses the advantages and drawbacks of DMARC, as well as the process that Microsoft went through to catalogue all of its domains in order to ensure that all of them could pass basic authentication checks." />
<meta name="generator" content="concrete5 - 5.6.3.5" />
<script type="text/javascript">
var CCM_DISPATCHER_FILENAME = '/index.php';var CCM_CID = 1744;var CCM_EDIT_MODE = false;var CCM_ARRANGE_MODE = false;var CCM_IMAGE_PATH = "/concrete/images";
var CCM_TOOLS_PATH = "/index.php/tools/required";
var CCM_BASE_URL = "https://www.virusbulletin.com";
var CCM_REL = "";

</script>
<link rel="shortcut icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
<link rel="icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
<link rel="stylesheet" type="text/css" href="/concrete/css/ccm.base.css" />
<script type="text/javascript" src="/concrete/js/jquery.js"></script>
<script type="text/javascript" src="/concrete/js/ccm.base.js"></script>
<script type="text/javascript">
var COOKIES_ALLOWED=false;
</script>
<link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure.css" />
<!--[if lte IE 8]><link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure_ie.css" /><![endif]-->
<script type="text/javascript">
var COOKIES_DISCLOSURE_HIDE_INTERVAL=10;
</script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_hide.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap-overwrites.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/members.css" />
<script type="text/javascript" src="/packages/bootstrap/js/common/prettify.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/jquery.easing.1.3.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="/libraries/css/jquery.fancybox.css" />
<script type="text/javascript" src="/libraries/js/jquery.fancybox.pack.js"></script>
<link rel="stylesheet" media="screen" type="text/css" href="/files/cache/css/bootstrap/typography.css" />
<script type="text/javascript" src="/index.php/tools/packages/free_cookies_disclosure/disclosure_i18n_js"></script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_ajax_form.js"></script>
<link rel="stylesheet" type="text/css" href="/concrete/blocks/page_list/view.css" />
<link rel="stylesheet" type="text/css" href="/packages/remo_expand/blocks/remo_expand/templates/vbexpand/view.css" />
<script type="text/javascript" src="/packages/remo_expand/js/jquery.color.js"></script>
<script type="text/javascript" src="/packages/remo_expand/js/jquery.ba-hashchange.js"></script>
<script type="text/javascript" src="/packages/remo_expand/js/remo.expand.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/blocks/search/templates/VB_global_search/view.css" />
<link rel="stylesheet" type="text/css" href="/packages/travisn_spacer/css/ccm.tnspacer.css" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.js" integrity="sha256-1SFdTXlsw0RkQ+iO0E91LDshGiIbPiTYqJto0px4wds=" crossorigin="anonymous"></script>
<!--[if gte IE 9]>
<script src="/packages/bootstrap/js/common/modernizr.js"></script>
<![endif]-->

<!--[if lt IE 9]>	
	
	<script src="/packages/bootstrap/js/common/html5shiv.js"></script>
	<script src="/packages/bootstrap/js/common/respond.min.js"></script>
	
<![endif]-->
</head>
<body data-spy="scroll" data-target=".bs-sidebar">

<div class="navbar  navbar-fixed-top navbar-default  bs-docs-nav">
<div class="navbar-inner">
<div class="container"><div class="row"><div class="col-sm-4 col-md-4 logo-position-1 col-logo">
<div class="navbar-header">
<button type="button" class="navbar-toggle btn_navbar_custom">
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button><div class="mobile-clearfix"></div><div class="navbar-brand navbar-brand-area"><a href="/"><img border="0" class="ccm-image-block" alt="" src="/files/4614/4535/7515/logo-big.png" width="339" height="92" /></a></div> </div>
</div><div class="col-sm-8 col-md-8 logo-position-1 col-nav"> <div class="nav-collapse collapse nav_collapse_custom navbar-collapse"> <div style="clear:both"></div>
<div class="vb-global-search-div">
<form action="/index.php/global-search-results/" method="get">
<fieldset>
<input name="search_paths[]" type="hidden" value="" />
<input name="query" type="text" class="vb-global-search" placeholder="Search site..." />
<input name="submit" type="submit" value="Search!" style="display:none" />
</fieldset>
</form>
</div>
<div class="tnSpacer" style="height:48px"></div>
<ul class="nav nav-pills"><li class=" nav-first nav-item-6299"><a href="/newsletter/" target="_self" class=" nav-first nav-item-6299 ">Newsletter</a></li><li class=" nav-item-260"><a href="/conference/" target="_self" class=" nav-item-260 ">VB Conference</a></li><li class=" nav-item-166"><a href="/testing/" target="_self" class=" nav-item-166 ">VB Testing</a></li><li class=" nav-path-selected active nav-item-160"><a href="/virusbulletin/" target="_self" class=" nav-path-selected active nav-item-160 ">Bulletin</a></li><li class=" nav-last nav-item-130"><a href="/blog/" target="_self" class=" nav-last nav-item-130 ">Blog</a></li></ul> </div>
</div>
</div><div class="clearfix"></div>
</div>
</div>
</div>
<div class="navbar-top-fixed-space "><div class="clearfix"></div></div>

<div class="container m-top-20">
<div class="row">
<div class="col-md-9 col-sm-9 col-lg-9">
<div class="titlepage" xmlns=""><div><div><h1 class="title" xmlns="http://www.w3.org/1999/xhtml"><a id="vb201411-DMARC"></a>VB2014 paper: Using DMARC to improve your email reputation</h1></div><div><p class="pubdate" xmlns="http://www.w3.org/1999/xhtml">2014-11-06</p></div><div><div class="authorgroup" xmlns="http://www.w3.org/1999/xhtml"><div class="author titlepage"><h3 class="author"><span class="firstname">Terry</span> <span class="surname">Zink</span></h3><span class="orgname">Microsoft</span>, <span class="orgdiv">USA</span></div><b class="editedby">Editor: </b><span class="editor"><span class="firstname">Martijn</span> <span class="surname">Grooten</span></span></div></div><div><div class="abstract" xmlns="http://www.w3.org/1999/xhtml"><p class="title"><b>Abstract</b></p><p>In 2012, the world of email filtering created a new tool to combat spam and phishing: DMARC - a technology that is designed to prevent spammers from forging the sender. DMARC has its upsides, but it also has some drawbacks. In his VB2014 paper, Terry Zink discusses the advantages and drawbacks of DMARC, as well as the process that Microsoft went through to catalogue all of its domains in order to ensure that all of them could pass basic authentication checks. </p></div></div><div><p class="copyright" xmlns="http://www.w3.org/1999/xhtml"><i>Copyright &copy; 2014 Virus Bulletin</i></p></div></div><hr /></div>
<div class="ccm-remo-expand">
<div id="ccm-remo-expand-title-2709" class="ccm-remo-expand-title ccm-remo-expand-closed" data-expander-speed="200">Table of contents</div><div id="ccm-remo-expand-content-2709" class="ccm-remo-expand-content"><div class="toc"><dl><dt><span class="sect1"><a href="#id3229757">Abstract</a></span></dt><dt><span class="sect1"><a href="#id3868868">1. Background</a></span></dt><dd><dl><dt><span class="sect2"><a href="#id3459947">1.1 Terminology</a></span></dt><dt><span class="sect2"><a href="#id3373307">1.2 Sender Policy Framework &ndash; SPF</a></span></dt><dt><span class="sect2"><a href="#id3540382">1.3 DomainKeys Identified Mail &ndash; DKIM</a></span></dt></dl></dd><dt><span class="sect1"><a href="#id3590347">2. WHAT IS DMARC?</a></span></dt><dd><dl><dt><span class="sect2"><a href="#id3488214">2.1 Weaknesses of SPF and DKIM</a></span></dt></dl></dd><dt><span class="sect1"><a href="#id3694617">3. Benefits of DMARC</a></span></dt><dd><dl><dt><span class="sect2"><a href="#id2615986">3.1 Decreasing phishing</a></span></dt><dt><span class="sect2"><a href="#id4208422">3.2 Detect misconfigurations</a></span></dt><dt><span class="sect2"><a href="#id4595863">3.3 Inventory third-party mailers</a></span></dt></dl></dd><dt><span class="sect1"><a href="#id4113730">4. Drawbacks of DMARC</a></span></dt><dd><dl><dt><span class="sect2"><a href="#id3661292">4.1 Homoglyph attacks</a></span></dt><dt><span class="sect2"><a href="#id4447990">4.2 Mailing lists</a></span></dt><dt><span class="sect2"><a href="#id2954018">4.3 Workarounds</a></span></dt></dl></dd><dt><span class="sect1"><a href="#id4377703">5. Case study: Microsoft</a></span></dt><dd><dl><dt><span class="sect2"><a href="#id3910733">5.1 The problem</a></span></dt><dt><span class="sect2"><a href="#id3635847">5.2 Working towards authentication</a></span></dt></dl></dd><dt><span class="sect1"><a href="#id4027667">Conclusion</a></span></dt></dl></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3229757"></a>Abstract</h2></div></div></div><p>In 2012, the world of email filtering created a new tool to combat spam and phishing: DMARC [<span class="citation"><a href="#citation.1">1</a></span>], [<span class="citation"><a href="#citation.2">2</a></span>]. DMARC, or Domain-based Message Authentication, Reporting &amp; Conformance, is a technology that is designed to prevent spammers from forging the sender, thus making brands more resistant to abuse. However, its most powerful feature is the built-in reporting mechanism that lets brand owners know they are being spoofed. </p><p>DMARC has its upsides, and it is very useful for preventing spoofing, but it also has some drawbacks &ndash; it will flag some legitimate email as spam, and it will cause some short-term pain. </p><p>In addition, DMARC is difficult to set up for a large organization with a decentralized email infrastructure. Many divisions do not have email expertise, but they still need their email delivered. </p><p>This article discusses the advantages and drawbacks of DMARC. It also discusses the process that <span class="emphasis"><em>Microsoft</em></span> went through to catalogue all of its domains in order to ensure that all of them could pass basic authentication checks. This involved creating DMARC records, sorting through legitimate and malicious sources of spoofed email, and working with teams to ensure that they could authenticate in the future.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3868868"></a>1. Background</h2></div></div></div><p>People who are new to email security are often surprised to see just how insecure email actually is. When shown how easy it is to spoof a message, they are taken aback. Most people assume that you have to login and enter your username and password in order to send a message. This is not so; sending an email is as simple as connecting to a mail server using the SMTP protocol and transmitting a message. Furthermore, anyone can put anything as the From: address of the message. There is nothing to prevent a sender from doing this. </p><p><a href="#figure.1">Figure 1</a> and<a href="#figure.2">Figure 2</a> are both messages I received &lsquo;from&rsquo; <span class="emphasis"><em>PayPal</em></span> during the past three months. Which one is real and which one was faked? </p><div class="figure"><a id="figure.1"></a><div class="mediaobject"><img alt="Is this a real message from PayPal about my recent purchase of magic supplies?" src="/uploads/images/figures/2014/11/Zink-1.jpg" /></div><p class="title"><b>Figure&nbsp;1.&nbsp;Is this a real message from PayPal about my recent purchase of magic supplies?</b></p></div><div class="figure"><a id="figure.2"></a><div class="mediaobject"><img alt="Is this a real message from PayPal letting me know that my credit card will expire soon?" src="/uploads/images/figures/2014/11/Zink-2.jpg" /></div><p class="title"><b>Figure&nbsp;2.&nbsp;Is this a real message from PayPal letting me know that my credit card will expire soon? </b></p></div><p>As an end-user, it is great that I can use online payment systems, but when spammers figured out that they could put a trusted brand into the From: address of an email, they discovered that users would believe that the email really came from that organization. Over the past decade, the email security industry has come up with ways to mitigate this problem using two primary technologies. </p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3459947"></a>1.1 Terminology</h3></div></div></div><p>In email, people naturally thing that the sender of the message is the one in the From: field &ndash; the one that they see in their email client. For example, suppose that you are a travel enthusiast and you receive the email shown in <a href="#figure.3">Figure 3</a>. You received the message &lsquo;from&rsquo; <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2649454347484f4566484351550849454347484f45474f544a4f4843550845494b">[email&#160;protected]</a>, right? Wrong. </p><div class="figure"><a id="figure.3"></a><div class="mediaobject"><img alt="An example email with two different &lsquo;From&rsquo; addresses." src="/uploads/images/figures/2014/11/Zink-3.jpg" /></div><p class="title"><b>Figure&nbsp;3.&nbsp;An example email with two different &lsquo;From&rsquo; addresses.</b></p></div><p>In email, there are two &lsquo;From&rsquo; addresses: </p><div class="orderedlist"><ol type="1"><li><p>The SMTP MAIL FROM, otherwise known as the RFC 5321.MailFrom [<span class="citation"><a href="#citation.3">3</a></span>]. This is the email address to which the bounced message will be delivered if the message cannot be delivered. It is this email address that goes into the Return-Path in the message headers.</p></li><li><p>The From: address in the message headers, otherwise known as the RFC 5322.From. This is the email address that is displayed in the email client.</p></li></ol></div><p>Much of the time, the 5321.MailFrom and 5322.From addresses are the same. This is typical for person-to-person communication and is what people usually want to add safe senders for. However, when email is sent on behalf of someone else, the two &lsquo;From&rsquo; addresses are frequently different. This happens most often for bulk email. </p><p>In the email example shown in <a href="#figure.3">Figure 3</a>, the sender (From: address) is <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="91fef2f4f0fff8f2d1fff4e6e2bffef2f4f0fff8f2f0f8e3fdf8fff4e2bff2fefcbf">[email&#160;protected]</a> However, Oceanic Airlines has contracted Big Communications, Inc. to send out bulk email on its behalf. The 5321.MailFrom is <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3053515d405159575e1d000105020102011d5f5355515e59531e5159425c595e554370525957535f5d5d455e59535144595f5e431e535f5d">[email&#160;protected]</a>, and that is the address to which email bounces are delivered for email campaign tracking. However, to the end-user, the message appears to have come &lsquo;from&rsquo; Oceanic Airlines, because that&rsquo;s what they see in their email client. </p><p>This difference between the 5321.MailFrom and 5322.From addresses is important! </p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3373307"></a>1.2 Sender Policy Framework &ndash; SPF</h3></div></div></div><p>SPF is a technology that identifies the path that a message took to get to you, and whether or not that path was authorized. </p><p>Domains publish a set of IPs in their SPF records. If email comes from a domain in the 5321.MailFrom, an email receiver looks up the SPF record for that domain. It then asks the question &lsquo;Does the IP from which this email came match any of the IPs in the SPF record?&rsquo; If it does, the message passes SPF. If it does not, SPF allows the domain owner to specify what to do with the message: hard fail, -all (give it a heavy weight in the spam filter); soft fail, ~all (give it a light weight in the spam filter); or neutral, ?all (treat it as if it had no SPF record). </p><p>Suppose we had the following SPF record: </p><pre class="programlisting">contoso.com.  IN  TXT &ldquo;v=spf1 ip4:1.2.3.4 -all&rdquo;</pre><p>If fabrikam.net ever gets an email from contoso.com from the IP 1.2.3.4, it passes SPF and authenticates. </p><p>However, if fabrikam.net receives an email from contoso.com (in the 5321.MailFrom) from the IP 5.6.7.8, it can see that the IP is not included in contoso.com&rsquo;s SPF record. Fabrikam sees that the SPF policy is &lsquo;hard fail&rsquo;, so it can give it a heavy weight and mark it as spam for the recipient. </p><div class="figure"><a id="figure.4"></a><div class="mediaobject"><img alt="How SPF works." src="/uploads/images/figures/2014/11/Zink-4.jpg" /></div><p class="title"><b>Figure&nbsp;4.&nbsp;How SPF works.</b></p></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3540382"></a>1.3 DomainKeys Identified Mail &ndash; DKIM</h3></div></div></div><p>DKIM does not rely upon the path of the message and instead relies upon properties of the message itself. DKIM requires the generation of two encryption keys: a public key which is published in a domain&rsquo;s DNS record, and a corresponding private key. It creates a digital signature which is derived from the message contents and encrypted with the private key using public key encryption. It then transmits the digital signature along with the email message. The message signer tells the receiver where to look up the public key by stamping it into the d= field in the DKIM-Signature header in the message. </p><p>The receiver gets the message and extracts the digital signature. He then checks the sender&rsquo;s domain in the d= field in the DKIM-Signature header and looks up the public key for that domain in DNS, performing a DNS lookup. Finally, he validates the signature using the public key. If it checks out, he knows that the message really came from the sender. </p><div class="figure"><a id="figure.5"></a><div class="mediaobject"><img alt="How DKIM works." src="/uploads/images/figures/2014/11/Zink-5.jpg" /></div><p class="title"><b>Figure&nbsp;5.&nbsp;How DKIM works.</b></p></div><p>Comparing DKIM with SPF, DKIM offers the following advantages: </p><div class="orderedlist"><ol type="1"><li><p>Security: A spammer cannot spoof the message because he does not have access to the private key with which the sender signed the message. Without the private key, the public key is useless. </p></li><li><p>Does not break email forwarding: Because DKIM does not rely on the sending IP and only on the email content, email can be forwarded without affecting the DKIM validation as long as the message is not modified. </p></li><li><p>Anti-tampering: The message is not modified in transit. If even one bit within the message is changed after the sender sent it, this would change the digital signature and the message would not be able to be validated.</p></li></ol></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3590347"></a>2. WHAT IS DMARC?</h2></div></div></div><p>To understand what DMARC is used for, we first need to understand the limitations of SPF and DKIM. (<span class="emphasis"><em>There are more drawbacks to SPF and DKIM but they are omitted from this paper</em></span>.)</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3488214"></a>2.1 Weaknesses of SPF and DKIM</h3></div></div></div><p>While SPF and DKIM are both good under certain circumstances, they suffer from a serious weakness &ndash; they do not protect the email address that the user sees in their inbox. SPF authenticates the SMTP MAIL FROM, which may or may not be the same as the 5322.From address. Meanwhile, DKIM authenticates the domain in the d= field in the DKIM-Signature, and there is no requirement for it to be the same as what the user sees. </p><p>There is nothing to stop a spammer from sending email that passes SPF or DKIM, or both, while specifying a different 5322.From address. From an anti-spam perspective, such a message will pass filtering. </p><p>This is where DMARC (or Domain-based Message Authentication, Reporting &amp; Conformance) comes in. In the example shown in <a href="#figure.6">Figure 6</a>, the user sees the address <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="731d1c071a151a1012071a1c1d003303120a03121f5d101c1e">[email&#160;protected]</a> in their inbox and may be deceived into thinking that the message really was from PayPal. Had the 5321.MailFrom and 5322.From been the same email address, SPF would have detected this and the message would have been marked as spam. However, since the two addresses are different, and since email clients do not tell the end-user they are different, they can be tricked. Furthermore, DKIM only identifies a real owner of a message. If a message is unsigned, or fails to verify, receivers should treat the message as if it is unsigned. DKIM establishes identity, it does not detect phishing. </p><div class="figure"><a id="figure.6"></a><div class="mediaobject"><img alt="How spammers can pass SPF but still phish users." src="/uploads/images/figures/2014/11/Zink-6.jpg" /></div><p class="title"><b>Figure&nbsp;6.&nbsp;How spammers can pass SPF but still phish users.</b></p></div><p>In contrast, DMARC is a technology that is designed to combat spoofing of the 5322.From address. DMARC asserts that: </p><div class="orderedlist"><ol type="1"><li><p>The message must pass SPF or DKIM. </p></li><li><p>The 5322.From address &ndash; the one that the user sees &ndash; and the domain that is authenticated (using either SPF or DKIM) must be the same. (<span class="emphasis"><em>Technically, these two domains must align. DMARC lets the domain require an exact match or a relaxed match where the organizational domains must match</em></span>.)</p></li></ol></div><p>Therefore, even if a spammer tries to &lsquo;hide&rsquo; the result of an SPF check, the fact that the authenticated domain does not match the one that the user sees will cause it to be flagged as spam. </p><div class="figure"><a id="figure.7"></a><div class="mediaobject"><img alt="How DMARC stops phishing." src="/uploads/images/figures/2014/11/Zink-7.jpg" /></div><p class="title"><b>Figure&nbsp;7.&nbsp;How DMARC stops phishing.</b></p></div><p>Thus, by publishing a DMARC record, a domain owner can indicate to receivers how they should treat email &lsquo;from&rsquo; their domain that does not authenticate. </p><p>A domain publishes a DMARC record at _dmarc.&lt;domain&gt;. For example, _dmarc.contoso.com. Upon receipt of a message, an email receiver checks the DMARC record of the domain in the 5322.From address. There are four options, as shown in <a href="#table.1">Table 1</a>.</p><div class="table"><a id="table.1"></a><table border="1" summary="Four DMARC options."><colgroup><col /><col /><col /></colgroup><thead><tr><th align="center">Case</th><th align="center">DMARC record</th><th align="center">Requested action for receivers</th></tr></thead><tbody><tr><td>1</td><td>The DMARC record doesn&rsquo;t exist</td><td>Continue normal filtering</td></tr><tr><td>2</td><td>The DMARC record indicates p=none</td><td>Treat the message as if it didn&rsquo;t fail DMARC</td></tr><tr><td>3</td><td>The DMARC record indicates p=quarantine</td><td>Mark the message as spam</td></tr><tr><td>4</td><td>The DMARC record indicates p=reject</td><td>Reject the message without accepting it, the end-user receives no copy of the message</td></tr></tbody></table><p class="title"><b>Table&nbsp;1.&nbsp;Four DMARC options.</b></p></div><p>DMARC is useful up to this point because it allows domains to specify what to do with spoofed messages. However, SPF does the same thing with its -all, ~all and ?all mechanism. </p><p>But DMARC has a powerful feature that the other technologies don&rsquo;t &ndash; reporting back ln failures. Whenever a message fails DMARC validation, a report is sent back to the spoofed domain, indicating that a message containing that domain failed DMARC validation. This feedback report is either done on an individual basis or sent in aggregate. That is, either a copy of the failed message is sent back to the forensic reporting email address, or a rolled up aggregate report containing basic information is sent back to the aggregate reporting email address. </p><p>This means that a domain can publish a DMARC record and receive all sorts of feedback. The domain owners can publish a DMARC record of p=none and then collect reports to see what would happen if they published p=quarantine or p=reject. </p><p>SPF was supposed to be a strict mechanism, but because there are so many legitimate cases of SPF failing, domains are reticent to publish strict policies. However, with DMARC, domains can take a look to see the potential consequences <span class="emphasis"><em>ahead of</em></span> publishing a strict DMARC policy. With SPF and even DKIM, domains were unclear as to how receivers would treat their email. </p><p>In contrast, DMARC is like turning on the lights in a dark room. </p><div class="figure"><a id="figure.8"></a><div class="mediaobject"><img alt="DMARC with feedback reports." src="/uploads/images/figures/2014/11/Zink-8.jpg" /></div><p class="title"><b>Figure&nbsp;8.&nbsp;DMARC with feedback reports.</b></p></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3694617"></a>3. Benefits of DMARC</h2></div></div></div><p>There are some obvious and less obvious benefits to implementing DMARC.</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id2615986"></a>3.1 Decreasing phishing</h3></div></div></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id3128211"></a>3.1.1 Decreasing regular phishing</h4></div></div></div><p>The most important benefit of DMARC is its ability to decrease phishing. Users rely on the 5322.From address to see who a message is from, so if spoofed 5322.From addresses fail to make it into their inboxes, users will fall victim to these scams less often. It is important to banks that their customers do not fall victim to phishing scams, because it costs them time and money to recover lost funds.</p></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id3808326"></a>3.1.2 Decreasing spear phishing</h4></div></div></div><p>DMARC is also important for large organizations that are targeted by spear phishing. One of the most common tactics of hackers trying to infiltrate an organization to plant an advanced persistent threat is to use phishing. They will send an &lsquo;important&rsquo; message spoofing the organization itself. For example, suppose the company Contoso is an important energy company, and employee John Smith receives the following email:</p><pre class="programlisting"><span class="emphasis"><em>5321.MailFrom: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="244c45474f4156644256414153414649454d480a474b49">[email&#160;protected]</a>
DKIM-Signature: d=freewebmail.com</em></span>
From: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a8c1c5d8c7dadcc9c6dcf7d8cddadbc7c6e8cbc7c6dcc7dbc786cbc7c5">[email&#160;protected]</a>
To: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="412b2e292f6f322c28352901222e2f352e322e6f222e2c">[email&#160;protected]</a>
Subject: Could you open up and fill out this work order?
Attachment(s): work_order_68241925.docx
</pre><p>The parts in italics are not shown to the end-user, so they can&rsquo;t see that the message is spoofed. It is deceptive because it appears to come from the same organization as the victim, and most people communicate regularly with others inside their company. However, if John Smith opens the message, it could trigger a zero-day exploit and grant the attacker remote access to his machine. </p><p>If Contoso had a DMARC record of p=quarantine or p=reject, on the other hand, the message would be marked as spam or rejected, and John Smith would never see it. </p><p>This is how DMARC helps to reduce spear phishing attacks. While there is no technology that will completely eliminate either regular phishing or spear phishing, DMARC is an important layer that minimizes one of the ways in which hackers gain access to organizations. </p></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id4208422"></a>3.2 Detect misconfigurations</h3></div></div></div><p>If a new server that sends outbound email is brought online, and that server doesn&rsquo;t sign with DKIM, or the IP addresses have not been added to the SPF record, DMARC can proactively notify the sender that authentication is failing (see <a href="#figure.9">Figure 9</a>).</p><div class="figure"><a id="figure.9"></a><div class="mediaobject"><img alt="Using DMARC to detect a misconfiguration." src="/uploads/images/figures/2014/11/Zink-9.jpg" /></div><p class="title"><b>Figure&nbsp;9.&nbsp;Using DMARC to detect a misconfiguration.</b></p></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id4595863"></a>3.3 Inventory third-party mailers</h3></div></div></div><p>In order to get SPF records under control, DMARC can be used to inventory all the IPs that are sending email &lsquo;as&rsquo; a brand. With this information, organizations can add them to their SPF records and eventually publish -all in their SPF record since they will have full confidence in who sends email legitimately &lsquo;as&rsquo; them.</p><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id2812485"></a>Before inventorying third-party emailers</h4></div></div></div><p><span class="bold"><strong>SPF record: </strong></span>example.com IN TXT &ldquo;v=spf1 1.2.3.0/24 ~all </p><p>In this example, the soft fail is published because example.com doesn&rsquo;t want to lose any legitimate email from third parties that send email as them, but which don&rsquo;t authenticate. </p><div class="figure"><a id="figure.10"></a><div class="mediaobject"><img alt="Using DMARC to inventory all third-party emailers ." src="/uploads/images/figures/2014/11/Zink-10.jpg" /></div><p class="title"><b>Figure&nbsp;10.&nbsp;Using DMARC to inventory all third-party emailers [<span class="citation"><a href="#citation.4">4</a></span>].</b></p></div></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id3292393"></a>After inventorying third-party emailers</h4></div></div></div><div class="figure"><a id="figure.11"></a><div class="mediaobject"><img alt="After inventorying third-party emailers." src="/uploads/images/figures/2014/11/Zink-11.jpg" /></div><p class="title"><b>Figure&nbsp;11.&nbsp;After inventorying third-party emailers.</b></p></div><p><span class="bold"><strong>SPF record: </strong></span>example.com IN TXT &ldquo;v=spf1 1.2.3.0/24 -all&rdquo; </p><p><span class="bold"><strong>SPF record:</strong></span> 3rdparty.example.com IN TXT &ldquo;v=spf1 include:3rdparty.com &ndash;all&rdquo; </p><p>The SPF record now has a hard fail, which means that email receivers that do not support DMARC but which do support SPF can assign a heavier weight. This helps prevent a brand (e.g. <span class="emphasis"><em>Microsoft</em></span>) from being spoofed by spammers. 4</p></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4113730"></a>4. Drawbacks of DMARC</h2></div></div></div><p>DMARC is a major step forward. However, it has some limitations.</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3661292"></a>4.1 Homoglyph attacks</h3></div></div></div><p>DMARC is designed to catch the case where, for example, a spammer spoofs &lsquo;@paypal.com&rsquo;. However, it does not catch the case where the spammer changes the domain to make it <span class="emphasis"><em>look like</em></span> the target domain (e.g. &lsquo;@paypa1.com&rsquo;), or where the target domain occurs somewhere within the email address (e.g. &lsquo;@paypal.com.spam.net&rsquo;). </p><p>Organizations can prevent the first type of spoofing by purchasing domains that sound or look very similar to their own, and then publishing SPF and DMARC records for those domains, indicating that they send no email. However, they cannot register all possible lookalikes, nor can they prevent the case where the phisher uses the target as a subdomain. </p><p>DMARC does not address this issue, but at the same time, these attacks are not the most common. </p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id4447990"></a>4.2 Mailing lists</h3></div></div></div><p>In cases where a message is &lsquo;spoofed&rsquo; for legitimate reasons, it will fail DMARC. This occurs most frequently in mailing lists or distribution groups. When you send a message to the list, the message goes to the group alias, which then relays the message to all recipients on the list. The message appear to have come &lsquo;from&rsquo; the original sender, but in reality it has come from the distribution list&rsquo;s mail server. The original sender appears in the 5322.From address as a convention. </p><div class="figure"><a id="figure.12"></a><div class="mediaobject"><img alt="A mailing list." src="/uploads/images/figures/2014/11/Zink-12.jpg" /></div><p class="title"><b>Figure&nbsp;12.&nbsp;A mailing list.</b></p></div><p>In the diagram shown in <a href="#figure.12">Figure 12</a>, when <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d9adb6b4f7acaabcab99bca1b8b4a9b5bcf7bab6b4">[email&#160;protected]</a> sends a message to the discussion group, this is what is happening: </p><pre class="programlisting">5321.MailFrom: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6a1e0507441f190f182a0f120b071a060f44090507">[email&#160;protected]</a>
5322.From: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5723383a792224322517322f363a273b327934383a">[email&#160;protected]</a>
To: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d8bab1aabcf6afb9acbbb0bdaaab98bcb1abbbadababb1b7b6f6b7aabf">[email&#160;protected]</a>
DKIM-Signature: d=example.com
_dmarc.example.com = p=reject
Subject: Has anyone seen this new bluejay lately?
</pre><p>The mail server at discussion.org correctly sees that this message passes DMARC because it passes SPF and DKIM, and the domain in the 5322.From address aligns with both the SPF validated domain and the DKIM-validated domain. </p><p>However, when the message is relayed from the discussion list&rsquo;s mail server, it looks like this: </p><pre class="programlisting">5321.MailFrom: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0d6f647f69237a6c796e65687f7e4d69647e6e787e7e64626323627f6a">[email&#160;protected]</a>
5322.From: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2e5a4143005b5d4b5c6e4b564f435e424b004d4143">[email&#160;protected]</a>
To: &lt;individual end user&gt;
DKIM-Signature: d=discussion.org
_dmarc.example.com = p=reject
Subject: [bird watchers] Has anyone seen this new bluejay lately?
</pre><p>In the case of this relayed message, the message passed SPF (discussion.org) and DKIM (d=discussion.org) checks. However, the domain in the 5322.From field (example.com) aligns with neither of those domains. Because example.com publishes p=reject, the email will be marked as spam or rejected. This is despite the fact that the message is entirely legitimate. </p><p>Even if the original message was DKIM-signed, the content of the message has been modified &ndash; the subject line has been changed to insert a tag to make it useful to all the other users on the list. Mailing lists have been doing this for decades &ndash; they modify the contents of a message to make it more useful to its recipients. Unfortunately, doing this invalidates the original DKIM signature, which means that anyone with a domain that publishes p=reject cannot send email to mailing lists if there are other recipients on the list that perform DMARC verification (i.e. just about all of them). </p><p>If a domain that publishes a DMARC record of p=reject joins a mailing list, the following is what normally occurs: </p><div class="orderedlist"><ol type="1"><li><p>The user who sends to the list and whose message is relayed to the rest of the list&rsquo;s recipients will see their message rejected at the recipients&rsquo; mail servers.</p></li><li><p>The mailing list will see many different rejections from these recipients for this user. Many mailing lists will then automatically unsubscribe the user from the list, erroneously believing that email address is no longer valid.</p></li></ol></div><p>Neither of these two behaviours is desirable, and this loss of legitimate email is a major drawback for DMARC.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id2954018"></a>4.3 Workarounds</h3></div></div></div><p>The problem of mailing lists is one of the reasons why previous efforts to tie the 5322.From address to an authenticated domain failed. Until April 2014, the conventional wisdom was &lsquo;Domains that publish p=reject shouldn&rsquo;t participate in mailing lists. Use a non-highly targeted domain instead.&rsquo; This held true, for the most part, until both <span class="emphasis"><em>Yahoo</em></span> and <span class="emphasis"><em>AOL</em></span> started publishing p=reject.</p><p>So, how can this be fixed? There are numerous options, which are shown in .<a href="#table.2">Table 2</a> (A full list of workarounds is available at: <a href="http://wiki.asrg.sp.am/wiki/Mitigating_DMARC_damage_to_third_party_mail" target="_blank">http://wiki.asrg.sp.am/wiki/Mitigating_DMARC_damage_to_third_party_mail</a>.)</p><div class="table"><a id="table.2"></a><table border="1" summary="The numerous options to work around DMARC breaking
        lists."><colgroup><col /><col /><col /></colgroup><thead><tr><th align="center">Option</th><th align="center">Advantages</th><th align="center">Drawbacks</th></tr></thead><tbody><tr><td>Option 1 &ndash; Do nothing and let domains that publish p=reject live with the consequences</td><td>Requires no code changes.</td><td>Doesn&rsquo;t address the problem. Major brands already publish p=reject and it would be a net benefit for users of major brands to be able to join discussion lists. </td></tr><tr><td>Option 2 &ndash; Don&rsquo;t permit domains with p=reject onto mailing lists</td><td>Prevents negative consequences of allowing domains with p=reject onto lists.</td><td>Same as above</td></tr><tr><td>Option 3 &ndash; Don&rsquo;t modify messages when sending to mailing lists</td><td>Messages that are signed with DKIM can participate in mailing lists.</td><td>Loses useful features of mailing lists: message modification is important.</td></tr><tr><td>Option 4 &ndash; Extend DMARC protocol so that it supports mailing lists</td><td>Potentially scales to all DMARC broken cases.</td><td>Cost/benefit ratio unclear of extending DMARC.</td></tr><tr><td>Option 5 &ndash; Mailing lists should reformat the message to prevent DMARC failures</td><td>Allows users to join mailing lists.</td><td>Can confuse end-users. Turns mailing list server into a mail relay which may not be desired behaviour. </td></tr><tr><td>Option 6 &ndash; Email receivers should be selective about how they enforce p=reject - send it to Junk or even skip enforcing it from known good emailing lists</td><td>Doesn&rsquo;t bounce domains with p=reject on mailing lists, avoids most negative consequences.</td><td>Defeats the purpose of rejecting email, user can still access phishing messages.</td></tr><tr><td>Option 7 &ndash; Maintain a whitelist of known mailing lists</td><td>Makes use of heuristics that most email receivers do anyhow.</td><td>Expensive to maintain.</td></tr></tbody></table><p class="title"><b>Table&nbsp;2.&nbsp;The numerous options to work around DMARC breaking lists.</b></p></div><p>None of these solutions are easy to implement, and none of them are ideal. However, the best ones are the last two. They have the drawback of forcing implementations to stop treating DMARC as a yes/no response to the question &lsquo;Is this message spoofed and if so, what should I do with it?&rsquo; Instead, the answer becomes &lsquo;It depends&rsquo;. </p><p>Since June 2014, the DMARC Working Group has been hard at work, trying to come up with ways to avoid interfering with legitimate messages. There is currently no consensus, and until there is, DMARC will continue to cause problems for certain cases of legitimate email. </p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4377703"></a>5. Case study: Microsoft</h2></div></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3910733"></a>5.1 The problem</h3></div></div></div><p><span class="emphasis"><em>Microsoft</em></span> is a large organization, within which there are many different business units that send email to its customers. Some of them include:</p><div class="itemizedlist"><ul type="disc"><li><p>Bing Rewards</p></li><li><p>HealthVault</p></li><li><p>Microsoft Volume Licensing</p></li><li><p>MS Blog Admins</p></li><li><p>Photosynth</p></li><li><p>Visual Studio</p></li><li><p>Windows Phone </p></li><li><p>Xbox</p></li><li><p>Xbox Live Enforcers</p></li></ul></div><p>The sending of email to the company&rsquo;s customers is not universally coordinated across business units within the organization. Some teams use third-party bulk email providers to send email. Some use another internal team dedicated to sending bulk email. Others have set up their own mail servers and call APIs that are native to Powershell. And still others use third-party hardware-hosting providers that also provide email sending services. </p><p>Thus, while microsoft.com is prone to being spoofed, the problem is that nobody wants to see their legitimate email marked as spam by publishing aggressive DNS records indicating what to do with spoofed email. That is, HealthVault needs to have its email delivered to end-users, so does Xbox Live Enforcers, so does Visual Studio, and so on. For that reason, <span class="emphasis"><em>Microsoft</em></span> publishes the following SPF record: </p><pre class="programlisting">microsoft.com. IN  TXT  &ldquo;v=spf1 &lt;list of all records ~all&rdquo;</pre><p><span class="emphasis"><em>Microsoft</em></span> publishes a soft fail in its SPF record, which means &lsquo;Accept the email but mark it in some way&rsquo;. In reality, most email receivers treat a soft fail as a very light weight in their spam-filtering algorithms. Thus, when an email server passes SPF, it is a way to identify a legitimate sender. However, a soft fail is a very weak indicator when detecting malicious spoofing. It provides very little anti-phishing protection. </p><p>In December 2013, <span class="emphasis"><em>Microsoft</em></span> embarked on a program to publish a hard fail in its SPF. This would require putting together an inventory of all internal teams that were sending out emails that were failing SPF checks, and getting them to send their emails in a manner that passed SPF so that we could be more aggressive with malicious email without interfering with legitimate, but unauthenticated, email. </p><p>This was no small feat, and it would not have been possible without DMARC. While DMARC is an anti-phishing technology that can reject or mark as spam any message that fails to authenticate, its sending of reports to the spoofed domain is vital since it can be deployed in passive mode by publishing a policy of p=none, enabling a domain to receive DMARC reports. They can then use these reports to track down every single point-of-origin both within and outside their infrastructure to pinpoint which teams are not authenticating properly. </p><p>That is exactly what <span class="emphasis"><em>Microsoft</em></span> did. </p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3635847"></a>5.2 Working towards authentication</h3></div></div></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id4372026"></a>Step 1 &ndash; Decide how to receive DMARC reports</h4></div></div></div><p>Because <span class="emphasis"><em>Microsoft</em></span> is such a large company, the number of reports that would be received would be very large. There may be hundreds, thousands, or even hundreds of thousands of DMARC reports per day. Luckily, there are companies that specialize in the collection of DMARC reports and in presenting them to domain owners in a way that is easily consumable &ndash; they can be searched, sorted, and analysed. </p><p><span class="emphasis"><em>Microsoft</em></span> enlisted a third-party provider to assist with this. (<span class="emphasis"><em>This is not an official endorsement of this particular third company. If you want to know which one was used, please see our DNS record.</em></span>)</p></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id4909163"></a>Step 2 &ndash; Publish a DMARC record</h4></div></div></div><p>The next step is to publish a DMARC record in DNS. <span class="emphasis"><em>Microsoft</em></span> published the following:</p><pre class="programlisting">_dmarc.microsoft.com.  IN  TXT  &ldquo;v=DMARC1; p=none; pct=100; rua=mailto:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="096d49272727">[email&#160;protected]</a>; ruf=mailto:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="284c68060606">[email&#160;protected]</a>; fo=1&ldquo;</pre><p>This DMARC record says:</p><div class="orderedlist"><ol type="1"><li><p>Do not take action if a message fails DMARC.</p></li><li><p>Send an aggregate report and a forensic report for any alignment failure &ndash; whether the message fails SPF, DMARC, or organizational alignment.</p></li></ol></div><p>Once that record was published, all third parties that support DMARC would start sending reports back to the ruf and rua addresses.</p></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id2574442"></a>Step 3 &ndash; Sort through the DMARC reports for IPs that are used for corporate traffic</h4></div></div></div><div class="orderedlist"><ol type="1"><li><p>Once DMARC reports started pouring in, we had to step through them and sort through which ones were bad and which ones were misconfigurations. </p><p><span class="emphasis"><em>Microsoft</em></span> sends its outbound corporate traffic through Exchange Online Protection (EOP). We noticed that there were a lot of SPF failures attributed to mail coming through EOP&rsquo;s outbound IPs. It turned out that <span class="emphasis"><em>Microsoft</em></span> had so many domains listed in its SPF record, that it resulted in the maximum number of DNS lookups prescribed by SPF (10) being exceeded. We cut out some of the extraneous records and waited for more reports. </p></li><li><p>Once the SPF/DNS lookup limits were resolved, we discovered that there were a lot of failures on NDR messages, that is, messages with a 5321.MailFrom of &lt;&gt;. We realized that we needed to create SPF records for the domains in the HELO/EHLO strings that the <span class="emphasis"><em>Exchange</em></span> servers use to send email. (<span class="emphasis"><em>If the 5321.MailFrom is empty, SPF uses the domain in the HELO/EHLO string.</em></span>)</p></li></ol></div></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id2863956"></a>Step 4 &ndash; Sort through the DMARC reports for IPs that are internal to the company, but failing authentication</h4></div></div></div><p>Next, we had to find IPs that were registered to <span class="emphasis"><em>Microsoft</em></span> as a company. Some teams had set up mail servers to send email directly from a <span class="emphasis"><em>Microsoft</em></span>-owned IP address. However, these IPs were not in <span class="emphasis"><em>Microsoft</em></span>&rsquo;s SPF record. </p><p>To fix this, for every IP that showed up as failing SPF, we looked at the alias (e.g. <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="33454047735e5a50415c405c55471d505c5e">[email&#160;protected]</a> [<span class="emphasis"><em>fictitious email address</em></span>]). We then tracked down the team that was using the address to send email and asked them either to move to the internally supported email sending platform, or if that was not possible, we would add the IP range to <span class="emphasis"><em>Microsoft</em></span>&rsquo;s SPF record. </p><p>This process was repeated for several teams. </p></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id2848839"></a>Step 5 &ndash; Sort through the DMARC reports for IPs that are external to the company and failing authentication</h4></div></div></div><p>Some teams at <span class="emphasis"><em>Microsoft</em></span> were using third-party hardware to send automated email. Most of this email was transactional in nature. </p><p>We decided that <span class="emphasis"><em>Microsoft</em></span> would not put third-party IPs into the SPF record for @microsoft.com. Instead, we would delegate a subdomain, e.g. email.microsoft.com. All third-party IPs would go into that subdomain. </p><p>We then tracked down every team that used third-party hardware to send email and asked them either to move their mailing software to use the internally supported email platform, or move their email address from &lt;localpart&gt;@microsoft.com to &lt;localpart&gt;@email.microsoft.com. We then added their IPs to the SPF record for that domain. </p></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id2982140"></a>Step 6 &ndash; Update DKIM keys</h4></div></div></div><p><span class="emphasis"><em>Microsoft</em></span> does use some third-party email service providers to send bulk email. However, when researching the teams, we found that some of them were sending DKIM-signed email with keys that had been generated several years ago. </p><p>We decided to update them. We contacted the third-party provider and got them to generate a new public/private DKIM key pair. We then published the public key in DNS at a new domain and got them to test with the new private key. At an agreed date, we switched over to the new key and retired the old one. </p></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id2929329"></a>Step 7 &ndash; Update the SPF record to a hard fail</h4></div></div></div><p>The next step is to update <span class="emphasis"><em>Microsoft</em></span>&rsquo;s SPF record to a hard fail. Because of the potential conflict with sales staff and a busy end of the fiscal year, <span class="emphasis"><em>Microsoft</em></span> decided to put the change to a hard fail on hold until after the fiscal year, to mitigate risk to the service. </p><p>However, when all was said and done, after an eight-month process, <span class="emphasis"><em>Microsoft</em></span> updated its SPF record from a soft fail to a hard fail. This would not stop all spoofing of <span class="emphasis"><em>Microsoft</em></span>&rsquo;s domain, but it would certainly stop some. </p></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a class="chapter" id="id3648611"></a>Step 8 &ndash; Publish a DMARC record of p=quarantine</h4></div></div></div><p>Publishing a stricter DMARC record is on the horizon. But first, <span class="emphasis"><em>Microsoft</em></span> needs to sign all of its corporate traffic with DKIM. That is still a work in progress and has not yet been accomplished. However, it is planned for a future release. </p><p>Without DMARC&rsquo;s reporting feedback, this process would not have been possible. </p></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id4027667"></a>Conclusion</h2></div></div></div><p>DMARC is a very useful technology for preventing spoofing; it is the biggest step forward we have seen in five years for combating phishing. Domains that have implemented it with a strict rejection policy report that phishing of their domains has declined significantly since they published the aggressive policy. DMARC&rsquo;s strength is that it helps domains preview what will happen when they do lock down their domain, so as to reduce false positives before they occur. </p><p>Yet DMARC still has some issues to work out. It flags legitimate email as spam and there are no elegant workarounds yet. However, as these issues get sorted out, the end result will be a more secure environment for email. </p><div class="bibliography"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id3493469"></a>Bibliography</h3></div></div></div><div class="bibliomixed"><a id="citation.1"></a><p class="bibliomixed">[1] DMARC information page. <span class="bibliosource"><a href="http://dmarc.org/" target="_blank">http://dmarc.org/</a></span>. </p></div><div class="bibliomixed"><a id="citation.2"></a><p class="bibliomixed">[2] DMARC official requirements. <span class="bibliosource"><a href="https://datatracker.ietf.org/doc/draft-kucherawy-dmarc-base/" target="_blank">https://datatracker.ietf.org/doc/draft-kucherawy-dmarc-base/</a></span>. </p></div><div class="bibliomixed"><a id="citation.3"></a><p class="bibliomixed">[3] A Reputation Response Set for Email Identifiers. <span class="bibliosource"><a href="https://tools.ietf.org/html/rfc7073" target="_blank">http://tools.ietf.org/html/rfc7073</a></span>. </p></div><div class="bibliomixed"><a id="citation.4"></a><p class="bibliomixed">[4] See my blog series on DMARC and third-party emailers: <span class="bibliosource"><a href="https://blogs.msdn.com/b/tzink/archive/2013/04/27/how-to-setup-dmarc-records-if-you-are-outsourcing-some-or-all-of-your-email-part-1.aspx" target="_blank">http://blogs.msdn.com/b/tzink/archive/2013/04/27/how-to-setup-dmarc-records-if-you-are-outsourcing-some-or-all-of-your-email-part-1.aspx</a></span> and <span class="bibliosource"><a href="https://blogs.msdn.com/b/tzink/archive/2013/04/27/how-to-setup-your-dmarc-records-if-you-are-outsourcing-some-or-all-of-your-email-part-1.aspx" target="_blank">http://blogs.msdn.com/b/tzink/archive/2013/04/27/how-to-setup-your-dmarc-records-if-you-are-outsourcing-some-or-all-of-your-email-part-1.aspx</a></span>.</p></div></div></div> </div>
<div class="col-md-3 col-sm-3 col-lg-3">
<p><a href="/uploads/pdf/conference/vb2014/VB2014-Zink.pdf" target="_blank"><img class="ccm-image-block responsive" alt="" src="/uploads/images/buttons/pdf-download-button.jpg" onmouseover="this.src = '/uploads/images/buttons/pdf-download-button-hover.jpg'" onmouseout="this.src = '/uploads/images/buttons/pdf-download-button.jpg'" border="0" height="45" width="262"></a></p>
<div id="NDPHPBlock13359" class="NDPHPBlock">
<div style="width: 100%;"><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Tweet this!' href="https://twitter.com/share?text=VB2014 paper: Using DMARC to improve your email reputation&url=https://www.virusbulletin.com/virusbulletin/2014/11/paper-using-dmarc-improve-your-email-reputation"><img src='/uploads/images/buttons/twitter.png' alt='twitter.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on Facebook' href='https://www.facebook.com/sharer.php?u=https://www.virusbulletin.com/virusbulletin/2014/11/paper-using-dmarc-improve-your-email-reputation'><img src='/uploads/images/buttons/fb.png' alt='fb.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on LinkedIn' href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.virusbulletin.com/virusbulletin/2014/11/paper-using-dmarc-improve-your-email-reputation&title=VB2014 paper: Using DMARC to improve your email reputation"><img src='/uploads/images/buttons/linkedin.png' alt='linkedin.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on Hacker News' href="https://news.ycombinator.com/submitlink?u=https://www.virusbulletin.com/virusbulletin/2014/11/paper-using-dmarc-improve-your-email-reputation&t=VB2014 paper: Using DMARC to improve your email reputation"><img src='/uploads/images/buttons/hackernews.png' alt='hackernews.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='reddit this!' href="https://www.reddit.com/submit?url=https://www.virusbulletin.com/virusbulletin/2014/11/paper-using-dmarc-improve-your-email-reputation"><img src='/uploads/images/buttons/reddit.png' alt='reddit.png' width='45' height='45' class='responsive' /></a></center></div></div></div><p> </p>
<h2>Latest articles:</h2>
<div class="ccm-page-list">
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2022/04/cryptojacking-fly-teamtnt-using-nvidia-drivers-mine-cryptocurrency/" target="_self">Cryptojacking on the fly: TeamTNT using NVIDIA drivers to mine cryptocurrency</a>
</h3>
<div class="ccm-page-list-description">
TeamTNT is known for attacking insecure and vulnerable Kubernetes deployments in order to infiltrate organizations&rsquo; dedicated environments and transform them into attack launchpads. In this article Aditya Sood presents a new module introduced by&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/12/collector-stealer-russian-origin-credential-and-information-extractor/" target="_self">Collector-stealer: a Russian origin credential and information extractor</a>
</h3>
<div class="ccm-page-list-description">
Collector-stealer, a piece of malware of Russian origin, is heavily used on the Internet to exfiltrate sensitive data from end-user systems and store it in its C&amp;C panels. In this article, researchers Aditya K Sood and Rohit Chaturvedi present a 360&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/06/fighting-fire-fire/" target="_self">Fighting Fire with Fire</a>
</h3>
<div class="ccm-page-list-description">
In 1989, Joe Wells encountered his first virus: Jerusalem. He disassembled the virus, and from that moment onward, was intrigued by the properties of these small pieces of self-replicating code. Joe Wells was an expert on computer viruses, was partly&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/04/run-your-malicious-vba-macros-anywhere/" target="_self">Run your malicious VBA macros anywhere!</a>
</h3>
<div class="ccm-page-list-description">
Kurt Natvig wanted to understand whether it&rsquo;s possible to recompile VBA macros to another language, which could then easily be &lsquo;run&rsquo; on any gateway, thus revealing a sample&rsquo;s true nature in a safe manner. In this article he explains how he recompiled&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/04/dissecting-design-and-vulnerabilities-azorultccpanels/" target="_self">Dissecting the design and vulnerabilities in AZORult&nbsp;C&amp;C&nbsp;panels</a>
</h3>
<div class="ccm-page-list-description">
Aditya K Sood looks at the command-and-control (C&amp;C) design of the AZORult malware, discussing his team's findings related to the C&amp;C design and some security issues they identified during the research. </div>
</div>
<p><br /><a class="btn btn-block btn-warning" href="/virusbulletin/archive">Bulletin Archive</a></p> </div>
</div>
</div>

<footer class="bs-footer" role="contentinfo">
<div class="container">
<div class="bs-social">
<div class="row ">
<div class="col-md-3">
<p><a title="About Us" href="/about-vb/about-us/">About us</a></p>
<p><a title="Contact Us" href="/about-vb/contact-us/">Contact us</a></p>
<p><a title="Advisory Board" href="/about-vb/advisory-board/">Advisory board</a></p>
<p><a title="Press" href="/about-vb/press/">Press information</a></p>
<p><a title="Security Events Calendar" href="/resources/calendar/">Security events calendar</a></p>
<p><a title="Newsletter" href="/newsletter/">Virus Bulletin newsletter</a></p> </div>
<div class="col-md-3">
<p><a title="VB Testing" href="/testing/">Testing</a></p>
<p><a title="VB100" href="/testing/vb1001/">VB100</a></p>
<p><a title="VBSpam" href="/testing/vbspam/">VBSpam</a></p>
<p><a title="VBWeb" href="/testing/vbweb/">VBWeb</a></p>
<p><a title="Consultancy Services" href="/testing/consultancy-services/">Consultancy services</a></p>
<p><a title="The Spammers' Compendium" href="/resources/spammerscompendium/">Spammers' Compendium</a></p> </div>
<div class="col-md-3">
<p><a title="VB2021 localhost" href="/conference/vb2021/">VB2021 localhost</a></p>
<p><a title="VB2020 localhost" href="/conference/vb2020/">VB2020 localhost</a></p>
<p><a title="VB2019" href="/conference/vb2019/">VB2019 (London)</a></p>
<p><a title="VB2018" href="/conference/vb2018">VB2018 (Montreal)</a></p>
<p><a title="VB2017" href="/conference/vb2017">VB2017 (Madrid)</a></p>
<p><a title="Conference Archive" href="/conference/vb-conference-archive/">Older conferences</a></p> </div>
<div class="col-md-3">
<div class="row">
<table style="float: right;" border="0">
<tbody>
<tr>
<td align="center"><a href="/rss" target="_blank"><img title="Get our blog updates" src="/uploads/images/buttons/rss-square-gray.png" alt="rss.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://twitter.com/virusbtn" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on Twitter" src="/uploads/images/buttons/twitter-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.linkedin.com/company/virus-bulletin" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on LinkedIn" src="/uploads/images/buttons/linkedin-square-gray.png" alt="linkedin.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.facebook.com/virusbulletin" target="_blank"><img title="Visit us on Facebook" src="/uploads/images/buttons/fb-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.youtube.com/user/virusbtn" target="_blank"><img title="Visit us on Youtube" src="/uploads/images/buttons/youtube-square-gray.png" alt="youtube.png" width="35" height="35" /></a></td>
</tr>
</tbody>
</table>
</div> </div>
</div>
<div class="row ">
<div class="col-md-12">
</div>
</div>
</div>
</div>
</footer>

<footer class="bs-footer2" role="contentinfo">
<div class="container">
<div class="bs-social2">
<div class="row ">
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
</div>
<div class="row ">
<div class="col-md-12">
<p style="text-align: left;">©1989-2022 Virus Bulletin.        <a title="Privacy Policy" href="/about-vb/privacy-policy/">Privacy policy</a>        <a title="Cookies" href="/about-vb/privacy-policy/cookies/">Cookies</a>        <a title="Terms and Conditions" href="/about-vb/terms-and-conditions/">Terms and Conditions</a></p> </div>
</div>
</div>
</div>
</footer>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-21876594-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-21876594-2', { 'anonymize_ip': true });
</script><script type="text/javascript" src="/libraries/js/fancybox.load.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/app.js"></script>
<div id="ccm-cookiesDisclosure" class="disclosure-bottom">
<div class="disclosure-container">
<div class="disclosure-content">
<p> We have placed cookies on your device in order to improve the functionality of this site, as outlined in our <a href="/about-vb/privacy-policy/cookies" target="_blank">cookies policy</a>. However, you may delete and block all cookies from this site and your use of the site will be unaffected. By continuing to browse this site, you are agreeing to Virus Bulletin's use of data as outlined in our <a href="/about-vb/privacy-policy/" target="_blank">privacy policy</a>.</p>
</div>
<div class="disclosure-form">
<form action="/index.php/cookies_disclosure/" method="POST">
<input type="hidden" name="allowCookies" value="1" />
<div class="button">
<input class="btn btn-info btn-sm" type="submit" name="submit" value="I understand. Don't show this message again!" />
</div>
</form>
</div>
<div class="ccm-spacer">&nbsp;</div>
</div>
</div>
</body>
</html>