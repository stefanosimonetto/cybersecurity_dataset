<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<script type="text/javascript">var BOOTSTRAP_VERSION ="lumen";
	var BOOTSTRAP_JS_HEAD =1;
	var BOOTSTRAP_CDN_ENABLE =0; var BOOTSTRAP_NAVBAR_TYPE =0; var BOOTSTRAP_LOGO_OPTION =0; var BOOTSTRAP_NAVBAR =1; var BootstrapInputFix =true;var BootstrapNavbarLineHeightFix =true;var BOOTSTRAP_EDT= 0; </script>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>Virus Bulletin :: What next? Trojan.Linkoptimizer</title>
<meta name="description" content="The Linkoptimizer trojan raised alarms in the AV industry signalling that there are other ingenious ways besides advanced rootkits to make the lives of both users and security providers difficult. Mircea Ciubotariu has the full details of Trojan.Linkoptmizer." />
<meta name="generator" content="concrete5 - 5.6.3.5" />
<script type="text/javascript">
var CCM_DISPATCHER_FILENAME = '/index.php';var CCM_CID = 2694;var CCM_EDIT_MODE = false;var CCM_ARRANGE_MODE = false;var CCM_IMAGE_PATH = "/concrete/images";
var CCM_TOOLS_PATH = "/index.php/tools/required";
var CCM_BASE_URL = "https://www.virusbulletin.com";
var CCM_REL = "";

</script>
<link rel="shortcut icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
<link rel="icon" href="/files/8914/5459/9485/VBIcon.png" type="image/x-icon" />
<link rel="stylesheet" type="text/css" href="/concrete/css/ccm.base.css" />
<script type="text/javascript" src="/concrete/js/jquery.js"></script>
<script type="text/javascript" src="/concrete/js/ccm.base.js"></script>
<script type="text/javascript">
var COOKIES_ALLOWED=false;
</script>
<link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure.css" />
<!--[if lte IE 8]><link rel="stylesheet" type="text/css" href="/packages/free_cookies_disclosure/css/cookies_disclosure_ie.css" /><![endif]-->
<script type="text/javascript">
var COOKIES_DISCLOSURE_HIDE_INTERVAL=10;
</script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_hide.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/lumen/bootstrap-overwrites.css" />
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/css/members.css" />
<script type="text/javascript" src="/packages/bootstrap/js/common/prettify.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/jquery.easing.1.3.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="/libraries/css/jquery.fancybox.css" />
<script type="text/javascript" src="/libraries/js/jquery.fancybox.pack.js"></script>
<link rel="stylesheet" media="screen" type="text/css" href="/files/cache/css/bootstrap/typography.css" />
<script type="text/javascript" src="/index.php/tools/packages/free_cookies_disclosure/disclosure_i18n_js"></script>
<script type="text/javascript" src="/packages/free_cookies_disclosure/js/disclosure_ajax_form.js"></script>
<link rel="stylesheet" type="text/css" href="/concrete/blocks/page_list/view.css" />
<link rel="stylesheet" type="text/css" href="/packages/remo_expand/blocks/remo_expand/templates/vbexpand/view.css" />
<script type="text/javascript" src="/packages/remo_expand/js/jquery.color.js"></script>
<script type="text/javascript" src="/packages/remo_expand/js/jquery.ba-hashchange.js"></script>
<script type="text/javascript" src="/packages/remo_expand/js/remo.expand.js"></script>
<link rel="stylesheet" type="text/css" href="/packages/bootstrap/blocks/search/templates/VB_global_search/view.css" />
<link rel="stylesheet" type="text/css" href="/packages/travisn_spacer/css/ccm.tnspacer.css" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.js" integrity="sha256-1SFdTXlsw0RkQ+iO0E91LDshGiIbPiTYqJto0px4wds=" crossorigin="anonymous"></script>
<!--[if gte IE 9]>
<script src="/packages/bootstrap/js/common/modernizr.js"></script>
<![endif]-->

<!--[if lt IE 9]>	
	
	<script src="/packages/bootstrap/js/common/html5shiv.js"></script>
	<script src="/packages/bootstrap/js/common/respond.min.js"></script>
	
<![endif]-->
</head>
<body data-spy="scroll" data-target=".bs-sidebar">

<div class="navbar  navbar-fixed-top navbar-default  bs-docs-nav">
<div class="navbar-inner">
<div class="container"><div class="row"><div class="col-sm-4 col-md-4 logo-position-1 col-logo">
<div class="navbar-header">
<button type="button" class="navbar-toggle btn_navbar_custom">
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button><div class="mobile-clearfix"></div><div class="navbar-brand navbar-brand-area"><a href="/"><img border="0" class="ccm-image-block" alt="" src="/files/4614/4535/7515/logo-big.png" width="339" height="92" /></a></div> </div>
</div><div class="col-sm-8 col-md-8 logo-position-1 col-nav"> <div class="nav-collapse collapse nav_collapse_custom navbar-collapse"> <div style="clear:both"></div>
<div class="vb-global-search-div">
<form action="/index.php/global-search-results/" method="get">
<fieldset>
<input name="search_paths[]" type="hidden" value="" />
<input name="query" type="text" class="vb-global-search" placeholder="Search site..." />
<input name="submit" type="submit" value="Search!" style="display:none" />
</fieldset>
</form>
</div>
<div class="tnSpacer" style="height:48px"></div>
<ul class="nav nav-pills"><li class=" nav-first nav-item-6299"><a href="/newsletter/" target="_self" class=" nav-first nav-item-6299 ">Newsletter</a></li><li class=" nav-item-260"><a href="/conference/" target="_self" class=" nav-item-260 ">VB Conference</a></li><li class=" nav-item-166"><a href="/testing/" target="_self" class=" nav-item-166 ">VB Testing</a></li><li class=" nav-path-selected active nav-item-160"><a href="/virusbulletin/" target="_self" class=" nav-path-selected active nav-item-160 ">Bulletin</a></li><li class=" nav-last nav-item-130"><a href="/blog/" target="_self" class=" nav-last nav-item-130 ">Blog</a></li></ul> </div>
</div>
</div><div class="clearfix"></div>
</div>
</div>
</div>
<div class="navbar-top-fixed-space "><div class="clearfix"></div></div>

<div class="container m-top-20">
<div class="row">
<div class="col-md-9 col-sm-9 col-lg-9">
<div class="titlepage" xmlns=""><div><div><h1 class="title" xmlns="http://www.w3.org/1999/xhtml"><a id="vb200612-trojan-linkoptimizer"></a>What next? Trojan.Linkoptimizer</h1></div><div><p class="pubdate" xmlns="http://www.w3.org/1999/xhtml">2006-12-01</p></div><div><div class="authorgroup" xmlns="http://www.w3.org/1999/xhtml"><div class="author titlepage"><h3 class="author"><span class="firstname">Mircea</span> <span class="surname">Ciubotariu</span></h3><span class="orgname">Symantec Security Response</span>, <span class="orgdiv">Ireland</span></div><b class="editedby">Editor: </b><span class="editor"><span class="firstname">Helen</span> <span class="surname">Martin</span></span></div></div><div><div class="abstract" xmlns="http://www.w3.org/1999/xhtml"><p class="title"><b>Abstract</b></p><p>The Linkoptimizer trojan raised alarms in the AV industry signalling that there are other ingenious ways besides advanced rootkits to make the lives of both users and security providers difficult. Mircea Ciubotariu has the full details of Trojan.Linkoptmizer.</p></div></div><div><p class="copyright" xmlns="http://www.w3.org/1999/xhtml"><i>Copyright &copy; 2006 Virus Bulletin</i></p></div></div><hr /></div>
<div class="ccm-remo-expand">
<div id="ccm-remo-expand-title-5009" class="ccm-remo-expand-title ccm-remo-expand-closed" data-expander-speed="200">Table of contents</div><div id="ccm-remo-expand-content-5009" class="ccm-remo-expand-content"><div class="toc"><dl><dt><span class="sect1"><a href="#id2773617">Introduction</a></span></dt><dt><span class="sect1"><a href="#id3073476">The trojan</a></span></dt><dt><span class="sect1"><a href="#id3161286">The action</a></span></dt><dt><span class="sect1"><a href="#id3787591">Spaghetti code</a></span></dt><dt><span class="sect1"><a href="#id3534347">Reserved file names</a></span></dt><dt><span class="sect1"><a href="#id3064731">Encrypting file system</a></span></dt><dt><span class="sect1"><a href="#id2628668">The rootkit</a></span></dt><dt><span class="sect1"><a href="#id3045464">Conclusion</a></span></dt></dl></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id2773617"></a>Introduction</h2></div></div></div><p>Also known as Gromozon, the Linkoptimizer trojan has created havoc within the AV industry. It has raised alarms signalling that there are other ingenious ways besides advanced rootkits to make the lives of both users and security providers a nightmare. Combining state-of-the-art techniques such as &#39;spaghetti&#39; code, Encrypting File System (EFS), object rights manipulation, reserved file names and user-mode rootkits, the trojan manages gracefully to avoid detection by many AV engines and its removal can be a real nightmare.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3073476"></a>The trojan</h2></div></div></div><p>Trojan.Linkoptimizer has pushed the limits of persistence and stealth to a point where it manages to evade AV detection most of the time.</p><p>Recently we have seen what a significant impact advanced rootkits can have on the AV industry, but in order to achieve a really good rootkit one has to go deeper into the system, making obscure undocumented changes, therefore introducing a greater risk of system instability. This means that such techniques can be applied only to a limited number of targets, and updates are required even for slight changes in the environment. </p><p>There are other ways to make code &#39;stealthy&#39;, some of which have already been discussed in various articles. But so far Linkoptimizer is the first to combine these techniques and add its own flavour to them by developing new ones.</p><p>Although there is a lot to be said about this complex threat, this article will focus on the big picture of the trojan and the new elements it brings to the scene, especially its methods of evasion, how they work and how its authors have adapted them.</p><p>Linkoptimizer is a trojan &ndash; in fact it is an army of trojans, consisting mainly of droppers and downloaders with two ultimate purposes:</p><div class="itemizedlist"><ul type="disc"><li><p>To display advertisements.</p></li><li><p>To dial premium-rate numbers.</p></li></ul></div><p>The former has been identified as the sole purpose of the trojan by various vendors, with the latter somehow having been neglected as it was not associated with the &#39;adware&#39; component. This might be due to the fact that the two components responsible for these actions are dropped at different levels in the Linkoptimizer scheme. The adware component receives more attention since it is closer to the rootkit and EFS components.</p><p>The domain gromozon.com is considered to be responsible for spreading this trojan, which also gives the initial name for the threat, Gromozon. Its registration date goes back to mid February 2006, so it is expected that the first variants were released as early as March. As only some of its components were submitted individually for analysis &ndash; mainly by retail users &ndash; it was only in June/July that it came to the attention of the AV vendors and it took a while for all the pieces to be put together to get the full picture (see <a href="#figure.1">Figure 1</a>).</p><div class="figure"><a id="figure.1"></a><div class="informaltable"><table border="1"><colgroup><col /><col /><col /><col /><col /><col /><col /></colgroup><tbody><tr><td><span class="bold"><strong>Component</strong></span></td><td><span class="bold"><strong>Size (KB)</strong></span></td><td><span class="bold"><strong>Packed</strong></span></td><td><span class="bold"><strong>Spaghetti</strong></span></td><td><span class="bold"><strong>Naming</strong></span></td><td><span class="bold"><strong>Auto delete</strong></span></td><td><span class="bold"><strong>Type</strong></span></td></tr><tr><td>DR1 </td><td>10 - 17</td><td>FSG, - </td><td>Yes</td><td>Social engineering</td><td>Yes</td><td>Exe</td></tr><tr><td>DL1</td><td>9 - 13 </td><td>-</td><td>Yes</td><td>Temporary</td><td>Yes</td><td>DLL/OCX</td></tr><tr><td>DR2</td><td>61 - 67</td><td>UPX</td><td>Yes</td><td>6/8 random hex digits</td><td>Yes</td><td>Exe</td></tr><tr><td>DI (Dialer)</td><td>16 - 19</td><td>UPSX, SUE</td><td>No</td><td>Generated machine unique</td><td>No</td><td>Exe</td></tr><tr><td>EFS</td><td>56 - 75</td><td>-</td><td>Yes</td><td>Reserved file names, other</td><td>No</td><td>Exe</td></tr><tr><td>DR3</td><td>156 - 193</td><td>UPX</td><td>Yes</td><td>Temporary</td><td>Yes</td><td>Exe</td></tr><tr><td>DR4</td><td>75 - 102</td><td>-</td><td>No</td><td>Temporary</td><td>Yes</td><td>Exe</td></tr><tr><td>BHO (Adware)</td><td>64 - 82</td><td>UPX+SUE</td><td>No</td><td>Generated machine unique</td><td>No</td><td>DLL/BHO</td></tr><tr><td>DR5</td><td>126 - 153</td><td>-</td><td>Yes</td><td>Temporary</td><td>Yes</td><td>Exe</td></tr><tr><td>ADS (Rootkit)</td><td>115 - 139</td><td>-</td><td>Yes</td><td>Reserved file names, other</td><td>No</td><td>DLL</td></tr></tbody></table></div><div class="mediaobject"><img alt="Trojan.Linkoptimizer scheme and table." src="/uploads/images/figures/2006/12/FIG1.gif" /></div><p class="title"><b>Figure&nbsp;1.&nbsp;Trojan.Linkoptimizer scheme and table.</b></p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3161286"></a>The action</h2></div></div></div><p>As shown in <a href="#figure.1">Figure 1</a> the trojan gets into the victim&#39;s computer while browsing malicious sites. So far it is known that these sites are only using old exploits (i.e. no zero-day exploits have been used) with a little social engineering. This would make it hard to infect users with up-to-date patches and updates. However, two infection techniques have already been detailed [<span class="citation"><a href="#citation.1">1</a></span>], [<span class="citation"><a href="#citation.2">2</a></span>] and for the purpose of this paper, we will focus on the big picture.</p><p>The trojan is set in motion once the first downloader, DL1, is executed on the computer through one of the two ways shown: it may be dropped and saved as www.google.com or another seemingly innocuous name, or installed directly as an ActiveX Control (OCX file type) object, under the name &#39;FreeAccess.ocx&#39;. Once run, DL1 will attempt to download the following encrypted file:</p><pre class="programlisting">shiptrop.com/1/pic.gif?&lt;id_dec1&gt;&amp;&lt;id_hex&gt;&amp;0</pre><p>After decryption an executable is dropped into the current user&#39;s &#39;My Documents&#39; folder. The name of the executable is made up of six or eight random hexadecimal digits (e.g. 3e22c2d.exe); this is the second dropper in the scheme, DR2. It will drop two other components: the dialer DI, and the EFS downloader.</p><p>The dialer executable is dropped into either the %Windir% or the %Windir%\Temp folder with the name generated pseudo-randomly so that it looks random, but it will always be the same on the same computer. </p><p>The dialer carries an .xml file that contains a long list of accounts, passwords and telephone numbers to be used when an active modem connection is detected in the system. Most of them are Italian premium-rate numbers starting with &#39;899&#39;, but there are also some entries that use the <em class="phrase">Globalstar</em> mobile satellite service, starting with &#39;008819&#39;.</p><p>Considering the authors decided to add the <em class="phrase">Globalstar</em> satellite numbers just in case the compromised computer was outside Italy, it is worth noting that the number of countries from which these numbers can be dialed is limited because of the use of the prefix &#39;00&#39;. For example, from the USA and Canada the prefix &#39;011&#39; must be used to dial international numbers, so the prefix &#39;00&#39; will not work.</p><p>The EFS component will be discussed later, its main purpose being to download, decrypt and execute the following file:</p><pre class="programlisting">shiptrop.com/2/pic2.gif?&lt;id_dec2&gt;&amp; &lt;id_hex&gt;&amp;0</pre><p>This file is an intermediary dropper, DR3, which will drop two other droppers that we call DR4 and DR5. DR5 drops the rootkit component which is presented later on.</p><p>DR4 drops a DLL into the %Windir% folder. The name is similar to the dialer component and will be registered as a Browser Helper Object (BHO) using a pseudo-randomly generated CLSID that will remain the same for the same computer, so that it will be loaded automatically by <em class="productname">Internet Explorer</em>. The purpose of the BHO component is to display advertisements retrieved through this location:</p><pre class="programlisting">wlow.net/common/hint_js.php?e=&lt;request_enc64&gt;</pre><p>For quite a while the trojan created an uninstall entry called &#39;Linkoptimizer&#39; so that users could actually make use of the Add/Remove Programs function from the Control Panel, but the results would not be as expected. The following command would be executed:</p><pre class="programlisting">iexplore.exe &ldquo;http://notetol.com/uninstall.php&rdquo;</pre><p>This will render a page with only one small button in the middle reading &#39;Uninstall&#39;. When the button is clicked it is replaced with a text box reading &#39;Thank you&#39;. Needless to say, the threat is not touched at all, this being more of a practical joke meant to set a challenge in removing Linkoptimizer.</p><p>Recently, however, the trojan&#39;s authors have decided to change the uninstall entry from &#39;Linkoptimizer&#39; to a CLSID with various names, but still the same action.</p><p>Upon execution, all of the components of the trojan attempt to detect if the running environment is a virtual machine using the &#39;red pill&#39; method [<span class="citation"><a href="#citation.3">3</a></span>] and also check for the presence of the kernel mode debugger <em class="productname">SoftICE</em>. If either is detected they will simply exit.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3787591"></a>Spaghetti code</h2></div></div></div><p>A common feature of Linkoptimizer is that it makes heavy use of spaghetti code [<span class="citation"><a href="#citation.4">4</a></span>] in its binaries. This is most likely where the preferred name of the trojan came from: an intermediary layer between the compiler and the linker that splits the code into many small blocks, then shuffles them and finally binds them together using jump instructions.</p><p>For example, let&#39;s consider a compiled binary having three consecutive functions, F1, F2 and F3, each of which is split into three basic code blocks, B1, B2 and B3.</p><p>The basic layout of the code right after compilation will be:<span class="inlinemediaobject"><img src="/uploads/images/figures/2006/12/inline1.gif" /></span></p><p>And one possible arrangement after the intermediary &#39;optimizer&#39; layer might be:<span class="inlinemediaobject"><img src="/uploads/images/figures/2006/12/inline2.gif" /></span></p><p>From the source level &ndash; the creators&#39; point of view &ndash; everything looks straightforward and meaningful, but what happens from the researcher&#39;s point of view? That&#39;s right, they only have the &#39;messy&#39; code to deal with.</p><p>Previously, we have seen attempts to obfuscate code mainly at the source level by introducing extra garbage code &ndash; in most cases using macros that would generate different code each time and therefore different binaries. However Linkoptimizer has taken this a step further and mixed up the code with the following direct consequences:</p><div class="itemizedlist"><ul type="disc"><li><p>Analysis of such code is much slower since it is more difficult to follow.</p></li><li><p>Automatic recognition of standard library functions (e.g. IDA FLIRT signatures), as well as the recognition of the common code between different variants of the threat is no longer possible without further time-consuming processing.</p></li><li><p>Detection signatures on this kind of code are not efficient at all; in most cases the detection would be limited to a single file only.</p></li></ul></div><p>As will come as no surprise, this is combined with high-frequency updates of its components &ndash; about two per week &ndash; which ensures that the newly created binaries look different each time, and therefore they won&#39;t be detectable with regular definitions.</p><p>To make analysis of such code even more frustrating, the trojan&#39;s authors have used two types of jump instructions in the binding process of the code blocks: direct jump instructions (opcode 0xe9/0xeb &ndash; jmp imm32/imm8) and indirect memory jumps (opcode 0xff, 0x25 &ndash; jmp [mem32]) where the target code block address is encoded in the data area.</p><p>All the spaghetti optimized binaries have their strings encrypted with RC4, using only one byte derived from the length of the string as the key. Decryption is performed only when the string is needed and only on the stack so that a memory dump of the module would not leak any useful information; and of course, each time the binary is compiled the string keys are changed.</p><p>Also, with the exception of a minimal set of APIs, the imports of such binaries are in some cases encrypted with RC4 as well. In other cases they are not stored at all in the file, in which case CRC32 hashes of the API names are stored.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3534347"></a>Reserved file names</h2></div></div></div><p>In order to maintain compatibility with certain DOS features, <em class="productname">Windows</em> operating systems reserve a number of file names which are used to access various physical devices. These are as follows:</p><div class="informaltable"><table border="1"><colgroup><col /><col /></colgroup><tbody><tr><td><span class="bold"><strong>Device file name</strong></span></td><td><span class="bold"><strong>Description</strong></span></td></tr><tr><td>AUX</td><td>Auxiliary device</td></tr><tr><td>COM1, COM2, &hellip;, COM9</td><td>Serial ports</td></tr><tr><td>CON</td><td>Console device</td></tr><tr><td>LPT1, LPT2, &hellip;, LPT9</td><td>Parallel ports</td></tr><tr><td>NUL</td><td>Null device</td></tr><tr><td>PRN</td><td>Printer device</td></tr></tbody></table></div><p>Normally these file names cannot be used in conjunction with any extension, for example C:\LPT3.X would still refer to LPT3. However, &#39;LPT3X&#39; is a valid file name and can be used to store data as any other file. </p><p>However with <em class="productname">Windows NT</em>, due to the limitations in the maximum path length, a new way of accessing files has been added, namely to use the &#39;\\?\&#39; prefix with a fully qualified file path. This not only increased the maximum allowed length of a path, but also allowed the use of the reserved device names in file or even folder names.</p><p>Two Linkoptimizer components, namely the EFS and the rootkit components, sometimes make use of this feature upon installation when naming their executables. The purpose is obvious: since most applications use the standard path names, they will be denied access to these files, therefore preventing curious eyes from seeing the contents of the files.</p><p>For example, the rootkit component may be dropped with the following name: &#39;\\?\C:\Windows\System32\LPT1.IPJ&#39;, which will be treated as LPT1 unless the &#39;\\?\&#39;prefix is used.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3064731"></a>Encrypting file system</h2></div></div></div><p>Linkoptimizer effectively uses Windows Encrypting File System (EFS) [<span class="citation"><a href="#citation.5">5</a></span>], shipped starting with <em class="productname">Windows 2000</em>, as an anti-antivirus technique. In doing so it creates a new administrator-equivalent account with a random name and random password. Then it copies itself with some garbage data appended into one of these locations:</p><div class="itemizedlist"><ul type="disc"><li><p>%COMMONPROGRAMFILES%\System</p></li><li><p>%COMMONPROGRAMFILES%\Services</p></li><li><p>%COMMONPROGRAMFILES%\Microsoft Shared</p></li><li><p>%PROGRAMFILES%\Windows NT</p></li></ul></div><p>Next, it encrypts the file through EFS and adds a new system service with a random name pointing to it, under the credentials of the newly created user. The service is instructed to run at boot time under the new account, so that no other common user or object has access to its contents.</p><p>Moreover, it manipulates the discretionary access control list (DACL) of the registry subkey that holds the service&#39;s details, as well as the executable&#39;s DACL, to permit access to these two objects only to its owner, which is set to be the new user. This means that if anyone &ndash; even the administrator &ndash; attempts to read or change the settings of the service or attempts to delete the file, he/she will be denied access.</p><p>However, there are means of getting access to the contents of the protected objects. In the case of registry subkeys, the system built-in account has access by default to any key of the hive. This means that, using the system credentials, one could read any protected information from the registry. </p><p>With the encrypted file, however, things are a bit different. One would need to make some changes in the system in order to gain access to the decrypted contents of the file. In our case an easy solution would be to set the service&#39;s executable name to a different application that will run instead of the actual EFS and that will copy the contents of the EFS object to a new unencrypted container. At the end the service executable can be restored.</p><p>The implications of this are great: the biggest concern is not privacy invasion, since AV products may ask for permission before doing so, but access to the malicious contents, because there is no general way to get the contents of any EFS object.</p><p>The EFS component of Linkoptimizer goes a step further in preventing access to the file through the service&#39;s process, which contains the credentials of the user that it was run as. In doing so the service only runs for a small amount of time, just enough to create a new process, normally svchost.exe, inject its code into this process and perform all the subsequent actions with the appearance of an innocent and legitimate service.</p><p>Even for the small amount of time that the service runs, yet another protection measure has been introduced, namely to remove the SeDebugPrivilege from the administrator-equivalent built-in security group, which prevents any user in the system from manipulating processes or threads other than its own. </p><p>A consequence of this is that, without regaining SeDebugPrivilege, utility tools such as <em class="productname">Filemon</em> or <em class="productname">Regmon</em> will no longer run and some monitoring processes and information utilities will fail to work properly.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id2628668"></a>The rootkit</h2></div></div></div><p>The rootkit component of Linkoptimizer is what attracted the most attention from the AV industry, although it does not bring anything new besides a certain persistence in staying up and running.</p><p>First, it is a user-mode rootkit that injects its own DLL into all running processes and hooks via patching 100 APIs from five libraries of the latest version. Initially the hooks were intended to cloak the rootkit and the BHO component, but over time protection mechanisms have been added.</p><p>One example is the blocking of known security tools. This is done in two steps. Firstly, by checking the name of the executable that is about to be run against a blacklist; and secondly, by checking the version information strings located in the executable&#39;s resources against another blacklist. When a string is found in the blacklist the execution request will simply be ignored.</p><p>This way it effectively blocks many rootkit detectors and some fix tools provided by AV companies, which otherwise could remove or reveal some of its components.</p><p>It is noteworthy that the rootkit&#39;s cloak does not cover the dialer component. For some reason it was left outside, making it the most vulnerable component to detection and removal. </p><p>At the beginning the rootkit DLL was hidden in an Alternate Data Stream (ADS) of one of the following folders:</p><div class="itemizedlist"><ul type="disc"><li><p>System root folder (e.g. C:\:kzpy.qmt)</p></li><li><p>Windows folder (e.g. C:\Windows:hxlga.rbs)</p></li><li><p>System folder (e.g. C:\Windows\System32:jicqr.nvd)</p></li></ul></div><p>In time, the shelter provided by the ADS was no longer good enough since, although Alternate Data Streams can be used as normal files &ndash; can be executed, read and written &ndash; they don&#39;t have the same properties as normal files &ndash; for instance they don&#39;t have a security descriptor, a feature that would make them easier to remove.</p><p>In the end, the authors gave up using ADS for the rootkit storage and instead they started to use reserved file names or existing file names with a couple of characters changed. This time, however, they were able to use other tricks such as manipulating the file&#39;s security descriptor to allow execute permission only.</p><p>To ensure that the rootkit runs each time the system is restarted, it uses the HKLM\SOFTWARE\Microsoft\WindowsNT\CurrentVersion\Windows\AppInit_DLLs registry value [<span class="citation"><a href="#citation.6">6</a></span>], which instructs the system to load the DLLs enumerated by its string every time the user32 library initializes into a process. The trick with this value is that it is used even when the operating system boots in Safe Mode, with the exception of <em class="productname">Windows 2003 Server</em>.</p><p>In case AppInit_DLLs is not available the trojan will use an alternate registry key to run at startup by creating a randomly named value containing the string &#39;rundll32 &lt;rootkit_path&gt;, &lt;export_function&gt;&#39; into one of the following registry subkeys:</p><p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</p><p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</p><p>The Windows API provides notification functions for registry subkeys and directories which can signal when the monitored subkeys or directories undertake any changes such as adding, deleting or changing objects and manipulating the security descriptor of any of the contained objects. The functions are FindFirstChangeNotification, FindNextChangeNotification for directories and RegNotifyChangeKeyValue for subkeys.</p><p>The rootkit uses a notify function for the directory in which it is installed so that it monitors any changes to its file. If the security descriptor is altered, or if the file attributes are changed or the file is deleted, it will revert any changes made. The same technique is used to monitor the startup registry subkey: if the value is removed or altered while the notification is active it will be restored.</p><p>Finally, it uses another registry subkey notification event, this time for HKLM\SYSTEM\CurrentControlSet\Control\Session Manager, in order to monitor the activity of the value &#39;PendingFileRenameOperations&#39; which is responsible for renaming or deleting files at startup. The purpose of this is that if someone tries to delete the rootkit file using MoveFileEx, which uses that value, it will be able to replace the rootkit file name with random characters, preventing deletion in this way.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a class="chapter" id="id3045464"></a>Conclusion</h2></div></div></div><p>This isn&#39;t the work of an amateur. It may be one of those cases where a virus-writing teenager has refused to face reality and, as a grown up, has gone on to develop and improve his/her evil creatures with a new ultimate purpose: to make a living. It&#39;s no longer done for fun. But this is part of evolution and the AV industry must do more in response, since threats such as Linkoptimizer are at large, setting trends in malware development.</p><div class="bibliography"><div class="titlepage"><div><div><h3 class="title"><a class="chapter" id="id4880528"></a>Bibliography</h3></div></div></div><div class="bibliomixed"><a id="citation.1"></a><p class="bibliomixed">[1] <span class="bibliosource"><a href="https://www.symantec.com/enterprise/security_response/weblog/2006/10/gromozon_reloaded_everything_t.html" target="_blank">http://www.symantec.com/enterprise/security_response/weblog/2006/10/gromozon_reloaded_everything_t.html</a></span>.</p></div><div class="bibliomixed"><a id="citation.2"></a><p class="bibliomixed">[2] <span class="bibliosource"><a href="http://pcalsicuro.phpsoft.it/gromozon.pdf" target="_blank">http://pcalsicuro.phpsoft.it/gromozon.pdf</a></span>.</p></div><div class="bibliomixed"><a id="citation.3"></a><p class="bibliomixed">[3] <span class="bibliosource"><a href="https://invisiblethings.org/papers/redpill.html" target="_blank">http://invisiblethings.org/papers/redpill.html</a></span>.</p></div><div class="bibliomixed"><a id="citation.4"></a><p class="bibliomixed">[4] <span class="bibliosource"><a href="https://en.wikipedia.org/wiki/Spaghetti_code" target="_blank">http://en.wikipedia.org/wiki/Spaghetti_code</a></span>.</p></div><div class="bibliomixed"><a id="citation.5"></a><p class="bibliomixed">[5] <span class="bibliosource"><a href="https://en.wikipedia.org/wiki/Encrypting_File_System" target="_blank">http://en.wikipedia.org/wiki/Encrypting_File_System</a></span>.</p></div><div class="bibliomixed"><a id="citation.6"></a><p class="bibliomixed">[6] <span class="bibliosource"><a href="https://support.microsoft.com/kb/197571" target="_blank">http://support.microsoft.com/kb/197571</a></span>.</p></div></div></div> </div>
<div class="col-md-3 col-sm-3 col-lg-3">
<div id="NDPHPBlock13359" class="NDPHPBlock">
<div style="width: 100%;"><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Tweet this!' href="https://twitter.com/share?text=What next? Trojan.Linkoptimizer&url=https://www.virusbulletin.com/virusbulletin/2006/12/what-next-trojan-linkoptimizer"><img src='/uploads/images/buttons/twitter.png' alt='twitter.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on Facebook' href='https://www.facebook.com/sharer.php?u=https://www.virusbulletin.com/virusbulletin/2006/12/what-next-trojan-linkoptimizer'><img src='/uploads/images/buttons/fb.png' alt='fb.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on LinkedIn' href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.virusbulletin.com/virusbulletin/2006/12/what-next-trojan-linkoptimizer&title=What next? Trojan.Linkoptimizer"><img src='/uploads/images/buttons/linkedin.png' alt='linkedin.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='Share on Hacker News' href="https://news.ycombinator.com/submitlink?u=https://www.virusbulletin.com/virusbulletin/2006/12/what-next-trojan-linkoptimizer&t=What next? Trojan.Linkoptimizer"><img src='/uploads/images/buttons/hackernews.png' alt='hackernews.png' width='45' height='45' class='responsive' /></a></center></div><div style='float: left; width: 20%; margin-left: auto; margin-right: auto; text-align: center;'><center><a target='_blank' title='reddit this!' href="https://www.reddit.com/submit?url=https://www.virusbulletin.com/virusbulletin/2006/12/what-next-trojan-linkoptimizer"><img src='/uploads/images/buttons/reddit.png' alt='reddit.png' width='45' height='45' class='responsive' /></a></center></div></div></div><p> </p>
<h2>Latest articles:</h2>
<div class="ccm-page-list">
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2022/04/cryptojacking-fly-teamtnt-using-nvidia-drivers-mine-cryptocurrency/" target="_self">Cryptojacking on the fly: TeamTNT using NVIDIA drivers to mine cryptocurrency</a>
</h3>
<div class="ccm-page-list-description">
TeamTNT is known for attacking insecure and vulnerable Kubernetes deployments in order to infiltrate organizations&rsquo; dedicated environments and transform them into attack launchpads. In this article Aditya Sood presents a new module introduced by&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/12/collector-stealer-russian-origin-credential-and-information-extractor/" target="_self">Collector-stealer: a Russian origin credential and information extractor</a>
</h3>
<div class="ccm-page-list-description">
Collector-stealer, a piece of malware of Russian origin, is heavily used on the Internet to exfiltrate sensitive data from end-user systems and store it in its C&amp;C panels. In this article, researchers Aditya K Sood and Rohit Chaturvedi present a 360&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/06/fighting-fire-fire/" target="_self">Fighting Fire with Fire</a>
</h3>
<div class="ccm-page-list-description">
In 1989, Joe Wells encountered his first virus: Jerusalem. He disassembled the virus, and from that moment onward, was intrigued by the properties of these small pieces of self-replicating code. Joe Wells was an expert on computer viruses, was partly&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/04/run-your-malicious-vba-macros-anywhere/" target="_self">Run your malicious VBA macros anywhere!</a>
</h3>
<div class="ccm-page-list-description">
Kurt Natvig wanted to understand whether it&rsquo;s possible to recompile VBA macros to another language, which could then easily be &lsquo;run&rsquo; on any gateway, thus revealing a sample&rsquo;s true nature in a safe manner. In this article he explains how he recompiled&hellip; </div>
<h3 class="ccm-page-list-title">
<a href="/virusbulletin/2021/04/dissecting-design-and-vulnerabilities-azorultccpanels/" target="_self">Dissecting the design and vulnerabilities in AZORult&nbsp;C&amp;C&nbsp;panels</a>
</h3>
<div class="ccm-page-list-description">
Aditya K Sood looks at the command-and-control (C&amp;C) design of the AZORult malware, discussing his team's findings related to the C&amp;C design and some security issues they identified during the research. </div>
</div>
<p><br /><a class="btn btn-block btn-warning" href="/virusbulletin/archive">Bulletin Archive</a></p> </div>
</div>
</div>

<footer class="bs-footer" role="contentinfo">
<div class="container">
<div class="bs-social">
<div class="row ">
<div class="col-md-3">
<p><a title="About Us" href="/about-vb/about-us/">About us</a></p>
<p><a title="Contact Us" href="/about-vb/contact-us/">Contact us</a></p>
<p><a title="Advisory Board" href="/about-vb/advisory-board/">Advisory board</a></p>
<p><a title="Press" href="/about-vb/press/">Press information</a></p>
<p><a title="Security Events Calendar" href="/resources/calendar/">Security events calendar</a></p>
<p><a title="Newsletter" href="/newsletter/">Virus Bulletin newsletter</a></p> </div>
<div class="col-md-3">
<p><a title="VB Testing" href="/testing/">Testing</a></p>
<p><a title="VB100" href="/testing/vb1001/">VB100</a></p>
<p><a title="VBSpam" href="/testing/vbspam/">VBSpam</a></p>
<p><a title="VBWeb" href="/testing/vbweb/">VBWeb</a></p>
<p><a title="Consultancy Services" href="/testing/consultancy-services/">Consultancy services</a></p>
<p><a title="The Spammers' Compendium" href="/resources/spammerscompendium/">Spammers' Compendium</a></p> </div>
<div class="col-md-3">
<p><a title="VB2021 localhost" href="/conference/vb2021/">VB2021 localhost</a></p>
<p><a title="VB2020 localhost" href="/conference/vb2020/">VB2020 localhost</a></p>
<p><a title="VB2019" href="/conference/vb2019/">VB2019 (London)</a></p>
<p><a title="VB2018" href="/conference/vb2018">VB2018 (Montreal)</a></p>
<p><a title="VB2017" href="/conference/vb2017">VB2017 (Madrid)</a></p>
<p><a title="Conference Archive" href="/conference/vb-conference-archive/">Older conferences</a></p> </div>
<div class="col-md-3">
<div class="row">
<table style="float: right;" border="0">
<tbody>
<tr>
<td align="center"><a href="/rss" target="_blank"><img title="Get our blog updates" src="/uploads/images/buttons/rss-square-gray.png" alt="rss.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://twitter.com/virusbtn" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on Twitter" src="/uploads/images/buttons/twitter-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.linkedin.com/company/virus-bulletin" target="_blank"><img class="bhtmbxoyxwpzahwcvxnw" title="Visit us on LinkedIn" src="/uploads/images/buttons/linkedin-square-gray.png" alt="linkedin.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.facebook.com/virusbulletin" target="_blank"><img title="Visit us on Facebook" src="/uploads/images/buttons/fb-square-gray.png" alt="twitter.png" width="35" height="35" /></a></td>
<td> </td>
<td align="center"><a href="https://www.youtube.com/user/virusbtn" target="_blank"><img title="Visit us on Youtube" src="/uploads/images/buttons/youtube-square-gray.png" alt="youtube.png" width="35" height="35" /></a></td>
</tr>
</tbody>
</table>
</div> </div>
</div>
<div class="row ">
<div class="col-md-12">
</div>
</div>
</div>
</div>
</footer>

<footer class="bs-footer2" role="contentinfo">
<div class="container">
<div class="bs-social2">
<div class="row ">
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
<div class="col-md-3">
</div>
</div>
<div class="row ">
<div class="col-md-12">
<p style="text-align: left;">©1989-2022 Virus Bulletin.        <a title="Privacy Policy" href="/about-vb/privacy-policy/">Privacy policy</a>        <a title="Cookies" href="/about-vb/privacy-policy/cookies/">Cookies</a>        <a title="Terms and Conditions" href="/about-vb/terms-and-conditions/">Terms and Conditions</a></p> </div>
</div>
</div>
</div>
</footer>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-21876594-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-21876594-2', { 'anonymize_ip': true });
</script><script type="text/javascript" src="/libraries/js/fancybox.load.js"></script>
<script type="text/javascript" src="/packages/bootstrap/js/common/app.js"></script>
<div id="ccm-cookiesDisclosure" class="disclosure-bottom">
<div class="disclosure-container">
<div class="disclosure-content">
<p> We have placed cookies on your device in order to improve the functionality of this site, as outlined in our <a href="/about-vb/privacy-policy/cookies" target="_blank">cookies policy</a>. However, you may delete and block all cookies from this site and your use of the site will be unaffected. By continuing to browse this site, you are agreeing to Virus Bulletin's use of data as outlined in our <a href="/about-vb/privacy-policy/" target="_blank">privacy policy</a>.</p>
</div>
<div class="disclosure-form">
<form action="/index.php/cookies_disclosure/" method="POST">
<input type="hidden" name="allowCookies" value="1" />
<div class="button">
<input class="btn btn-info btn-sm" type="submit" name="submit" value="I understand. Don't show this message again!" />
</div>
</form>
</div>
<div class="ccm-spacer">&nbsp;</div>
</div>
</div>
</body>
</html>