{
    "xngNFBW0tu4&list=PLH15HpR5qRsWalnnt-9eYELxbEcYBPB6I&index=3": [
        "so thank you everybody for joining to this presentation we're going to show you today how we mix three different and independent research projects into one exploitation chain that will ultimately allow an attacker without authentication to root an Enterprise an SCP system so hope you enjoy it because you are here for our content and not for us we are going to do this part super brief my name is Pao artuso I'm from Argentina I've been working at an ABS for the last 10 years as security researcher and the most important thing that I would like you to know from me is that when I started this research my Java skills were null and yet today still",
        "null few",
        "number few number of me so I work onp since 20 years now and the last 10 years on onp security and the last six years I worked at onapsis in the in the as",
        "security researcher where I find yeah a",
        "bit more than 100 vulnerability in sap yet so yeah nothing crazy and for those who are not aware onapsis is a company which is focused on doing security for business curricle applications uh we have a strong focus on sap but we have also work with our vendors such as Oracle and well more more vendors so",
        "kind of introduction top I will ask you a little uh favor here can you raise your hands people who do not know about sap",
        "okay you I will do a brief inaction um ACP is one of the largest vendors when it comes to developing software and most of the software they develop is business oriented so the largest companies in the world trust in these systems for running the most critical business processes for running the financial operations for storing the critical data so sometimes when we are asked hey what what's your motivation behind doing research on these kind of systems well what what I say I think it's pretty obvious right so in order to break the ice we're going to show you the demo directly of what we are going to present today um and don't focus on the DS you're going to not understand but we are going to explain it afterwards during the presentation so what I doing now is the screen of the attacker just using a browser to connect to the ACV system of course no CRS because attacker does not have credentials on the top part of the screen what you're going to see is the terminal of this and he's launching an exploit against thisp system of",
        "course so the attack consists in three",
        "different stages first of all this attacker will do something through hdb",
        "in a stage one then afterwards in stage two we'll use we'll combine with other bu abilities that we're going to present you afterwards and at the end of the stage three this attacker will have root access as you may see in the white font as result of executing",
        "commands so that is what you can expect from this talk uh",
        "today so what just happened uh besides the talk that we are that we are doing now we also going to be publishing a white paper with more details so afterwards if you have any out and you don't want to ask us or well you can refer our white paper and see more in details finally this is the agenda for",
        "today uh as you can see in the left side we have divided in three different stages and in the main side what we have is the full exploitation chain if you see each time that you see this black cover it's because well we are going to change sections or speak about a specific research so now I would let Ivan start with the first one thank you",
        "um so we will start by the hand this time uh we'll decide to explain how what What's happen on stage three uh why we select the stage three at the beginning it's because the the vulnerability is is very easy to understand so you can use it as a warm up for for today uh to introduce what we find for for this stage three uh we need to understand to be sure that in sap your sap ecosystem can be very erogenous so you can have some some windows Linux uh working on different databases etc etc but there are one um application a little application exist on every sap system this application name is saos control and the the purpose of this application is to provide some uh Administration task you can start and stop the sap system you can uh you can prepare for um um a migration and update etc etc it's OS independent it's work on Linux and windows and it's basically mandatory to have this kind of of application uh if we if we take a look inside one system and weo this only these two command and for the sub control we understand several important things the first thing is there are uh few binary involved in this support control application and two of these binary is a services and one as roots so this is why it's always a good thing to take a look at these kind of services and also there are one uh HTTP Port open and it's listening on local L and also uh on on external and it listen on 1128 and 11289 for",
        "htps usually what sap administrator do",
        "to use the sap control they connect to the system and they can use the binary name saos control thank you",
        "OB and from the sa control you can call a lot of function when I say a lot I would say like 40 like 50 function one of this function is the name is configuration outside Discovery to be very honest at the beginning we don't know exactly what is the purpose of this function but we get interesting because we can provide uh some parameter and one of these parameter is a name you can provide us etc etc so this is how it work normally you provide few parameter and you you have the result the output like as this configuration is created all right so we continue and of course we try to inject magicious think in this parameter you try to break something but nothing works all right how we achieve",
        "to find something interesting U um we decide to sniff the port 1128 using tcpm",
        "for example and what we realize it's",
        "when we play with sub control binary behind the binary craft an HTTP request to the Port 112 a uh on Local Host and if you look closely there are no authentification for this request and also there are uh few additional parameter in this uh in this request so this is the request for the function configure outside Discovery and in one of them we we find a an no u a noise",
        "common execution so what's happened this is a little PC I'm connecting as heo on the sub host I try to figure out if the file SL on exist is not exist I will execute the export on local on 112 AO I precise I'm on Unix system it's just for the payload uh encoding and I issue one",
        "request and after uh this request as you can see the the file now exist and the owner is root so this is a blind OS injection as",
        "w",
        "like I said it's the first little vulnerability as a warmup everything is patched uh so this is the what I show what we show the first uh the first one the second one we explain everything in the in the white paper it's more complicated but uh this is not for today",
        "so now we understand how we can execute Roots but uh we have some condition and of course we need to have at least user access on the system or we can we need to be able to execute HTP request on Local Host so we move to the stage two and this is for pao so let's move on with the following research and this is related to a properity protocol from ACP that is called P4 P4 is based on RMI and Corva and the aim of this protocol is to facilitate the communication between remote objects between SCP instances and",
        "while usually by default the P4 Port is finded to every interface of the system we usually do not see untrust the P4 Port exposed to untrusted networks P4 is implemented in this layer that is called the javet Weaver layer which is a foundational layer that afterwards some solutions and a lot of solutions of SCP for example sub solution manager or the enterprise portal and build on top of this layer which means that all of those Solutions are going to implement before when we started this research we didn't know anything about before we jump into the documentation and we see this snippet of code that ACP say okay if you want to connect to4 you have to use something like this if you pay a little bit of attention is doing a GDI connection but what's",
        "GDI GDI stands for J Java naming directory interface and in a nutshell GDI is a naming service that will bind strings to",
        "objects so if you see for example the the Yellow Boxes these are resolvers and you're going to see the there that is RMI is one of them cor is another one basically what you can do is by using P4 a geni you can look up those",
        "strings in a remote way and you're going to I mean the service will return you the object reference to that uh string and at the end of the day what you are going to be able is to use those objects in a remote way as if you were in the server",
        "itself okay this is super interesting but we wanted to know okay what we can do with these options so the first step was let's try to list all these options list all these strings in order to be able to see what we can we can do uh we went again to the documentation we found that it was possible to list these strings through the usage of a tet interface yes a tet interface anyways is",
        "only exposed locally that will give you a list of 4,000 Services um then afterwards by using",
        "this script that is based on the documentation we realized that not all of those Services were exposed in a remote way at the end of the day we end up with a list of 50 60 services that we were able to to to use of course after doing all that job we found a super interesting blog post written by KO Rich uh a couple of years ago he was working in a similar project and uh he published a script that was doing all this stuff in a really straightforward way so Clos to him because we end up using that contribution as well",
        "so let's start with the the most important part from my point here that is the analysis cycle so once we were able to lease all these Services we started the analysis so we would pick up one of those Services of that 60 Services we would go and try to understand which were the methods that this object were um being",
        "implemented by expecting the interface that we're implementing the well the actual implement of the object and then afterwards we started with the static and dynamic analysis so likely sap allows you to turn on a thebug port where you can connect remotely and start putting break points and reading the the status of the variable so it was really really useful then afterwards we'll go back and continue with the following service of that list we run this cycle multiple times like I don't know maybe multiple times even for the same service the reason is because this research law lasted more or less nine months like a pregnancy period and we would go back to",
        "maybe a service that we already analyzed multiple times right we were learning Java in the journey so it's something something uh common to do and from our",
        "perspective the key thing here was to have a strong and robust source of of of documentation if we wouldn't have this we wouldn't be able to go back to read what we have done and also to sync because this was a perir",
        "job finally we were able to find some uh vulnerabilities raning from CSS 5 to 10 some remote C executions hql injections so it was uh really a variety of them and in fact this one that is maybe important in the ACP context the ability to be able to download OS files uh was really useful and is the one we show you in the demo because there is a specific file in the OS of face system that holds some passwords that can be decrypted we are not going to go into details now there is some dets in the white paper if you want to to check that and now I will let Ian explain the first one of the list yeah thank you um yeah so to explain this one uh I need to introduce one particular one specific SCP system the name is subsolution manager again uh to be very very simple what is a Subs manager this is a sap system this is a full sap system but it's what we call a technical sap system because there are no business data inside this system and this is a system normally used only by sap administrator to perform some Administration task on whole other system if you are interesting about sub manager take a look on how talk in 2020 we already uh analyze the sub manager and at the end of this talk uh we are able if we compromise the subsolution manager we compromise Al all the system connected to the subsolution manager and spoiler we did we did it again um to communicate with all other system the subsolution manager use what we call SMD agent for subal manager diagnostic agent and as uh you may",
        "understand the subal manager is a sub net W with the stack Java and the subu manager have a P4 services so in the list of whole gmdi Services we we have we have few of them several of them uh exist only on the sub manager and good news the communication with the SMD agent also use the P4 so this is why we jump into this area we try to figure out what we can do with these kind of services we dig a lot we are like 15 Services if I remember stuff like that uh to study so we Loop study uh analyze documentation Etc and we find one Services very interesting because these Services enable the the you can request",
        "the subsolution manager to ask to whole SMD agent to do something it's like hey do this simulation for me and all the agent do it so it look like that so the",
        "the one very interesting thing we we find inside this uh this uh particular Services it's as a parameter you need to provide the classes a Java classes it's",
        "not very usual so we try to understand what's going on and after that he he he start the function run simulation using this parameter the classes we provide we try to figure out what kind of classes we need to provide in this paramod and after yeah after a moment we discover we understand that these classes it's what's sap named The Collector classes and this classes is present in the edges they are not present in the sub manager uh core but they are in the SMD agent itself so when you when you provide the parameter you need to provide the name of the the the Z Sava the full name of the Java classes if I'm bring back the illistration is something like that you can communicate with the P4 on sub manager and call this SMD agent to execute these classes so it's mean what if if you find a vulnerability inside these classes the vulnerability is executed on the SMD agent the SMD agents",
        "run inside the uh sap system without any P4 without any anything it could be whole sap system not only the sub manager or the port or anything so which we start to look for for varability inside these classes and of course we are here so we find few one so in this one we find a remote command execution uh but it's only working on windows so if the SMD agent need to be on Windows on lineu and Unix is doesn't work and also we find this one this is a SS for S side request for G so remotely",
        "by attacking the sub solution manager we can perform a a local HTP request on all",
        "SMD agent on all host and so this is a yeah and and also we find the either injection so we can craft any kind of HTTP request locally on whole sap system using this ssrf",
        "so what is possible to do is to combine the first uh vulnerability we find in stage one and this one so on the top this is the listener lunch by the attacker and on the bottom this is the script the attacker attack the sub manager through P4 and try to exit the the reverse shell so it attack the",
        "P4 the P4 communicate with the SMD agent it triy to uh um trigger the vulnerability of the ssrf and inside the ssrf we put the payload of the first vulnerability on stage one and as you can see we get root remotely on the on on the on the system connected to the subs",
        "manager so back to the NADA uh now you can understand what's going on on stage two and but there are one thing one important condition to trigger H these vulnerabilities is to have access to the P4",
        "Services thank",
        "you so let's uh move on with the following research that is the last one so before starting about talking about the details we would like to introduce you to ja ja is a tool that we build that is called javao analyzer it's a simple tool that connects to your SCP system of course giving credentials is not an offensive uh tool which will um download some specific files and we'll analyze them and based on that we'll create the list of HTTP entry points that the system has it's a way to also measure the exposure of your ACP system uh yeah we're going to make pish this uh maybe later today or or tomorrow uh by using J we launch it against one of the solutions maybe the most famous ones of FP that is called the enterprise portal the particularity of this solution is that it's widely exposed to the internet and we found uh a seet called navigation seet that was exposed without authentication so we jump into the analysis as many seets it starts all from a dog get or yeah a Handler for get requests and as you can see there in the in the screen uh highlighted at least three different parameters are extracted from the request of the user and then afterwards I will not worry with the full call Flow but you have to believe me that there is a path that from the two get you can achieve a function that is called rir so let's zoom in in that right function that function is taking as an argument a URL in the first two line is split in that URL into two parts a prefix and the rest of the URL and afterwards is using a map that is in memory that this map has prefixes as keys and objects as values so it will do a simple look up in that map based on the prefix we'll get that object and afterwards we'll execute the r function of that specific object so with further analysis we understand that there was these object were called connectors uh and there were some of them like eight or nine available in the SCP system so we just gra the first one the PCD one and we went to the r function of that object what we found was that uh if you get if you pay carefully attention to that snippit of java they were they are executing a GDI",
        "lookup and the lookup is using a URL that comes as an argument and this is the moment that everything assembled remember those parameters that went extracted from the user request when one of them is directly used in this J lookup so what we have at the end of the day here is a j j lookup injection with use Control Data so we knew this was a vulnerability because of L for shade and other vulnerabilities that had more or less the same uh family vulnerabilities but we didn't know how to exploit it so we began a journey on trying to see the documentation online and understand what was going on there we came across this amazing talk in 2016 black hat from Al Munos and Alexander where they show up lot of ways to to affect GDI lookups and after reading its white paper for 200 times and don't uh understand it everything uh there was something that was very important for our research uh they highlight the fact that it was possible to use GDI references to exploit this a GDI reference is just an object that you can serve in an N my server for example and when you perform a g lookup against the server and you fetch that that Chia reference when the system triy to Restort that reference you can point to a class for example and that class could be remotely or Well for now it could be remotely located so you can build your own class in somewhere and download the code we try this we as an attackers we be make an attacker we create our own start RMI server we perform the get",
        "request against sorry against the thislet using the PCD prefix and this will force the request the GDI look up to to our server and we provide the this GDI reference for into a remote",
        "class when the server tried to resolve this it didn't work of course uh it was already patch this is from 2016 it was good but today is a little bit old but following the same line then we found a blog post from Michael stankin from veraco saying hey you can also play with local classes so instead of going to loow the class remotely you can build your own class based on the class path that you have in the system so we almost copy and paste the the the exploit of Christian that didn't work but the issue the error if you pay attention is really actually good because he say hey this class doesn't exist but if you pay attention to the class it says Apache because he was working with an Apache uh CL um system and we were dealing with SCP system so in this moment we have like a little Epiphany saying okay what we have to do is something more specific to CP we have to adapt the attack and try to find a specific the gadget",
        "forp so we got a huge Journey again trying to understand what were the conditions that this class should met of course the first one is this class should exist near ACP class path that's basic but stop me stop me if I'm wrong but there are a lot of classes provided by SCP so find this kind of specific Gadget it's easy correct but we have to",
        "understand what were actually the conditions so in in order to do so we have to Deep dive into the chdi internals of SCP how they were implemented and there is a very wellknown uh function that is called get object instance that is the one actually resolving the reference so when the lookup is executed it will analyze the reference and do something with it so we start analyzing this function and in the middle it has two these two lines that were very important to to highlight the first one is out of the reference that remember is contr by the attacker or by the user it extract a string and afterwards that string is being used in a second function that is called find object Factory and the result of that factory fin Factory is assigned it to a variable called f from Factory so let's zoom in for a sec in that final Che factoring it receives the argument H the string that is extracted from the reference and afterwards at the end it is the following two lines that are super important in the first one based on this string that is again attack controll it it creates a class an object of a class and in the second one it create a new instance of that class and cast it to the object Factory uh",
        "class so these two lines were important to understand that we have two different conditions here first of all the class that we want to provide should be a factory and the second thing is it should be castable to object Factory okay okay you you now L the possibility but I'm still thinking it's possible to find this kind of gget okay let's continue so we have one more condition that at the end of the function of this G ofc function remember that this uh Factory was assigned to the fact F variable so then afterwards it is it is using get the get object instance for that factory so it means that the class should also implement the get of function",
        "and of and of course this class should do something interesting because if the class should me the first three condition and afterwards is returns a n uh is not useful all right you got me I think it's not possible to find this kind of class it's a too much condition well after hours days nights um looking for for",
        "that class um we got one so each TB",
        "object Factory it was a very good candidate it implements the get object instance uh after some functions it",
        "calls a function that is called resolve reference and believe me that at some point it executes the following piece of snippet code it extracts from the",
        "reference remember the this sh reference that is controll by the attacker it extracts something that is called app name and two lines afterwards if that app name is not null it starts the app you don't you don't have to be an expert to understand that we are dealing with an application server so basically it's turning on an application that we can select which application it",
        "is so we try this we put in our JDR reference to uh a link to this EG object Factory pointing to a local class sorry pointing to giving the the name of the application name that we want to start it when the system resolve that reference it start the appli and afterwards the execution failed but we",
        "don't care the application is already started um I have remarks about this kind of exploitation for for example the step three you need to have the entreprise PTI communicate with external attacker server and maybe you know in real life is not going to work this is very unlucky to have this kind of uh uh of possibility that's true because we are going here we're trying to Mimi an attacker going through the internet so it's true however uh we found a way to see combet that uh measure basically we found a specific resolver of GDI implemented in CP that was given the ability to create this chier reference like dynamically so it's just about one request one get request with specific uh of course variables and if that will create the CH reference itself there in the same request to be able to turn on the application and remember that all of this is built without never providing any kind of",
        "authentication well yes this is a right patch if receive a CSS expon five and this was P I think three or four months ago okay great we spend 10 minutes to explain us how you will find the way to start an application but what is the relation with P4 great cor so it all",
        "relies in one application that is Shi stopped by default in sap that would allow you to tunel before through https so yes it's sto by default but now that we know how to turn them on we can turn on first this application and then afterwards start sending traffic P4 traffic through https and abusing all the vulnerabilities that we show you in stage one and of course chain that also with the St uh one so finally having through the internet or through HTTP access the ability to uh execute",
        "command so now you we think we you get",
        "uh overall view of what we find so this is this is a chain of vulnerability from from one vulnerability to to to another one so you can use a lot of different scenario a lot of different ways so so you can use this way for example to execute command as Windows if the uh the the target environment it's on Windows you can use the ssrf if you have access to the sub manager etc etc there are lot of of different way to attack to to use this this kind of attack so this is the way we use for example in the opening demo",
        "um we we will try to uh to put all uh",
        "the VAR we find in this table there are a lot of vulnerability involved in this research uh but we also would like to uh highlight two um two important security",
        "notes this this two last one uh is not a patch but sap provide um an FAQ uh not",
        "to explain what's going on on the on this on this varability so the congratulation to ACP they provide a lot of information and very dedicated to customer uh question like if they need to stop the system to apply the P if there are some worker on exist etc etc so take a look of these two uh two last notes it's very very important to um sorry no Miracle you need to",
        "patch uh there are not a lot of work on you can disable access to people you can monitor access to um to to monitor the A M Traffic you can do a lot of things but they are not magical uh not magical thing uh we do not go deeper today in the in the in the defensive size but take a look on the white paper we explain more deeper what you can do uh as",
        "defenser um as a conclusion we would like to provide uh for what we take away",
        "uh the first one is about CVSs if youve notice on the table previously the the CVSs score come from five uh score five to uh to 10 and also",
        "uh to be able to uh start any kind of application remotely the CVSs is",
        "6.5 it's not high it's medium but you",
        "understand it's open the gate to people and then you can reach other vulnerability so again CVSs is important",
        "but also it's very important to have a global view of what possibility what we can do by Chain several s vity and it's",
        "not easy uh another conclusion is that uh based on our experience uh you don't need to be an expert to jump into a doing research is a specific field uh again when we started this one this we didn't know too much about Java and yet we were able to have some good results so yes our recommendation is if you are struggling to say hey should I start this research should I go through it you will learn in a journey and it will be hopefully funny at least yeah and also don't be afraid to jump in new area uh for example for her people was like blackb services without a lot of information but we try we make a short like hey let's try and at the beginning it was hard to understand how is how is it going but the the when you are inside and you start understand how is it going this is where the magic happen and you can understand hey I can do that I understand that etc etc so as a offensive security researcher don't be afraid to to to try new things and",
        "finally uh something that is also based on our experience and just nothing new is do not try to pursue the Silver Bullet that vulnerability that is uh a unique vulnerability that will allow you without authentication to get roote access with everything because sometimes uh from a let's say psychological point of you could be frustrating for the researcher um from my point of view it's easy to go for lead vulnerabilities and try to have some winnings in the middle and try to then afterwards combine them into a at the end of the day hopefully have the same impact as uh one only",
        "vity and also we like to thank you a lot of people because we are not only together only two of us we like to thank you onapsis Onis security research and the grw and and everything because uh if you know sap working on sub manager and entprise stuff like that is not easy so you need to have a very good uh a very good team with you so thank you also uh specifically to Paul GP now otheris uh I",
        "also would like to thank you to ASP we know they work hard to deliver all the patches involved in this talk so Kudo to to sap for that uh thank you to black hat also as well uh for the coach and [Applause]",
        "S"
    ]
}